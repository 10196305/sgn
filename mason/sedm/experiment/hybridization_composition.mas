<%doc>
  NAME: hybridization_composition.mas
  VERSION: 1.0
  DESCRIPTION: Hybridzation composition get the data of the hybridizations associated to a experiment and return the data 
               as mason object in HTML format; 
  AUTHOR: Aureliano Bombarely (ab782@cornell.edu)
</%doc>


<%perl>
use strict;
use warnings;

use CXGN::SEDM::Schema;
use CXGN::Page::FormattingHelpers  qw/ info_section_html info_table_html columnar_table_html page_title_html html_break_string /;


my $exp_comp_content;

## If there aren't any experiment that comes from experimental design it will do nothing. 
## The error message will returned by basic information

my @exp_list;
my $experiment_composition_html;
if (defined $ARGS{'experiment'}) {

   ## Get the schema
   my $schema = $ARGS{'experiment'}->result_source()->schema();

   ## Get the group_linkage
   my %group_nr;
   my $experiment_id = $ARGS{'experiment'}->get_column('experiment_id');
   my @target_ids = $schema->resultset('Targets')->search({ experiment_id => $experiment_id })->get_column('target_id')->all();
   foreach my $target_id (@target_ids) {
      my $rs_group = $schema->resultset('GroupLinkage')->search ({member_id => $target_id, member_type => 'target'});
      my @group_ids = $rs_group->get_column('group_id')->all();
      foreach my $group_id (@group_ids) {
         unless (defined $group_nr{$group_id}) {
	      $group_nr{$group_id} = 1;
         }
      }
   }
   my @group_nr_list = sort {$a <=> $b} keys %group_nr;

   ## Get the hybridization lines
   foreach my $group_nr_id (@group_nr_list) {      
       my @hyb_rows = $schema->resultset('Hybridizations')->search({ target_group_id => $group_nr_id });
       foreach my $hyb_row (@hyb_rows) {
          my $t = 1;
          my $hyb_id = $hyb_row->get_column('hybridization_id');
          my $platform_id = $hyb_row->get_column('platform_id');
	  my $protocol_id = $hyb_row->get_column('protocol_id');
	  my $target_group_id = $hyb_row->get_column('target_group_id');
   	  my ($platform_name) = $schema->resultset('Platforms')->search({platform_id => $platform_id})->get_column('platform_name')->all;
	  my $platform_link = '/sedm/platform.pl?id='.$platform_id;
	  my $platform_html = "<a href=$platform_link>$platform_name</a>";
	  my @target_list;
	  my @member_ids = $schema->resultset('GroupLinkage')->search({ group_id => $target_group_id,
								        member_type => 'target'      })->get_column('member_id')->all();
	  foreach my $member_id (@member_ids) {
	      my ($target_row) = $schema->resultset('Targets')->search({ target_id => $member_id });
	      if (defined $target_row) {
		  my $target_name = $target_row->get_column('target_name');
		  my $target_dye = $target_row->get_column('dye');
		  my $target_link = '/sedm/target.pl?id='.$member_id;
		  my $target_html = "<a href=$target_link>$target_name</a>";
		  if ($t == 1) {
		      push @exp_list, [$hyb_id, $platform_html, $target_html, $target_dye];
		      $t++;
		  } else {
		      push @exp_list, [undef, undef, $target_html, $target_dye];
		  }
	      }
          }
       }
   }

   ## Use columnar table to give the html format. If don't exists any data, print message.

   $experiment_composition_html = columnar_table_html( headings => [ 'Hybridization id', 'Platform name', 'Target list', 'Dye' ],
                                                       data     => \@exp_list,
				  		       __alt_freq => 2,
                                                       __align  => ['c', 'l', 'l', 'l'],
                                                        );
} else {
    $experiment_composition_html = 'None probe was found associated to this experimental design';
}
my $exp_n = scalar(@exp_list);
$exp_comp_content = info_section_html( title        => "Hybridizations of this Experiment (".$exp_n.")", 
                                       contents     => $experiment_composition_html,
				       collapsible  => 1,
                                       collapsed    => 1, );
 



</%perl>

<% $exp_comp_content %>


