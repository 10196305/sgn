
<%args>
$trial_name
$breeding_program_id
$location_id
$year
$planting_date
$harvest_date
$trial_description
</%args>

<div class="modal fade" id="crossingtrial_details_edit_dialog" tabindex="-1" role="dialog" aria-labelledby="crossingtrialDetailsEditDialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content ui-front">
            <div class="modal-header text-center">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="crossingtrialDetailsEditDialog">Edit Crossing Experiment Details</h4>
            </div>
            <div class="modal-body" id="trial_details_edit_body">
                <div class="container-fluid">
                    <form class="form-horizontal" role="form" method="post" enctype="multipart/form-data" encoding="multipart/form-data">
                        <div class="form-group">
                            <label class="col-sm-3 control-label" for="edit_trial_name">Crossing Experiment Name: </label>
                                <div class="col-sm-8">
                                    <div class="input-group">
                                        <input class="form-control col-sm-8" id="edit_trial_name" title="name" type="text" value="<%$trial_name%>" aria-describedby="edit_trial_name_status"/>
                                    </div>
                                </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label" for="edit_trial_breeding_program">Breeding Program: </label>
                                <div class="col-sm-8">
                                    <div class="input-group">
                                        <select class="form-control" id="edit_trial_breeding_program" title="breeding_program" value="<%$breeding_program_id%>"></select>
                                    </div>
                                </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label" for="edit_trial_location">Location: </label>
                                <div class="col-sm-8">
                                    <div class="input-group">
                                        <select class="form-control" id="edit_trial_location" title="location" value="<%$location_id%>"></select>
                                    </div>
                                </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label" for="edit_trial_year">Year: </label>
                                <div class="col-sm-8">
                                    <div class="input-group">
                                        <select class="form-control" id="edit_trial_year" title="year" value="<%$year%>"></select>
                                    </div>
                                </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label" for="edit_trial_planting_date">Planting Date: </label>
                                <div class="col-sm-8">
                                    <div class="input-group">
                                        <span class="input-group-btn"><button class="btn btn-default" id="clear_planting_date" type="button">Clear</button></span>
                                        <input class="form-control" id="edit_trial_planting_date" title="planting_date" type="text" value="<%$planting_date%>"/>
                                    </div>
                                </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label" for="edit_trial_harvest_date">Harvest Date: </label>
                                <div class="col-sm-8">
                                    <div class="input-group">
                                        <span class="input-group-btn"><button class="btn btn-default" id="clear_harvest_date" type="button">Clear</button></span>
                                        <input class="form-control" id="edit_trial_harvest_date" title="harvest_date" type="text" value="<%$harvest_date%>"/>
                                    </div>
                                </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label" for="edit_trial_description">Description: </label>
                                <div class="col-sm-8">
                                    <div class="input-group">
                                        <textarea class="form-control" id="edit_trial_description" title="description" rows="5" maxlength="250"><% $trial_description %></textarea>
                                    </div>
                                </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <p class="text-success vertical-align pull-left"><span class="glyphicon glyphicon-pencil"></span> Indicates pending change</p>
                <button type="button" class="btn btn-default" data-dismiss="modal" id="edit_trial_details_cancel_button">Cancel</button>
                <button type="button" class="btn btn-primary" id="save_trial_details">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="trial_details_saved_dialog" tabindex="-1" role="dialog" aria-labelledby="trialDetailsSavedDialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content ui-front">
            <div class="modal-header text-center">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="trialDetailsSavedDialog">Details Saved</h4>
            </div>
            <div class="modal-body" id="trial_details_saved_body">
                <ul class="list-group" id="trial_details_saved_message"></ul>
            </div>
            <div class="modal-footer">
                <button id="trial_details_saved_close_button" type="button" class="btn btn-default" data-dismiss="modal">Close & Reload</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="trial_details_error_dialog" tabindex="-1" role="dialog" aria-labelledby="trialDetailsErrorDialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content ui-front">
            <div class="modal-header text-center">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="trialDetailsErrorDialog">Error Saving Crossing Experiment Details</h4>
            </div>
            <div class="modal-body" id="trial_details_error_body">
                <ul class="list-group" id="trial_details_error_message"></ul>
            </div>
            <div class="modal-footer">
                <button id="trial_details_error_close_button" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>

jQuery(document).ready(function(){

    jQuery('#edit_crossingtrial_details').click(function(){

        jQuery('#crossingtrial_details_edit_dialog').modal("show");

        //populate breeding_programs, locations, years, and types dropdowns, and save default
        var default_bp = document.getElementById("edit_trial_breeding_program").getAttribute("value");
        get_select_box('breeding_programs', 'edit_trial_breeding_program', {'default' : default_bp});
        jQuery('#edit_trial_breeding_program').data("originalValue", default_bp);

        var default_loc = document.getElementById("edit_trial_location").getAttribute("value");
        get_select_box('locations', 'edit_trial_location', {'default' : default_loc});
        jQuery('#edit_trial_location').data("originalValue", default_loc);

        var default_year = document.getElementById("edit_trial_year").getAttribute("value");
        get_select_box('years', 'edit_trial_year', {'default' : default_year, 'auto_generate': 1});
        jQuery('#edit_trial_year').data("originalValue", default_year);


        //create bootstrap daterangepickers for planting and harvest dates
        var planting_date_element = jQuery("#edit_trial_planting_date");
        set_daterangepicker_default (planting_date_element);
        jQuery('input[title="planting_date"]').daterangepicker(
            {
                "singleDatePicker": true,
                "showDropdowns": true,
                "autoUpdateInput": false,
            },

            function(start){
                planting_date_element.val(start.format('MM/DD/YYYY'));
                highlight_changed_details(planting_date_element);
            }
        );

        var harvest_date_element = jQuery("#edit_trial_harvest_date");
        set_daterangepicker_default (harvest_date_element);
        harvest_date_element.daterangepicker(
            {
                "singleDatePicker": true,
                "showDropdowns": true,
                "autoUpdateInput": false,
            },
            function(start) {
                harvest_date_element.val(start.format('MM/DD/YYYY'));
                highlight_changed_details(harvest_date_element);
            }
        );

        // set up inout handlers
        jQuery('#clear_planting_date').click(function(){
            planting_date_element.val('');
            highlight_changed_details(planting_date_element);
        });

        jQuery('#clear_harvest_date').click(function(){
            harvest_date_element.val('');
            highlight_changed_details(harvest_date_element);
        });

        jQuery('[id^="edit_trial_"]').change(function(){
            var this_element = jQuery(this);
            highlight_changed_details(this_element);
        });

        //save dialog body html for resetting on close
        var edit_trial_details_body_html = document.getElementById('trial_details_edit_body').innerHTML;

        jQuery('#edit_trial_details_cancel_button').click(function(){
            reset_dialog_body('trial_details_edit_body', edit_trial_details_body_html);
        });

        jQuery('#save_trial_details').click(function(){
            var changed_elements = document.getElementsByName("changed");
            var categories = [];
            var new_details = {};
            var success_message = '';
            for(var i=0; i<changed_elements.length; i++){
                var id = changed_elements[i].id;
                var type = changed_elements[i].title;
                var new_value = changed_elements[i].value;
                if (type.match(/date/)){
                    if (new_value){
                        new_value = moment(new_value).format('YYYY/MM/DD HH:mm:ss') || 'remove' ;
                    } else {
                        new_value = 'remove';
                    }
                }
                categories.push(type);
                new_details[type] = new_value;
                if(jQuery('#'+id).is("select")){
                    new_value = changed_elements[i].options[changed_elements[i].selectedIndex].text
                }
                success_message += "<li class='list-group-item list-group-item-success'> Changed "+type+" to: <b>"+new_value+"</b></li>";
            }

            jQuery('#trial_details_edit_dialog').modal("hide");
            save_trial_details(categories, new_details, success_message);

        });

    });

    jQuery('#trial_details_error_close_button').click(function(){
        document.getElementById('trial_details_error_message').innerHTML = "";
    });

    jQuery('#trial_details_saved_close_button').click(function(){
        location.reload();
    });

});


</script>
