<%args>
</%args>

<& /util/import_javascript.mas, classes => [ 'jquery.iframe-post-form', 'CXGN.BreederSearch', 'CXGN.Trial', 'moment_min', 'daterangepicker' ] &>

<div class="modal fade" id="upload_drone_imagery_dialog" name="upload_drone_imagery_dialog" tabindex="-1" role="dialog" aria-labelledby="uploadDroneImageryDialog">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="uploadDroneImageryDialog">Upload Aerial Imagery</h4>
      </div>
      <div class="modal-body">
        <div class="container-fluid">

            <form class="form-horizontal" role="form" method="post" enctype="multipart/form-data" encoding="multipart/form-data" id="upload_drone_imagery_form" name="upload_drone_imagery_form">

                <&| /util/workflow.mas, id=> "drone_imagery_upload_workflow" &>
                    <&| /util/workflow.mas:step, title=> "Intro" &>
                        <& /page/page_title.mas, title=>"This workflow will guide you through uploading aerial images to the database" &>
                        <ul>
                            <li>Your field trial must already be in the database before you can upload images for it. Please go to <a href="/breeders/trials">Manage->Field Trials</a> if it is not.</li>
                            <li><b>For Raw Image Captures</b>: If you have raw aerial images (.TIFF, .JPG, .PNG) that have not been stitched into an orthophotomosaic image of the whole field, your raw images should be uploaded using a zipfile (.zip). The maximum zipfile size is 2GB; however, you can upload many separate zipfiles. OpenDroneMap will be used to stitch the orthophotos and digital surface maps (DSM). OpenDroneMap works for color RGB images and for MicaSense 5-channel multispectral images.</li>
                            <li><b>For Orthophotomosaics</b>: If you already have an orthophotomosaic image of your entire field from external software, you can upload those images. The maximum size for each image is 200MB. Upload orthomosaics as .TIFF, .PNG, or .JPG images. Do not upload GeoTIFFs, instead upload reflectance raster images (.TIFF, .PNG, or .JPG). Orthophotomosaic images for multi-spectral cameras are expected to be perfectly super-imposable for all spectra.</li>
                        </ul>
                        <hr>
                        <p><b>Example Data:</b> <a href="https://imagebreed.org/static_content/imagebreed/AlfalfaExample35MeterMicasenseAerialDroneFlightRawCaptures.zip" download>MicaSense 5 Band Raw Captures (Unstitched TIFF image-captures) (Upload zipfile to ImageBreed and let OpenDroneMap stitch orthophotos and DSM.)</a></p>
                        <p><b>Example Data:</b> <a href="https://imagebreed.org/static_content/imagebreed/ExampleAerialDroneFlightMicasensePanel.zip" download>MicaSense 5 Band Panel Images (MicaSense calibration panel images.) (Upload zipfile for ImageBreed to calibrate Micasense raw-captures.)</a></p>
                        <p><b>Example Data:</b> <a href="https://imagebreed.org/static_content/imagebreed/AlfalfaExample35MeterMicasenseAerialDroneFlightOrthomosaics.zip" download>MicaSense 5 Band Previously Stitched Orthophotomosaic Images (PNG Files in provided zipfile. Can upload each band separately into ImageBreed.)</a></p>
                        <p><b>Example Data:</b> <a href="https://imagebreed.org/static_content/imagebreed/ExampleColorAerialDroneFlightRawCaptures.zip" download>Color Camera Raw Captures (Unstitched JPG image-captures) (Upload zipfile to ImageBreed and let OpenDroneMap stitch orthophotos and DSM.)</a></p>
                        <br/>
                        <center>
                        <button class="btn btn-primary" onclick="Workflow.complete(this); return false;">Go to upload a single imaging event</button>
                        <br/><br/>
                        <button class="btn btn-default" id="upload_drone_imagery_bulk_button" >Go to bulk upload of imaging events</button>
                        <br/><br/>
                        <!--button class="btn btn-default" id="upload_drone_imagery_bulk_previous_button" >Go to bulk upload of previously processed imaging events</button-->
                        </center>
                    </&>
                    <&| /util/workflow.mas:step, title=> "Field Trial" &>
                        <& /page/page_title.mas, title=>"Select your field trial" &>

                        <div class="form-group">
                            <label class="col-sm-3 control-label">Field Trial: </label>
                            <div class="col-sm-9" >
                                <div id="upload_drone_image_trial_select_div"></div>
                            </div>
                        </div>

                        <div id="upload_drone_image_field_trial_info">
                        </div>

                        <center>
                        <button class="btn btn-primary" id="upload_drone_image_field_trial_select_continue">Go to Next Step</button>
                        </center>
                    </&>
                    <&| /util/workflow.mas:step, title=> "Drone Run" &>
                        <& /page/page_title.mas, title=>"Create a new drone run" &>

                        <table class="table table-bordered table-hover" id="drone_image_upload_drone_runs_table">
                            <thead>
                                <tr>
                                    <th>Select</th>
                                    <th>Imaging Event Name</th>
                                    <th>Imaging Event Type</th>
                                    <th>Imaging Event Description</th>
                                    <th>Imaging Event Date</th>
                                    <th>Drone Run GDD</th>
                                    <th>Sensor</th>
                                    <th>Field Trial Name</th>
                                    <th>Field Trial Description</th>
                                </tr>
                            </thead>
                        </table>

                        <!-- If drone run is selected above, the drone_run_project_id is passed to controller, negating need to create new drone run -->
                        <input id="drone_run_id" name="drone_run_id" type="hidden" value=""/>
                        <input id="drone_image_upload_drone_run_band_stitching_odm_image_count" name="drone_image_upload_drone_run_band_stitching_odm_image_count" type="hidden" value=""/>

                        <br/>
                        <div id="drone_image_upload_create_drone_inputs">
                            <div class="form-group">
                                <label class="col-sm-3 control-label">Imaging Event Name (Must be unique): </label>
                                <div class="col-sm-9" >
                                    <input class="form-control" id="drone_run_name" name="drone_run_name" type="text" placeholder="e.g. Field Trial Name + Date of Flight" />
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">Imaging Event Type:</label>
                                <div class="col-sm-9" >
                                    <select class="form-control" id="drone_run_type" name="drone_run_type">
                                        <option value="">Select One</option>
                                        <option value="Aerial Medium to High Res">Medium to High Resolution Aerial Drone Image(s)</option>
                                        <option value="Aerial Low Res">Low Resolution Aerial Drone Image(s)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">Sensor Type:</label>
                                <div class="col-sm-9" >
                                    <select class="form-control" id="drone_image_upload_camera_info" name="drone_image_upload_camera_info">
                                        <option value="">Select One</option>
                                        <option value="micasense_5">Micasense 5 Bands</option>
                                        <option value="ccd_color">CCD Sensor Color Image</option>
                                        <option value="cmos_color">CMOS Sensor Color Image</option>
                                        <option value="interpolated_elevation">Interpolated Elevation Image</option>
                                        <option value="em38_interpolated_ch1.0m">EM38 Interpolated CH1.0m Image</option>
                                        <option value="em38_interpolated_ch0.5m">EM38 Interpolated CH0.5m Image</option>
                                        <option value="em38_interpolated_ih1.0m">EM38 Interpolated IH1.0m Image</option>
                                        <option value="em38_interpolated_ih0.5m">EM38 Interpolated IH0.5m Image</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">Imaging Vehicle: <button class="btn btn-sm btn-default" name="drone_run_imaging_vehicle_add_new" type="button">Add New Vehicle</button></label>
                                <div class="col-sm-9" >
                                    <div id="drone_run_imaging_vehicle_div"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">Imaging Vehicle Battery Set:</label>
                                <div class="col-sm-9" >
                                    <div id="drone_run_imaging_vehicle_battery_div"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">Imaging Event Description (e.g. flight altitude, flight plan name, overall weather conditions): </label>
                                <div class="col-sm-9" >
                                    <input class="form-control" id="drone_run_description" name="drone_run_description" type="text" />
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">Imaging Event Date and Hour (Must be after the planting date):</label>
                                <div class="col-sm-9" >
                                    <input class="form-control" id="drone_run_date" name="drone_run_date" title="drone_run_date" type="text" />
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">Fixed Camera Rig Name (For Fixed Camera Rigs e.g. Greenhouse or Growth Chambers) (Leave empty if not applicable):</label>
                                <div class="col-sm-9" >
                                    <input class="form-control" id="drone_run_camera_rig_description" name="drone_run_camera_rig_description" title="drone_run_camera_rig_description" type="text" />
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">Base Date and Hour (For Fixed Camera Rigs e.g. Greenhouse or Growth Chambers) (Useful for fixed camera rigs capturing different pieces of a field experiment, and the capture time is not synchronized across camera rigs, but the rigs are on identical intervals. Can be the time of the first image for the rig.) (Leave empty if not applicable):</label>
                                <div class="col-sm-9" >
                                    <input class="form-control" id="drone_run_base_date" name="drone_run_base_date" title="drone_run_base_date" type="text" />
                                </div>
                            </div>
                        </div>
                        <br/>

                        <center>
                        <button class="btn btn-primary" id="drone_image_upload_drone_run_continue">Go to Next Step</button>
                        </center>
                    </&>
                    <&| /util/workflow.mas:step, title=> "Image Info" &>
                        <& /page/page_title.mas, title=>"Type of Image to Upload" &>

                        <div class="well">
                            <center><h4>Uploading already stitched orthophotomosaics or complete images of experimental field</h4></center>
                            <ul>
                                <li>You can choose to upload orthophotomosaic images (PNG, TIFF) created using external software (Pix4d, Agisoft, etc). Do not upload GeoTIFFs, instead upload reflectance raster images (.TIFF, .PNG, or .JPG).</li>
                                <li>You can upload any image (PNG, TIFF, JPEG) which covers the entire experimental field, for example, interpolated soil data for altitude or electrical conductance EC measurements. Another example is for images from a phenotyping facility, greenhouse, or growth chamber.</li>
                                <li>Up to seven distinct spectral band images can be uploaded.</li>
                                <li>Images should be perfectly super-imposable for all spectra in an imaging event.</li>
                            </ul>
                        </div>
                        <div class="well">
                            <center><h4>Uploading raw images to stitch using OpenDroneMap</h4></center>
                            <ul>
                                <li>You can upload raw images (PNG, TIFF, JPEG) from a MicaSense 5-channel camera or a color image camera, for instance collected from an aerial drone, and then orthophotomosaics will be created using OpenDroneMap and saved in ImageBreed.</li>
                                <li>Raw images are uploaded using a zipfile with maximum size of 2GB; however, many zipfiles can be uploaded in case all your images do not fit in one.</li>
                                <li>Make sure there is >65% overlap in the images, so that the images can be properly assembled.</li>
                                <li>A digital surface map (DSM) will also be generated and saved as a black and white image. The DSM is a representation of height of objects.</li>
                            </ul>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-3 control-label">Are you not uploading orthophotomosaic(s) or complete image(s) of the experimental field?:</label>
                            <div class="col-sm-9" >
                                <select class="form-control" id="drone_image_upload_drone_run_band_stitching" name="drone_image_upload_drone_run_band_stitching">
                                    <option value="">Select One</option>
                                    <option value="no">No, I am uploading stitched orthomosaic(s) or complete image(s)</option>
%  if ($c->config->{enable_opendronemap}) {
                                    <option value="yes_open_data_map_stitch">Yes, I am uploading a zipfile of raw images to stitch using OpenDroneMap</option>
%  } else {
                                    <option value="yes_open_data_map_stitch" disabled>Yes, I am uploading a zipfile of raw images to stitch using OpenDroneMap (Not configured on your system. Check Docker deployment README)</option>
%  }
                                </select>
                            </div>
                        </div>
                        <div class="form-group" id="drone_run_upload_drone_run_band_number_div">
                            <label class="col-sm-3 control-label">Number of Spectral Bands (Image Sets) To Upload:</label>
                            <div class="col-sm-9" >
                                <select class="form-control" id="drone_run_band_number" name="drone_run_band_number">
                                    <option value="">Select One</option>
                                    <option value="one_bw">One Black and White Image</option>
                                    <option value="one_rgb">One RGB Color Image</option>
                                    <option value="1">One Spectral Band or DSM raster</option>
                                    <option value="2">Two Separate Spectral Bands and/or DSM raster</option>
                                    <option value="3">Three Separate Spectral Bands and/or DSM raster</option>
                                    <option value="4">Four Separate Spectral Bands and/or DSM raster</option>
                                    <option value="5">Five Separate Spectral Bands and/or DSM raster</option>
                                    <option value="6">Six Separate Spectral Bands and/or DSM raster</option>
                                    <option value="7">Seven Separate Spectral Bands and/or DSM raster</option>
                                </select>
                            </div>
                        </div>

                        <center>
                        <button class="btn btn-primary" id="drone_image_upload_drone_run_band_continue">Go to Next Step</button>
                        </center>
                    </&>
                    <&| /util/workflow.mas:step, title=> "Images" &>
                        <& /page/page_title.mas, title=>"Select Image(s) to Upload" &>

                        <div id="upload_drone_images_select_section">
                        </div>

                        <center>
                        <button type="button" class="btn btn-info" name="upload_drone_imagery_submit" id="upload_drone_imagery_submit">Submit</button>
                        </center>
                    </&>

                </&>

                <div id="upload_drone_imagery_verify_status"></div>
            </form><br/>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="upload_drone_imagery_bulk_previous_dialog" name="upload_drone_imagery_bulk_previous_dialog" tabindex="-1" role="dialog" aria-labelledby="uploadDroneImageryBulkPreviousDialog">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="uploadDroneImageryBulkPreviousDialog">Upload Aerial Imagery in Bulk For Previously Processed Imaging Events</h4>
      </div>
      <div class="modal-body">
        <div class="container-fluid">

            <form class="form-horizontal" role="form" method="post" enctype="multipart/form-data" encoding="multipart/form-data" id="upload_drone_imagery_bulk_previous_form" name="upload_drone_imagery_bulk_previous_form">

                <&| /util/workflow.mas, id=> "drone_imagery_upload_bulk_previous_workflow" &>
                    <&| /util/workflow.mas:step, title=> "Intro" &>
                        <& /page/page_title.mas, title=>"This workflow will guide you through uploading aerial images to the database for previously processed imaging events" &>
                        <p>Your field trial(s) must already be in the database before you can upload images for it. Please go to <a href="/breeders/trials">Manage->Field Trials</a> if it is not. Make sure the planting date is also set!</p>
                        <p>In this process first upload a spreadsheet detailing the individual imaging events, then upload a zipfile containing the orthophotomosaic images for the imaging events, and finally upload a zipfile containing GeoJSON files detailing the positions of the plot-polygons for the imaging events.</p>
                        <br/>
                        <center>
                        <button class="btn btn-primary" onclick="Workflow.complete(this); return false;">Go to next step</button>
                        </center>
                    </&>
                    <&| /util/workflow.mas:step, title=> "Define Imaging Events" &>
                        <& /page/page_title.mas, title=>"Define Imaging Events in Bulk" &>

                        <h4>The uploaded Excel file (.xls) must have the following header:</h4>

                        <table class="table table-bordered table-hover">
                            <tbody>
                                <tr>
                                    <th>Imaging Event Name</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Date</th>
                                    <th>Vehicle Name</th>
                                    <th>Vehicle Battery Set</th>
                                    <th>Sensor</th>
                                    <th>Field Trial Name</th>
                                    <th>GeoJSON Filename</th>
                                    <th>Image Filenames</th>
                                    <th>Coordinate System</th>
                                </tr>
                            </tbody>
                        </table>

                        <ul>
                            <li><b>Imaging Event Name</b>: (required) The globally unique name of the imaging event name (e.g. Field1Ortho01012020)</li>
                            <li><b>Type</b>: (required) Either "Aerial Medium to High Res" or "Aerial Low Res" to indicate high or low resolution imagery.</li>
                            <li><b>Description</b>: (required) Free-text description of the imaging event and how it was flown and/or processed.</li>
                            <li><b>Date</b>: (required) The date and time of the imaging event in YYYY/MM/DD hh:mm:ss format (e.g. 2021/03/02 12:00:00)</li>
                            <li><b>Vehicle Name</b>: (required) The name of the aerial vehicle which was used. This must already exist in the database.</li>
                            <li><b>Vehicle Battery Set</b>: (optional) The name of the aerial vehicle battery set which was used.</li>
                            <li><b>Sensor</b>: (required) The type of camera sensor used. Must be either "MicaSense 5 Channel Camera", "CCD Color Camera", or "CMOS Color Camera".</li>
                            <li><b>Field Trial Name</b>: (required) The name of the field trial which was imaged. This must already exist in the database.</li>
                            <li><b>GeoJSON Filename</b>: (required) The name of the GeoJSON plot-polygon file that corresponds to this imaging event. This filename must exist in the uploaded GeoJSON zipfile. The same GeoJSON file can be used for multiple imaging events.</li>
                            <li><b>Image Filenames</b>: (required) Comma-separated list of image filenames that corresponds to this imaging event (e.g. Field1Ortho01012020__nir.tiff,Field1Ortho01012020__rgb.tiff,Field1Ortho01012020__bw.tiff). The image filenames must exist in the uploaded images zipfile. The same image file can be used for multiple imaging events.</li>
                            <li><b>Coordinate System</b>: (required) The coordinate system for the supplied images and GeoJSON files of this imaging event. Must be either "UTM", "WGS84", or "Pixels". If either "UTM" or "WGS84" are used, then the uploaded orthophoto images must be GeoTIFFs containing the coordinate system AND the GeoJSON files must be of the same coordinate system. If "Pixels" is used, then the uploaded orthophoto images must be simple raster images (.tiff, .png., .jpeg) and not GeoTIFFs, AND the GeoJSON files must describe the pixel positions of the plot-polygons relative to the provided images.</li>
                        </ul>

                        <hr>
                        <center>
                        <button class="btn btn-primary" onclick="Workflow.complete(this); return false;">Go to next step</button>
                        </center>
                    </&>
                    <&| /util/workflow.mas:step, title=> "Upload Orthophoto Images" &>
                        <& /page/page_title.mas, title=>"Upload Orthophoto Images For Imaging Events in Bulk" &>

                        <h4>Upload a zipfile (.zip) which contains orthophotos images (.tiff, .png, .jpeg) named in accordance with the "Image Filenames" defined in the previous step.</h4>
                        <h4>The images must be named as a concatenation with the spectral type of the image, with a double-underscore (__) in between (e.g. Field1Ortho01012020__blue).</h4>

                        <p>The allowed spectral types are: blue, green, red, rededge, nir, mir, fir, thir, rgb, and bw, corresponding to Blue (450-520nm), Green (515-600nm), Red (600-690nm), Red Edge (690-750nm), NIR (780-3000nm), MIR (3000-50000nm), FIR (50000-1000000nm), Thermal IR (9000-14000nm), RGB Color Image, and Black and White Image, respectively.</p>
                        <p>The zipfile should be no larger than 2GB and should contain all of the orthophoto images for the defined imaging events.</p>
                        <p>For an imaging event using a MicaSense 5-channel camera, the 5 separate orthophotos should be included in the zipfile and should be named as a concatenation with the spectral type (e.g. Field1Ortho01012020__blue, Field1Ortho01012020__green, Field1Ortho01012020__red, Field1Ortho01012020__rededge, and Field1Ortho01012020__nir).</p>
                        <p>Digital surface map (DSM) raster images can be uploaded as black and white images (e.g. Field1Ortho01012020__bw.png)</p>
                        <p>Do not upload duplicate spectral types for the same imaging event.</p>
                        <p>Images should be perfectly super-imposable for different spectra in the same imaging event.</p>
                        <p>The same image can be used for several imaging events.</p>
                        <p>If the coordinate system of the imaging event is either "UTM" of "WGS84", then the orthophoto images must be GeoTIFFs (.tiff) containing the coordinate system. If the coordinate system is "Pixels", then the orthophoto images are simple raster images (.tiff, .jpeg, .png).</p>

                        <hr>
                        <center>
                        <button class="btn btn-primary" onclick="Workflow.complete(this); return false;">Go to next step</button>
                        </center>
                    </&>
                    <&| /util/workflow.mas:step, title=> "Define Plot Polygons GeoJSON" &>
                        <& /page/page_title.mas, title=>"Define Plot Polygons in Bulk" &>

                        <h4>Upload a zipfile (.zip) which contains GeoJSON (.geojson) files detailing the coordinate positions of the plot-polygons.</h4>

                        <p>The spreadsheets should be named in accordance with the "GeoJSON Filenames" defined in the previous step.</p>
                        <p>The coordinate system (e.g. WGS84, UTM) of the orthophotos should be the same as the coordinate system defining the GeoJSON files. If the coordinate system is "Pixels", then the GeoJSON files should define the pixel positions of the plot-polygons relative to the uploaded images.</p>
                        <p>The zipfile should be no larger than 2GB.</p>
                        <p>The same GeoJSON file can be used for several imaging events.</p>

                        <hr>
                        <center>
                        <button class="btn btn-primary" onclick="Workflow.complete(this); return false;">Go to next step</button>
                        </center>
                    </&>
                    <&| /util/workflow.mas:step, title=> "Submit" &>
                        <& /page/page_title.mas, title=>"Submit to database" &>

                        <div id="upload_drone_imagery_bulk_previous_verify_status"></div>

                        <center>
                        <button type="button" class="btn btn-info" name="upload_drone_imagery_bulk_previous_submit" id="upload_drone_imagery_bulk_previous_submit">Submit</button>
                        </center>
                    </&>

                </&>
            </form><br/>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="upload_drone_imagery_bulk_dialog" name="upload_drone_imagery_bulk_dialog" tabindex="-1" role="dialog" aria-labelledby="uploadDroneImageryBulkDialog">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="uploadDroneImageryBulkDialog">Upload Aerial Imagery in Bulk For Imaging Events</h4>
      </div>
      <div class="modal-body">
        <div class="container-fluid">

            <form class="form-horizontal" role="form" method="post" enctype="multipart/form-data" encoding="multipart/form-data" id="upload_drone_imagery_bulk_form" name="upload_drone_imagery_bulk_form">

                <&| /util/workflow.mas, id=> "drone_imagery_upload_bulk_workflow" &>
                    <&| /util/workflow.mas:step, title=> "Intro" &>
                        <& /page/page_title.mas, title=>"This workflow will guide you through uploading aerial images to the database" &>
                        <p>Your field trial(s) must already be in the database before you can upload images for it. Please go to <a href="/breeders/trials">Manage->Field Trials</a> if it is not. Make sure the planting date is also set!</p>
                        <p>In this process first upload a spreadsheet detailing the individual imaging events, then upload a zipfile containing the orthophotomosaic images for the imaging events.</p>
                        <p>This workflow is only for uploading orthophotomosaic raster images, not for uploading raw captures to be stitched.</p>
                        <br/>
                        <center>
                        <button class="btn btn-primary" onclick="Workflow.complete(this); return false;">Go to next step</button>
                        </center>
                    </&>
                    <&| /util/workflow.mas:step, title=> "Define Imaging Events" &>
                        <& /page/page_title.mas, title=>"Define Imaging Events in Bulk" &>

                        <h4>The uploaded comma-separated (.csv) file must have the following header:</h4>

                        <table class="table table-bordered table-hover">
                            <tbody>
                                <tr>
                                    <th>Imaging Event Name</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Date</th>
                                    <th>Vehicle Name</th>
                                    <th>Vehicle Battery Set</th>
                                    <th>Sensor</th>
                                    <th>Field Trial Name</th>
                                    <th>Base Date</th>
                                    <th>Camera Rig</th>
                                </tr>
                            </tbody>
                        </table>

                        <ul>
                            <li><b>Imaging Event Name</b>: (required) The globally unique name of the imaging event name (e.g. Field1Ortho01012020)</li>
                            <li><b>Type</b>: (required) Either "Aerial Medium to High Res" or "Aerial Low Res" to indicate high or low resolution imagery.</li>
                            <li><b>Description</b>: (required) Free-text description of the imaging event and how it was flown and/or processed.</li>
                            <li><b>Date</b>: (required) The date and time of the imaging event in YYYY/MM/DD hh:mm:ss format (e.g. 2021/03/02 12:00:00).</li>
                            <li><b>Vehicle Name</b>: (required) The name of the aerial vehicle which was used. This must already exist in the database.</li>
                            <li><b>Vehicle Battery Set</b>: (optional) The name of the aerial vehicle battery set which was used. By default, the "default" battery will be used.</li>
                            <li><b>Sensor</b>: (required) The type of camera sensor used. Must be either "MicaSense 5 Channel Camera", "CCD Color Camera", or "CMOS Color Camera".</li>
                            <li><b>Field Trial Name</b>: (required) The name of the field trial which was imaged. This must already exist in the database.</li>
                            <li><b>Base Date</b>: (optional) The date and time to reference the imaging event in YYYY/MM/DD hh:mm:ss format (e.g. 2021/03/02 12:00:00). This is useful when separate, fixed, camera rigs are capturing different sections of the field experiment, and they are not capturing images at precisely the same time.</li>
                            <li><b>Camera Rig</b>: (optional) Free-text description of the camera rig. This is useful when separate, fixed, camera rigs are capturing different sections of the field experiment.</li>
                        </ul>

                        <br/>
                        <div class="well well-sm">
                            <div class="form-group">
                                <label class="col-sm-6 control-label">Bulk Imaging Events (.csv): </label>
                                <div class="col-sm-6" >
                                    <input type="file" id="upload_drone_imagery_bulk_imaging_events" name="upload_drone_imagery_bulk_imaging_events" encoding="multipart/form-data" />
                                </div>
                            </div>
                        </div>

                        <center>
                        <button class="btn btn-primary" onclick="Workflow.complete(this); return false;">Go to next step</button>
                        </center>
                    </&>
                    <&| /util/workflow.mas:step, title=> "Upload Orthophoto Rasters" &>
                        <& /page/page_title.mas, title=>"Upload Orthophoto Rasters For Imaging Events in Bulk" &>

                        <h4>Upload a zipfile (.zip) which contains orthophotos (.tiff, .png, .jpg) named in accordance with the imaging event names defined in the previous step.</h4>
                        <h4>The images must be named as a concatenation of the imaging event name and the spectral type of the image, with a double-underscore (__) in between (e.g. Field1Ortho01012020__blue).</h4>

                        <p>The allowed spectral types are: blue, green, red, rededge, nir, mir, fir, thir, rgb, and bw, corresponding to Blue (450-520nm), Green (515-600nm), Red (600-690nm), Red Edge (690-750nm), NIR (780-3000nm), MIR (3000-50000nm), FIR (50000-1000000nm), Thermal IR (9000-14000nm), RGB Color Image, and Black and White Image, respectively.</p>
                        <p>The zipfile should be no larger than 2GB and should contain all of the orthophoto images for the defined imaging events.</p>
                        <p>For an imaging event using a MicaSense 5-channel camera, the 5 separate orthophotos should be included in the zipfile and should be named as a concatenation of the imaging event name and the spectral type (e.g. Field1Ortho01012020__blue, Field1Ortho01012020__green, Field1Ortho01012020__red, Field1Ortho01012020__rededge, and Field1Ortho01012020__nir).</p>
                        <p>Digital surface map (DSM) raster images can be uploaded as black and white images (e.g. Field1Ortho01012020__bw.png)</p>
                        <p>Do not upload duplicate spectral types for the same imaging event.</p>
                        <p>Images should be perfectly super-imposable for different spectra in the same imaging event.</p>

                        <br/>
                        <div class="well well-sm">
                            <div class="form-group">
                                <label class="col-sm-6 control-label">Orthophoto Images ZipFile (.zip) (2GB maximum size): </label>
                                <div class="col-sm-6" >
                                    <input type="file" id="upload_drone_imagery_bulk_images_zipfile" name="upload_drone_imagery_bulk_images_zipfile" encoding="multipart/form-data" />
                                </div>
                            </div>
                        </div>

                        <center>
                        <button class="btn btn-primary" onclick="Workflow.complete(this); return false;">Go to next step</button>
                        </center>
                    </&>
                    <&| /util/workflow.mas:step, title=> "Submit" &>
                        <& /page/page_title.mas, title=>"Submit to database" &>

                        <div id="upload_drone_imagery_bulk_verify_status"></div>

                        <center>
                        <button type="button" class="btn btn-primary" name="upload_drone_imagery_bulk_submit" id="upload_drone_imagery_bulk_submit">Submit</button>
                        </center>
                    </&>

                </&>
            </form><br/>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="drone_run_imaging_vehicle_add_new_modal" name="drone_run_imaging_vehicle_add_new_modal" tabindex="-1" role="dialog" aria-labelledby="uploadDroneImageryAddNewVehicleDialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="uploadDroneImageryAddNewVehicleDialog">Add New Imaging Vehicle</h4>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
            <div class="form-horizontal">
                <div class="form-group">
                    <label class="col-sm-3 control-label">Imaging Vehicle Name (Must be unique): </label>
                    <div class="col-sm-9" >
                        <input class="form-control" id="drone_run_new_imaging_vehicle_name" name="drone_run_new_imaging_vehicle_name" type="text" placeholder="e.g. MyLabDrone1" />
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label">Imaging Vehicle Description: </label>
                    <div class="col-sm-9" >
                        <input class="form-control" id="drone_run_new_imaging_vehicle_desc" name="drone_run_new_imaging_vehicle_desc" type="text" />
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label">Battery Set Names (optional) (comma separated string of names e.g. blue,green,red,black): </label>
                    <div class="col-sm-9" >
                        <input class="form-control" id="drone_run_new_imaging_vehicle_battery_names" name="drone_run_new_imaging_vehicle_battery_names" type="text" placeholder="default_battery" value="default_battery"/>
                    </div>
                </div>
            </div>
            <br/><br/>
            <center>
                <button class="btn btn-primary" type="button" id="drone_run_new_imaging_vehicle_submit" name="drone_run_new_imaging_vehicle_submit">Submit</button>
            </center>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script defer="defer">

jQuery(document).ready(function() {

    get_select_box('trials', 'upload_drone_image_trial_select_div', { 'name' : 'drone_run_field_trial_id', 'id' : 'drone_run_field_trial_id', 'empty':1, 'multiple':0 });

    var upload_drone_imagery_vehicle_id;
    jQuery('#upload_drone_imagery_link').click( function() {
        jQuery('#upload_drone_imagery_dialog').modal("show");
        upload_drone_imagery_vehicle_id = jQuery('#drone_run_imaging_vehicle_id').val();

        if (upload_drone_imagery_vehicle_id) {
            _show_vehicle_battery_select();
        }
    });

    jQuery(document).on('change', '#drone_run_field_trial_id', function() {
        var field_trial_id = jQuery(this).val();
        jQuery('#drone_image_upload_drone_runs_table').DataTable({
            destroy : true,
            ajax : '/api/drone_imagery/drone_runs?select_checkbox_name=upload_drone_imagery_drone_run_select&field_trial_ids='+field_trial_id+'&disable=1'
        });
    });

    jQuery('#upload_drone_imagery_bulk_previous_button').click(function(e){
        e.preventDefault();
        jQuery('#upload_drone_imagery_bulk_previous_dialog').modal("show");
        return;
    });

    jQuery('#upload_drone_imagery_bulk_button').click(function(e){
        e.preventDefault();
        jQuery('#upload_drone_imagery_bulk_dialog').modal("show");
        return;
    });

    jQuery('#upload_drone_image_field_trial_select_continue').click(function(){
        if (jQuery('#drone_run_field_trial_id').val() == ''){
            alert('Please select a field trial first');
        } else {
            jQuery.ajax({
                url : '/ajax/breeders/trial/'+jQuery('#drone_run_field_trial_id').val()+'/details',
                success: function(response){
                    console.log(response);

                    if (response.details.planting_date) {
                        if (response.details.location_noaa_station_id) {
                            Workflow.complete('#upload_drone_image_field_trial_select_continue');
                            Workflow.focus('#drone_imagery_upload_workflow', 2);
                        }
                        else {
                            jQuery('#upload_drone_image_field_trial_info').html("<div class='well well-sm'>Please set the NOAA location id for this field trial before proceeding. You can do so from the manage locations page.</div>");
                        }
                    }
                    else {
                        jQuery('#upload_drone_image_field_trial_info').html("<div class='well well-sm'>Please set the planting date for this field trial before proceeding. You can do so from the trial's <a href='/breeders/trial/"+jQuery('#drone_run_field_trial_id').val()+"' target=_blank>Detail Page</a></div>");
                    }
                    return false;
                },
                error: function(response){
                    alert('Error checking field trial details!');
                }
            });
        }
        return false;
    });

    var drone_run_date_element = jQuery("#drone_run_date");
    set_daterangepicker_default (drone_run_date_element);
    jQuery('input[title="drone_run_date"]').daterangepicker(
        {
            "singleDatePicker": true,
            "showDropdowns": true,
            "autoUpdateInput": false,
            "timePicker": true,
            "timePicker24Hour": true,
        },
        function(start){
            drone_run_date_element.val(start.format('YYYY/MM/DD HH:mm:ss'));
        }
    );

    var drone_run_base_date_element = jQuery("#drone_run_base_date");
    jQuery('input[title="drone_run_base_date"]').daterangepicker(
        {
            "singleDatePicker": true,
            "showDropdowns": true,
            "autoUpdateInput": false,
            "timePicker": true,
            "timePicker24Hour": true,
        },
        function(start){
            drone_run_base_date_element.val(start.format('YYYY/MM/DD HH:mm:ss'));
        }
    );

    get_select_box('imaging_event_vehicles', 'drone_run_imaging_vehicle_div', {'id':'drone_run_imaging_vehicle_id', 'name':'drone_run_imaging_vehicle_id'});

    function _show_vehicle_battery_select() {
        jQuery.ajax({
            url : '/api/drone_imagery/get_vehicle?vehicle_id='+upload_drone_imagery_vehicle_id,
            success: function(response){
                console.log(response);
                if (response.success) {
                    var html = "<select class='form-control' name='drone_run_imaging_vehicle_battery_name' id='drone_run_imaging_vehicle_battery_name'>";
                    for (var name in response.vehicles[0].properties.batteries) {
                        if (response.vehicles[0].properties.batteries.hasOwnProperty(name)) {
                            if (response.vehicles[0].properties.batteries[name]['obsolete'] == 0) {
                                html = html + "<option value='"+name+"'>"+name+"</option>";
                            }
                        }
                    }
                    html = html + "</select>";
                    jQuery('#drone_run_imaging_vehicle_battery_div').html(html);
                }
                else if (response.error) {
                    alert(response.error);
                }
                return false;
            },
            error: function(response){
                alert('Error getting vehicle!');
            }
        });
    }

    jQuery('button[name="drone_run_imaging_vehicle_add_new"]').click(function(e){
        e.preventDefault();
        jQuery('#drone_run_imaging_vehicle_add_new_modal').modal('show');
    });

    jQuery('#drone_run_new_imaging_vehicle_submit').click(function(e){
        e.preventDefault();
        var vehicle_name = jQuery('#drone_run_new_imaging_vehicle_name').val();
        var vehicle_desc = jQuery('#drone_run_new_imaging_vehicle_desc').val();
        var vehicle_batteries = jQuery('#drone_run_new_imaging_vehicle_battery_names').val();

        if (vehicle_name == '' || vehicle_desc == '') {
            alert('Please give a vehicle name and description!');
            return false;
        }
        if (vehicle_batteries == '') {
            alert('Please give at least default battery name!');
            return false;
        }

        jQuery.ajax({
            url : '/api/drone_imagery/new_imaging_vehicle?vehicle_name='+vehicle_name+'&vehicle_description='+vehicle_desc+'&battery_names='+vehicle_batteries,
            success: function(response){
                console.log(response);
                if (response.error) {
                    alert(response.error);
                }
                else if (response.success) {
                    alert('Vehicle added!');
                    get_select_box('imaging_event_vehicles', 'drone_run_imaging_vehicle_div', {'id':'drone_run_imaging_vehicle_id', 'name':'drone_run_imaging_vehicle_id'});
                    upload_drone_imagery_vehicle_id = response.new_vehicle_id;
                    _show_vehicle_battery_select();
                }

                return false;
            },
            error: function(response){
                alert('Error adding new imaging vehicle!');
            }
        });
    });

    jQuery(document).on('change', '#drone_run_imaging_vehicle_id', function(){
        upload_drone_imagery_vehicle_id = jQuery(this).val();
        _show_vehicle_battery_select();
    });

    jQuery('#drone_image_upload_drone_run_band_stitching').change(function(){
        if (jQuery('#drone_image_upload_drone_run_band_stitching').val() == 'yes_open_data_map_stitch') {
            jQuery('#drone_run_upload_drone_run_band_number_div').hide();
        } else {
            jQuery('#drone_run_upload_drone_run_band_number_div').show();
        }
    });

    jQuery('#drone_image_upload_drone_run_band_continue').click(function(){

        var drone_run_band_number = jQuery('#drone_run_band_number').val();
        var drone_run_band_unstitched = jQuery('#drone_image_upload_drone_run_band_stitching').val();
        var drone_run_camera_info = jQuery('#drone_image_upload_camera_info').val();
        var drone_run_id = jQuery('#drone_run_id').val();
        var drone_run_name = jQuery('#drone_run_name').val();
        var drone_run_date = jQuery('#drone_run_date').val();
        var drone_run_vehicle_id = jQuery('#drone_run_imaging_vehicle_id').val();
        var drone_run_vehicle_battery_name = jQuery('#drone_run_imaging_vehicle_battery_name').val();

        if (drone_run_band_unstitched == '') {
            alert('Please select whether you are uploading orthomosaic images.');
            return false;
        }
        if (drone_run_id == '' && drone_run_camera_info == '') {
            alert('Please select the camera type used.');
            return false;
        }

        if (drone_run_vehicle_id == '' || drone_run_vehicle_battery_name == '') {
            alert('Please select an imaging event vehicle and the associated battery! You can create a new vehicle if needed');
            return false;
        }

        var html = '';
        if (drone_run_band_unstitched == 'no') {
            if (drone_run_band_number == '') {
                alert('Please select the number of drone run bands you will upload');
            } else {
                if (drone_run_band_number == 'one_bw' || drone_run_band_number == 'one_rgb') {
                    html = html + '<div class="well well-sm"><div class="form-group"><label class="col-sm-3 control-label">Drone Run Band Name (Must be unique): </label><div class="col-sm-9" ><input class="form-control" id="drone_run_band_name_1" name="drone_run_band_name_1" type="text" placeholder="e.g. Field Trial Name + Date + Band Type" value="'+drone_run_name+'_'+drone_run_date+'_RGB" disabled/></div></div><div class="form-group"><label class="col-sm-3 control-label">Drone Run Band Description: </label><div class="col-sm-9" ><input class="form-control" id="drone_run_band_description_1" name="drone_run_band_description_1" type="text" /></div></div><div class="form-group"><label class="col-sm-3 control-label">Drone Run Band Type:</label><div class="col-sm-9" ><select class="form-control" id="drone_run_band_type_1" name="drone_run_band_type_1"><option value="Black and White Image">Black and White Image</option><option value="RGB Color Image">RGB Color Image</option><option value="Blue (450-520nm)">Blue (450-520nm)</option><option value="Green (515-600nm)">Green (515-600nm)</option><option value="Red (600-690nm)">Red (600-690nm)</option><option value="Red Edge (690-750nm)">Red Edge (690-750nm)</option><option value="NIR (780-3000nm)">NIR (780-3000nm)</option><option value="MIR (3000-50000nm)">MIR (3000-50000nm)</option><option value="FIR (50000-1000000nm)">FIR (50000-1000000nm)</option><option value="Thermal IR (9000-14000nm)">Thermal IR (9000-14000nm)</option></select></div></div>';
                    html = html + '<div class="form-group"><label class="col-sm-3 control-label">Image: (.jpeg, .png)</label><div class="col-sm-9" ><input type="file" id="drone_run_band_stitched_ortho_image_1" name="drone_run_band_stitched_ortho_image_1" encoding="multipart/form-data" /></div></div>';
                    html = html + '</div>';
                } else if (drone_run_band_number == 5 && drone_run_camera_info == 'micasense_5'){
                    html = html + '<div class="well well-sm"><div class="form-group"><label class="col-sm-3 control-label">Drone Run Band Name (Must be unique): </label><div class="col-sm-9" ><input class="form-control" id="drone_run_band_name_0" name="drone_run_band_name_0" type="text" placeholder="e.g. Field Trial Name + Date + Band Type" value="'+drone_run_name+'_'+drone_run_date+'_Blue" disabled/></div></div><div class="form-group"><label class="col-sm-3 control-label">Drone Run Band Description: </label><div class="col-sm-9" ><input class="form-control" id="drone_run_band_description_0" name="drone_run_band_description_0" type="text" /></div></div><div class="form-group"><label class="col-sm-3 control-label">Drone Run Band Type:</label><div class="col-sm-9" ><select class="form-control" id="drone_run_band_type_0" name="drone_run_band_type_0" disabled><option value="Black and White Image">Black and White Image</option><option value="RGB Color Image">RGB Color Image</option><option value="Blue (450-520nm)" selected>Blue (450-520nm)</option><option value="Green (515-600nm)">Green (515-600nm)</option><option value="Red (600-690nm)">Red (600-690nm)</option><option value="Red Edge (690-750nm)">Red Edge (690-750nm)</option><option value="NIR (780-3000nm)">NIR (780-3000nm)</option><option value="MIR (3000-50000nm)">MIR (3000-50000nm)</option><option value="FIR (50000-1000000nm)">FIR (50000-1000000nm)</option><option value="Thermal IR (9000-14000nm)">Thermal IR (9000-14000nm)</option></select></div></div>';
                    html = html + '<div class="form-group"><label class="col-sm-3 control-label">Image: (.jpeg, .png)</label><div class="col-sm-9" ><input type="file" id="drone_run_band_stitched_ortho_image_0" name="drone_run_band_stitched_ortho_image_0" encoding="multipart/form-data" /></div></div>';
                    html = html + '</div>';
                    html = html + '<div class="well well-sm"><div class="form-group"><label class="col-sm-3 control-label">Drone Run Band Name (Must be unique): </label><div class="col-sm-9" ><input class="form-control" id="drone_run_band_name_1" name="drone_run_band_name_1" type="text" placeholder="e.g. Field Trial Name + Date + Band Type" value="'+drone_run_name+'_'+drone_run_date+'_Green" disabled/></div></div><div class="form-group"><label class="col-sm-3 control-label">Drone Run Band Description: </label><div class="col-sm-9" ><input class="form-control" id="drone_run_band_description_1" name="drone_run_band_description_1" type="text" /></div></div><div class="form-group"><label class="col-sm-3 control-label">Drone Run Band Type:</label><div class="col-sm-9" ><select class="form-control" id="drone_run_band_type_1" name="drone_run_band_type_1" disabled><option value="Black and White Image">Black and White Image</option><option value="RGB Color Image">RGB Color Image</option><option value="Blue (450-520nm)">Blue (450-520nm)</option><option value="Green (515-600nm)" selected>Green (515-600nm)</option><option value="Red (600-690nm)">Red (600-690nm)</option><option value="Red Edge (690-750nm)">Red Edge (690-750nm)</option><option value="NIR (780-3000nm)">NIR (780-3000nm)</option><option value="MIR (3000-50000nm)">MIR (3000-50000nm)</option><option value="FIR (50000-1000000nm)">FIR (50000-1000000nm)</option><option value="Thermal IR (9000-14000nm)">Thermal IR (9000-14000nm)</option></select></div></div>';
                    html = html + '<div class="form-group"><label class="col-sm-3 control-label">Image: (.jpeg, .png)</label><div class="col-sm-9" ><input type="file" id="drone_run_band_stitched_ortho_image_1" name="drone_run_band_stitched_ortho_image_1" encoding="multipart/form-data" /></div></div>';
                    html = html + '</div>';
                    html = html + '<div class="well well-sm"><div class="form-group"><label class="col-sm-3 control-label">Drone Run Band Name (Must be unique): </label><div class="col-sm-9" ><input class="form-control" id="drone_run_band_name_2" name="drone_run_band_name_2" type="text" placeholder="e.g. Field Trial Name + Date + Band Type" value="'+drone_run_name+'_'+drone_run_date+'_Red" disabled/></div></div><div class="form-group"><label class="col-sm-3 control-label">Drone Run Band Description: </label><div class="col-sm-9" ><input class="form-control" id="drone_run_band_description_2" name="drone_run_band_description_2" type="text" /></div></div><div class="form-group"><label class="col-sm-3 control-label">Drone Run Band Type:</label><div class="col-sm-9" ><select class="form-control" id="drone_run_band_type_2" name="drone_run_band_type_2" disabled><option value="Black and White Image">Black and White Image</option><option value="RGB Color Image">RGB Color Image</option><option value="Blue (450-520nm)">Blue (450-520nm)</option><option value="Green (515-600nm)">Green (515-600nm)</option><option value="Red (600-690nm)" selected>Red (600-690nm)</option><option value="Red Edge (690-750nm)">Red Edge (690-750nm)</option><option value="NIR (780-3000nm)">NIR (780-3000nm)</option><option value="MIR (3000-50000nm)">MIR (3000-50000nm)</option><option value="FIR (50000-1000000nm)">FIR (50000-1000000nm)</option><option value="Thermal IR (9000-14000nm)">Thermal IR (9000-14000nm)</option></select></div></div>';
                    html = html + '<div class="form-group"><label class="col-sm-3 control-label">Image: (.jpeg, .png)</label><div class="col-sm-9" ><input type="file" id="drone_run_band_stitched_ortho_image_2" name="drone_run_band_stitched_ortho_image_2" encoding="multipart/form-data" /></div></div>';
                    html = html + '</div>';
                    html = html + '<div class="well well-sm"><div class="form-group"><label class="col-sm-3 control-label">Drone Run Band Name (Must be unique): </label><div class="col-sm-9" ><input class="form-control" id="drone_run_band_name_3" name="drone_run_band_name_3" type="text" placeholder="e.g. Field Trial Name + Date + Band Type" value="'+drone_run_name+'_'+drone_run_date+'_NIR" disabled/></div></div><div class="form-group"><label class="col-sm-3 control-label">Drone Run Band Description: </label><div class="col-sm-9" ><input class="form-control" id="drone_run_band_description_3" name="drone_run_band_description_3" type="text" /></div></div><div class="form-group"><label class="col-sm-3 control-label">Drone Run Band Type:</label><div class="col-sm-9" ><select class="form-control" id="drone_run_band_type_3" name="drone_run_band_type_3" disabled><option value="Black and White Image">Black and White Image</option><option value="RGB Color Image">RGB Color Image</option><option value="Blue (450-520nm)">Blue (450-520nm)</option><option value="Green (515-600nm)">Green (515-600nm)</option><option value="Red (600-690nm)">Red (600-690nm)</option><option value="Red Edge (690-750nm)">Red Edge (690-750nm)</option><option value="NIR (780-3000nm)" selected>NIR (780-3000nm)</option><option value="MIR (3000-50000nm)">MIR (3000-50000nm)</option><option value="FIR (50000-1000000nm)">FIR (50000-1000000nm)</option><option value="Thermal IR (9000-14000nm)">Thermal IR (9000-14000nm)</option></select></div></div>';
                    html = html + '<div class="form-group"><label class="col-sm-3 control-label">Image: (.jpeg, .png)</label><div class="col-sm-9" ><input type="file" id="drone_run_band_stitched_ortho_image_3" name="drone_run_band_stitched_ortho_image_3" encoding="multipart/form-data" /></div></div>';
                    html = html + '</div>';
                    html = html + '<div class="well well-sm"><div class="form-group"><label class="col-sm-3 control-label">Drone Run Band Name (Must be unique): </label><div class="col-sm-9" ><input class="form-control" id="drone_run_band_name_4" name="drone_run_band_name_4" type="text" placeholder="e.g. Field Trial Name + Date + Band Type" value="'+drone_run_name+'_'+drone_run_date+'_RedEdge" disabled/></div></div><div class="form-group"><label class="col-sm-3 control-label">Drone Run Band Description: </label><div class="col-sm-9" ><input class="form-control" id="drone_run_band_description_4" name="drone_run_band_description_4" type="text" /></div></div><div class="form-group"><label class="col-sm-3 control-label">Drone Run Band Type:</label><div class="col-sm-9" ><select class="form-control" id="drone_run_band_type_4" name="drone_run_band_type_4" disabled><option value="Black and White Image">Black and White Image</option><option value="RGB Color Image">RGB Color Image</option><option value="Blue (450-520nm)">Blue (450-520nm)</option><option value="Green (515-600nm)">Green (515-600nm)</option><option value="Red (600-690nm)">Red (600-690nm)</option><option value="Red Edge (690-750nm)" selected>Red Edge (690-750nm)</option><option value="NIR (780-3000nm)">NIR (780-3000nm)</option><option value="MIR (3000-50000nm)">MIR (3000-50000nm)</option><option value="FIR (50000-1000000nm)">FIR (50000-1000000nm)</option><option value="Thermal IR (9000-14000nm)">Thermal IR (9000-14000nm)</option></select></div></div>';
                    html = html + '<div class="form-group"><label class="col-sm-3 control-label">Image: (.jpeg, .png)</label><div class="col-sm-9" ><input type="file" id="drone_run_band_stitched_ortho_image_4" name="drone_run_band_stitched_ortho_image_4" encoding="multipart/form-data" /></div></div>';
                    html = html + '</div>';
                } else {
                    for (var i=0; i<drone_run_band_number; i++) {
                        html = html + '<div class="well well-sm"><div class="form-group"><label class="col-sm-3 control-label">Drone Run Band Name (Must be unique): </label><div class="col-sm-9" ><input class="form-control" id="drone_run_band_name_'+i+'" name="drone_run_band_name_'+i+'" type="text" placeholder="e.g. Field Trial Name + Date + Band Type" /></div></div><div class="form-group"><label class="col-sm-3 control-label">Drone Run Band Description: </label><div class="col-sm-9" ><input class="form-control" id="drone_run_band_description_'+i+'" name="drone_run_band_description_'+i+'" type="text" /></div></div><div class="form-group"><label class="col-sm-3 control-label">Drone Run Band Type:</label><div class="col-sm-9" ><select class="form-control" id="drone_run_band_type_'+i+'" name="drone_run_band_type_'+i+'"><option value="Black and White Image">Black and White Image</option><option value="RGB Color Image">RGB Color Image</option><option value="Blue (450-520nm)">Blue (450-520nm)</option><option value="Green (515-600nm)">Green (515-600nm)</option><option value="Red (600-690nm)">Red (600-690nm)</option><option value="Red Edge (690-750nm)">Red Edge (690-750nm)</option><option value="NIR (780-3000nm)">NIR (780-3000nm)</option><option value="MIR (3000-50000nm)">MIR (3000-50000nm)</option><option value="FIR (50000-1000000nm)">FIR (50000-1000000nm)</option><option value="Thermal IR (9000-14000nm)">Thermal IR (9000-14000nm)</option></select></div></div>';
                        html = html + '<div class="form-group"><label class="col-sm-3 control-label">Image: (.jpeg, .png)</label><div class="col-sm-9" ><input type="file" id="drone_run_band_stitched_ortho_image_'+i+'" name="drone_run_band_stitched_ortho_image_'+i+'" encoding="multipart/form-data" /></div></div>';
                        html = html + '</div>';
                    }
                }
            }
        }
        else if (drone_run_band_unstitched == 'yes_open_data_map_stitch') {
            html = html + '<div class="well well-sm">';
            html = html + '<div class="form-group"><label class="col-sm-6 control-label">Drone Images ZipFile (.zip) (2GB Maximum, but can upload multiple zip files.): </label><div class="col-sm-6" ><input type="file" id="upload_drone_images_zipfile" name="upload_drone_images_zipfile" encoding="multipart/form-data" /></div></div>';

            html = html + '<div class="form-group"><label class="col-sm-6 control-label">Upload another zipfile after submit this one? Select Yes if all the images did not fit within the 2GB of the first zip file.: </label><div class="col-sm-6" ><select class="form-control" id="drone_image_upload_drone_run_band_stitching_odm_more_images" name="drone_image_upload_drone_run_band_stitching_odm_more_images"><option value="No">No</option><option value="Yes">Yes</option></select></div></div>';

            if (drone_run_camera_info == 'micasense_5') {
                html = html + '<div class="form-group"><label class="col-sm-6 control-label">MicaSense Radiometric Calibration Images ZipFile (.zip): </label><div class="col-sm-6" ><input type="file" id="upload_drone_images_panel_zipfile" name="upload_drone_images_panel_zipfile" encoding="multipart/form-data" /></div></div>';

                html = html + '<div class="form-group"><label class="col-sm-6 control-label">Perform radiometric calibration: </label><div class="col-sm-6" ><select class="form-control" id="drone_image_upload_drone_run_band_stitching_odm_radiocalibration" name="drone_image_upload_drone_run_band_stitching_odm_radiocalibration"><option value="Yes">Yes</option></select><option value="No">No</option></select></div></div>';
            }

            html = html + '</div>';
        }

        jQuery('#upload_drone_images_select_section').html(html);
        Workflow.complete('#drone_image_upload_drone_run_band_continue');
        Workflow.focus('#drone_imagery_upload_workflow', 4);
        return false;
    });

    jQuery('#drone_image_upload_drone_run_continue').click(function(){
        var selected = [];
        jQuery('input[name="upload_drone_imagery_drone_run_select"]:checked').each(function() {
            selected.push(jQuery(this).val());
        });
        if (selected.length > 1){
            alert('Only select one drone run!');
        } else {
            if (selected.length == 0 && jQuery('#drone_run_name').val() == ''){
                alert('Select a drone run or create a new one!');
            } else if (selected.length == 1 && jQuery('#drone_run_name').val() != ''){
                alert('If you selected a drone run, do not try to make a new one at the same time!');
            } else if (selected.length == 1 && jQuery('#drone_run_name').val() == ''){
                jQuery('#drone_run_id').val(selected[0]);
                Workflow.complete('#drone_image_upload_drone_run_continue');
                Workflow.focus('#drone_imagery_upload_workflow', 3);
            } else if (selected.length == 0 && jQuery('#drone_run_name').val() != '') {
                if (jQuery('#drone_run_description').val() == ''){
                    alert('Please give a drone run description.');
                } else if (jQuery('#drone_run_date').val() == ''){
                    alert('Please give a drone run date.');
                } else if (jQuery('#drone_run_type') == ''){
                    alert('Please select a drone run type');
                } else {
                    jQuery('#drone_run_id').val('');
                    jQuery.ajax({
                        url : '/api/drone_imagery/upload_drone_imagery_check_drone_name?drone_run_name='+jQuery('#drone_run_name').val(),
                        success: function(response){
                            console.log(response);

                            if (response.success) {
                                Workflow.complete('#drone_image_upload_drone_run_continue');
                                Workflow.focus('#drone_imagery_upload_workflow', 3);
                            }
                            else if (response.error) {
                                alert("Error: " + response.error);
                            }
                            return false;
                        },
                        error: function(response){
                            alert('Error checking drone run name!');
                        }
                    });
                }
            }
        }
        return false;
    });


    var drone_run_band_unstitched = '';
    var new_drone_run_band_stitching_odm_more_images = '';
    jQuery('#upload_drone_imagery_submit').click(function(){
        var drone_run_band_number = jQuery('#drone_run_band_number').val();
        drone_run_band_unstitched = jQuery('#drone_image_upload_drone_run_band_stitching').val();
        new_drone_run_band_stitching_odm_more_images = jQuery('#drone_image_upload_drone_run_band_stitching_odm_more_images').val();
        var drone_run_camera_info = jQuery('#drone_image_upload_camera_info').val();

        if (drone_run_band_unstitched == '') {
            alert('Please select whether you are uploading unstitched images.');
            return false;
        }
        if (drone_run_camera_info == '') {
            alert('Please select the camera type used.');
            return false;
        }

        if (drone_run_band_unstitched == 'no') {
            if (drone_run_band_number == '') {
                alert('Please select the number of drone run bands you will upload');
                return;
            } else {
                if (drone_run_band_number == 'one_bw' || drone_run_band_number == 'one_rgb') {
                    if (jQuery('#drone_run_band_name_1').val() == ''){
                        alert('Give a new drone run band name!');
                        return;
                    } else if (jQuery('#drone_run_band_description_1').val() == ''){
                        alert('Please give a drone run band description.');
                        return;
                    } else if (jQuery('#drone_run_band_type_1').val() == ''){
                        alert('Please select a drone run band type.');
                        return;
                    }
                    if (jQuery('#drone_run_band_stitched_ortho_image_1').val() == '') {
                        alert('Please select an image');
                        return;
                    }
                } else {
                    for (var i=0; i<drone_run_band_number; i++) {
                        if (jQuery('#drone_run_band_name_'+i).val() == ''){
                            alert('Give a new drone run band name!');
                            return;
                        } else if (jQuery('#drone_run_band_description_'+i).val() == ''){
                            alert('Please give a drone run band description.');
                            return;
                        } else if (jQuery('#drone_run_band_type_'+i).val() == ''){
                            alert('Please select a drone run band type.');
                            return;
                        }
                        if (jQuery('#drone_run_band_stitched_ortho_image_'+i).val() == '') {
                            alert('Please select an image');
                            return;
                        }
                    }
                }
            }
        } else if (drone_run_band_unstitched == 'yes_open_data_map_stitch') {
            if (jQuery('#upload_drone_images_zipfile').val() == ''){
                alert('Please select a zipfile of images');
                return;
            }

            var file_input = document.getElementById('upload_drone_images_zipfile');
            if (!file_input.files[0] || file_input.files.length > 1) {
                alert('Please select only a single zipfile that is less than 2GB in size. You can upload another zipfile afterwards if all the images did not fit in a single zipfile.');
                return;
            }
            if (file_input.files[0].size > 2000000000) {
                alert('Please select only a single zipfile that is less than 2GB in size. You can upload another zipfile afterwards if all the images did not fit in a single zipfile.');
                return;
            }

            if (jQuery('#upload_drone_images_panel_zipfile').val() == ''){
                alert('Please select a zipfile of Micasense radiocalibration panel images');
                return;
            }
        }

        upload_drone_imagery_form();
    });

    function upload_drone_imagery_form() {
        jQuery('#upload_drone_imagery_form').submit(function(e) {
            jQuery(':disabled').each(function(e) {
                jQuery(this).removeAttr('disabled');
            })
        });
        jQuery('#upload_drone_imagery_form').attr("action", "/api/drone_imagery/upload_drone_imagery");
        jQuery("#upload_drone_imagery_form").submit();
    }

    jQuery('#upload_drone_imagery_form').iframePostForm({
        json: true,
        post: function () {
            jQuery('#working_modal').modal("show");
            if (drone_run_band_unstitched == 'yes_open_data_map_stitch' && new_drone_run_band_stitching_odm_more_images == 'No') {
                jQuery('#working_msg').html("It can take a very long time to assemble the orthophotomosaic depending on the number of images uploaded. Times range from 15 minutes to 6 hours depending on the number of images, not including upload time.");
            }
        },
        complete: function (response) {
            console.log(response);
            jQuery('#working_msg').html("");

            jQuery('#working_modal').modal("hide");
            if (response.error) {
                jQuery('#drone_run_id').val(response.drone_run_project_id);
                jQuery('#drone_image_upload_drone_run_band_stitching_odm_image_count').val(response.current_image_count);
                alert(response.error);
                return;
            }
            if (drone_run_band_unstitched == 'no' || (drone_run_band_unstitched == 'yes_open_data_map_stitch' && new_drone_run_band_stitching_odm_more_images == 'No')) {
                location.reload();
            }
            else if (drone_run_band_unstitched == 'yes_open_data_map_stitch' && new_drone_run_band_stitching_odm_more_images == 'Yes') {
                jQuery('#drone_run_id').val(response.drone_run_project_id);
                jQuery('#drone_image_upload_drone_run_band_stitching_odm_image_count').val(response.current_image_count);

                alert('Select another zip file and submit! If this is your last file to upload, make sure to change the select to No.');
                return;
            }
        }
    });

    jQuery('#upload_drone_imagery_bulk_submit').click(function(){
        jQuery('#upload_drone_imagery_bulk_form').attr("action", "/api/drone_imagery/upload_drone_imagery_bulk");
        jQuery("#upload_drone_imagery_bulk_form").submit();
    });

    jQuery('#upload_drone_imagery_bulk_form').iframePostForm({
        json: true,
        post: function () {
            jQuery('#working_modal').modal("show");
        },
        complete: function (response) {
            console.log(response);
            jQuery('#working_msg').html("");

            jQuery('#working_modal').modal("hide");
            if (response.error) {
                alert(response.error);
                return;
            }
            else if (response.error_string) {
                jQuery('#upload_drone_imagery_bulk_verify_status').html(response.error_string);
                return;
            }
            else {
                alert('Successfully uploaded!');
                location.reload();
            }
        }
    });

});

</script>
