
<%args>
$user_id => undef
$locations => ()
</%args>

<& /util/import_javascript.mas, classes => [ ] &>

<%perl>

  if (!$locations) {
    print "<tr><td>No locations have been added yet.</td></tr>";
  }

#print "<table class=\"table table-striped table-hover table-condensed\">";


print "<div class=\"col-sm-12 col-md-12 col-lg-12 table-responsive\" id=\"location_table_div\">";

foreach my $prog (sort keys %$locations) {
    print "<label><a href=\"/breeders/manage_programs/\">$prog</a> locations:</label>
    <table class=\"table table-bordered table-striped table-highlight\">
      <thead>
        <th>Location name</th>
        <th>Latitude</th>
        <th>Longitude</th>
        <th>Altitude(m)</th>
        <th>Trial Count</th>
        <th>Edit</th>
        <th>Remove</th>
      </thead>
      <tbody>";

  foreach my $loc (@{$locations->{$prog}}) {
    my $id = $loc->[0];
    my $name = $loc->[1];
    my $lat = $loc->[2] || '';
    my $long = $loc->[3] || '';
    my $alt = $loc->[4] || '';
    my $count = $loc->[5] || 0;
    my ($edit_link, $delete_link);

    if ($user_id && $count < 1) {
      $delete_link = "&nbsp;&nbsp;&nbsp;<a href=\"javascript:delete_location($id)\"><font style=\"color: red; font-weight: bold\">X</a>";
      $edit_link = "&nbsp;&nbsp;&nbsp;<a href=\"javascript:edit_location($id)\"><font style=\"color: blue; font-weight: bold\">Edit</a>";
    }

    print "<tr><td id=\"".$id."\">".$name."</td><td id=\"".$id."_lat\">".$lat."</td><td id=\"".$id."_long\">".$long."</td><td id=\"".$id."_alt\">".$alt."</td><td>(<a href=\"/search/trials?nd_geolocation=$name\">".$count." trials</a>)</td><td>$edit_link</td><td>$delete_link</td></tr>";
   }

   #print "</tbody><thead><tr style=\"height:30px\"><td colspan=\"6\"></td></tr></thead>";
   print "</tbody></table>";
}

#print "</table>";
print "</div>";

</%perl>

<div class="modal fade" id="add_location_dialog" name="add_location_dialog" tabindex="-1" role="dialog" aria-labelledby="addLocationDialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="addLocationDialog">Add New Location</h4>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
	  <form class="form-horizontal" role="form" name="new_location_form" id="new_location_form">
	    <div class="form-group">
      	      <label class="col-sm-2 control-label">Name: </label>
      	      <div class="col-sm-10">
		<input class="form-control" name="new_name" id="new_name" type="text" />
              </div>
	    </div>
      <div class="form-group">
              <label class="col-sm-2 control-label">Latitude: </label>
              <div class="col-sm-10">
    <input class="form-control" name="new_latitude" id="new_latitude" type="text" size="4"/>
              </div>
      </div>
	    <div class="form-group">
      	      <label class="col-sm-2 control-label">Longitude: </label>
      	      <div class="col-sm-10">
		<input class="form-control" name="new_longitude" id="new_longitude" type="text" size="4"/>
              </div>
	    </div>
	    <div class="form-group">
      	      <label class="col-sm-2 control-label">Altitude (m): </label>
      	      <div class="col-sm-10">
		<input class="form-control" name="new_altitude" id="new_altitude" type="text" size="4"/>
              </div>
	    </div>
	  </form>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" name="new_location_submit" id="new_location_submit">Add Location</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="edit_location_dialog" name="edit_location_dialog" tabindex="-1" role="dialog" aria-labelledby="editLocationDialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="editLocationDialog">Edit Location</h4>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
	  <form class="form-horizontal" role="form" name="edit_location_form" id="edit_location_form">
        <div class="form-group" id="change_id" style="display: none">
	    <div class="form-group">
      	      <label class="col-sm-2 control-label">Name: </label>
      	      <div class="col-sm-10">
		<input class="form-control" name="change_name" id="change_name" type="text" />
              </div>
	    </div>
      <div class="form-group">
              <label class="col-sm-2 control-label">Latitude: </label>
              <div class="col-sm-10">
    <input class="form-control" name="change_latitude" id="change_latitude" type="text" size="4"/>
              </div>
      </div>
	    <div class="form-group">
      	      <label class="col-sm-2 control-label">Longitude: </label>
      	      <div class="col-sm-10">
		<input class="form-control" name="change_longitude" id="change_longitude" type="text" size="4"/>
              </div>
	    </div>
	    <div class="form-group">
      	      <label class="col-sm-2 control-label">Altitude (m): </label>
      	      <div class="col-sm-10">
		<input class="form-control" name="change_altitude" id="change_altitude" type="text" size="4"/>
              </div>
	    </div>
	  </form>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" name="edit_location_submit" id="edit_location_submit">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<script defer="defer">

jQuery(document).ready(function() {

  $('#add_location_link').click( function() {
      $('#add_location_dialog').modal("show");
   });

  $('#new_location_submit').click( function(event) {
      event.preventDefault();
      var name = $('#new_name').val();
      var longitude = $('#new_longitude').val();
      var latitude = $('#new_latitude').val();
      var altitude = $('#new_altitude').val();

      if (name == '') { alert('A location name is required.');  return; }

      $.ajax({
        type: 'POST',
        url: '/ajax/breeders/location/store',
        data: { 'id':'', 'name': name,  'longitude':longitude, 'latitude':latitude, 'altitude': altitude },
        success: function(response) {
                 if (response.error) { alert(response.error); }
                 else {
                     alert(response.success);
                     $('#add_location_dialog').modal("hide");
                     location.reload();
                 }
                },
        error: function() { alert('An error occurred while saving the new location. Please try again later.'); }
      });
  });

  $('#edit_location_submit').click( function(event) {
      event.preventDefault();
      var id= $('#change_id').val();
      var name = $('#change_name').val();
      var longitude = $('#change_longitude').val();
      var latitude = $('#change_latitude').val();
      var altitude = $('#change_altitude').val();

      if (name == '') { alert('A location name is required.');  return; }

      $.ajax({
        type: 'POST',
        url: '/ajax/breeders/location/store',
        data: { 'id':id, 'name': name,  'longitude':longitude, 'latitude':latitude, 'altitude': altitude },
        success: function(response) {
                 if (response.error) { alert(response.error); }
                 else {
                     alert(response.success);
                     $('#edit_location_dialog').modal("hide");
                     location.reload();
                 }
                },
        error: function() { alert('An error occurred while editing the location. Please try again later.'); }
      });
  });

});


  function delete_location(id) {
    var name = $('#'+id).text();
    var yes = confirm('Are you sure you want to delete location '+name+'? ');

    if (! yes) { return; }

    new jQuery.ajax( {
      type: 'POST',
      url: '/ajax/breeders/location/delete/'+id,
      success: function(response) {
                  if (response.error) { alert(response.error); }
                  else {
                    alert(response.success);
		    location.reload();
                  }
               },
      error: function(response) {
                 alert("An error occurred");
             }
      });
   }

   function edit_location(id) {
        console.log("Id for location to edit is "+id);
        $('#change_id').val(id);
        $('#change_name').val($('#'+id).text());
        $('#change_latitude').val($('#'+id+'_lat').text());
        $('#change_longitude').val($('#'+id+'_long').text());
        $('#change_altitude').val($('#'+id+'_alt').text());
        $('#edit_location_dialog').modal("show");
    }


</script>
