
<%args>
$user_id => undef
</%args>

<& /util/import_javascript.mas, classes => [ ] &>

<div class="table-responsive" style="margin-top: 10px;">
    <table id="location_table" class="table table-hover table-striped table-bordered" width="100%">
        <thead>
            <tr>
    <th>Location name</th>
    <th>Abbrev.</th>
    <th>Country</th>
    <th>Type</th>
    <th>Lat.</th>
    <th>Long.</th>
    <th>Altitude(m)</th>
    <th>Trials</th>
    <th>Edit</th>
    <th>Remove</th>
</tr>
  </thead>
  <caption class="well well-sm" style="caption-side: bottom;margin-top: 10px;"><center> Locations </center></caption>
</table>
</div>

<div class="modal fade" id="store_location_dialog" name="store_location_dialog" tabindex="-1" role="dialog" aria-labelledby="storeLocationDialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="storeLocationDialog">Location Details</h4>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
	  <form class="form-horizontal" role="form" name="store_location_form" id="store_location_form">
        <div class="form-group" id="location_id" style="display: none"></div>
	    <div class="form-group">
      	      <label class="col-sm-2 control-label">Name: </label>
      	      <div class="col-sm-10">
		<input class="form-control" name="location_name" id="location_name" type="text" />
              </div>
	    </div>
        <div class="form-group">
      	      <label class="col-sm-2 control-label">Abbreviation: </label>
      	      <div class="col-sm-10">
		<input class="form-control" name="location_abbreviation" id="location_abbreviation" type="text" />
              </div>
	    </div>
        <div class="form-group">
      	      <label class="col-sm-2 control-label">Country: </label>
      	      <div class="col-sm-10">
		<input class="form-control" name="location_country" id="location_country" type="text" />
              </div>
	    </div>
        <div class="form-group">
      	      <label class="col-sm-2 control-label">Type: </label>
      	      <div class="col-sm-10">
		<input class="form-control" name="location_type" id="location_type" type="text" />
              </div>
	    </div>
      <div class="form-group">
              <label class="col-sm-2 control-label">Latitude: </label>
              <div class="col-sm-10">
    <input class="form-control" name="location_latitude" id="location_latitude" type="text" size="4"/>
              </div>
      </div>
	    <div class="form-group">
      	      <label class="col-sm-2 control-label">Longitude: </label>
      	      <div class="col-sm-10">
		<input class="form-control" name="location_longitude" id="location_longitude" type="text" size="4"/>
              </div>
	    </div>
	    <div class="form-group">
      	      <label class="col-sm-2 control-label">Altitude (m): </label>
      	      <div class="col-sm-10">
		<input class="form-control" name="location_altitude" id="location_altitude" type="text" size="4"/>
              </div>
	    </div>
	  </form>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" name="store_location_submit" id="store_location_submit">Store Location Details</button>
      </div>
    </div>
  </div>
</div>

<script defer="defer">

jQuery(document).ready(function() {

    var location_table = jQuery('#location_table').DataTable( {
        'ajax': '/ajax/location/all'
    });

  $('#add_location_link').click( function() {
      $('#store_location_dialog').modal("show");
   });

   $('#store_location_submit').click( function(event) {
       event.preventDefault();
       var id= $('#location_id').val();
       var name = $('#location_name').val();
       var abbreviation = $('#location_abbreviation').val();
       var country = $('#location_country').val();
       var type = $('#location_type').val();
       var longitude = $('#location_longitude').val();
       var latitude = $('#location_latitude').val();
       var altitude = $('#location_altitude').val();


       var country_name = country.substr(0, country.indexOf('('));
       var re = /\((.*)\)/;
       var country_code = country.match(re)[1];

       console.log("Location name to store is "+name);
       console.log("Location country name to store is "+country_name+" and country code is "+country_code);

       if (name == '') { alert('A location name is required.');  return; }

       $.ajax({
         type: 'POST',
         url: '/ajax/location/store',
         data: { 'id': id, 'name': name, 'abbreviation': abbreviation, 'country_name': country_name, 'country_code': country_code, 'type': type, 'longitude':longitude, 'latitude':latitude, 'altitude': altitude },
         success: function(response) {
                  if (response.error) { alert(response.error); }
                  else {
                      alert(response.success);
                      $('#store_location_dialog').modal("hide");
                      location.reload();
                  }
                 },
         error: function() { alert('An error occurred while storing the location details. Please try again later.'); }
       });
   });

});


  function delete_location(id) {
    var name = $('#'+id).text();
    var yes = confirm('Are you sure you want to delete location '+name+'? ');

    if (! yes) { return; }

    new jQuery.ajax( {
      type: 'POST',
      url: '/ajax/location/delete/'+id,
      success: function(response) {
                  if (response.error) { alert(response.error); }
                  else {
                    alert(response.success);
		    location.reload();
                  }
               },
      error: function(response) {
                 alert("An error occurred");
             }
      });
   }

   function edit_location(id) {
        console.log("Id for location to edit is "+id);
        $('#location_id').val(id);
        $('#location_name').val($('#'+id).text());
        $('#location_abbreviation').val($('#'+id+'_abbrev').text());
        $('#location_country').val($('#'+id+'_country').text());
        $('#location_type').val($('#'+id+'_type').text());
        $('#location_latitude').val($('#'+id+'_lat').text());
        $('#location_longitude').val($('#'+id+'_long').text());
        $('#location_altitude').val($('#'+id+'_alt').text());
        $('#store_location_dialog').modal("show");
    }


</script>
