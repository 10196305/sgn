<%args>

</%args>

<& /page/page_title.mas, title=>"Analyze Phenotypes" &>

<div class="container-fluid">

<div class="well">
Choose a list for each parameter and click "Analyze".
</div>

<div class="well well-sm">
<form id="analyze_form" action="/analyze/phenotypes/compare_trials" method="POST" >
<table class="table" cellpadding="10" border="0" >
  <thead>
  <tr><td colspan="4"><h4>Analyze Trial Phenotypes</h4><p>Select parameter:</p></tr>
  <tr>
    <th>
      Accessions
    </th>
    <th>
      Trials
    </th>
    <th>
      Traits
    </th>
    <th>
      Type
    </th>
    <th>
      Action
    </th>
  </tr>
  </thead>
  <tbody>
  <tr>
    <td>
      <div id="accession_list">
      </div>      
    </td>
    <td>
      <div id="trial_list">
      </div>
    </td>
    <td>
      <div id="trait_list">
      </div>
   </td>
   <td>
 <div class="checkbox">
  <label><input type="checkbox" id="format" name="format" value="blocks">blocks (default)</label>
</div>
<div class="checkbox">
  <label><input type="checkbox" id="format" name="format" value="years">years</label>
</div>
<div class="checkbox">
  <label><input type="checkbox" id="format" name="format" value="locations">locations</label>
</div>
    </td>
    <td>
      <input class="btn btn-primary" type="button" id="analyze" value="Analyze" />
      <input type="hidden" id="analyze_token_value" name="analyze_token_value"/>
    </td>
  </tr>
  </tbody>
  </table>
</form>
</div>

<script>  
$(document).ready(function() { 

    var lo = new CXGN.List();

    $('#accession_list').html(lo.listSelect('accession_list', [ 'accessions' ], 'select'));
    $('#trial_list').html(lo.listSelect('trial_list', [ 'trials' ], 'select' ));
    $('#trait_list').html(lo.listSelect('trait_list', [ 'traits' ], 'select'  ));
 
    $('#analyze').click(function() {

    disable_ui();
   
      var accession_list_id = $('#accession_list_list_select').val();
      var trial_list_id = $('#trial_list_list_select').val();
      var trait_list_id = $('#trait_list_list_select').val();

      var accession_validation = 1;
      if (accession_list_id) { accession_validation = lo.validate(accession_list_id, 'accessions', true); }
      
      var trial_validation = 1; 
      if (trial_list_id) { trial_validation = lo.validate(trial_list_id, 'trials', true); }
  
      var trait_validation = 1;
      if (trait_list_id) { trait_validation = lo.validate(trait_list_id, 'traits', true); } 

      if (!accession_list_id || !trial_list_id || !trait_list_id) {
      	 enable_ui();
      	 alert("You need to select an accession, a trial, and a trait list!");
	 return; 
      }

      var problem_lists = new Array();

      if (accession_validation != 1) { 
        problem_lists.push('accessions');
      }
      if (trial_validation != 1) { 
        problem_lists.push('trials');
      }
      if (trait_validation != 1) { 
        problem_lists.push('trials');
      }

      if (problem_lists.length > 0) {
      	 enable_ui();
      	 alert("The following lists did not pass validation: "+problem_lists.join(", ")+". Please correct the list(s) and try again");
	 return;
      }

      var token = new Date().getTime(); //use the current timestamp as the token value
      $('#analyze_token_value').val(token);
      
      $('#analyze_form').submit();
      
      var fileDownloadCheckTimer;
      fileDownloadCheckTimer = window.setInterval(function () { //checks for response cookie to keep working modal enabled until file is ready for download
      			     var cookieValue = $.cookie('fileDownloadToken');
			     if (cookieValue == token) {
			     	window.clearInterval(fileDownloadCheckTimer);
				jQuery.removeCookie('fileDownloadToken'); //clears this cookie value
				enable_ui();
				}
			}, 1000);
	});

	function disable_ui() {
	$('#working_modal').modal("show");
	}

	function enable_ui() {
	$('#working_modal').modal("hide");
	}
});

</script>
