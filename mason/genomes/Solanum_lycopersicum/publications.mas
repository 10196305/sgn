<& /util/import_javascript.mas, classes=>["CXGN.Effects"] &>

<style type="text/css">

  table.more{
    background-color: #FFFFEE;
    text-align: left;
    font-size: 14px;
    width: 400px;
    height: auto;
    border: 3px double gray;
    margin-left: auto;
    margin-right: auto;
    padding-left: 10px;
  }

  table.year{
    background-color: #FFFFCC;
    text-align: center;
    font-size: 14px;
    color: black;
    width: 520px;
    height: auto;
    border: 2px outset gray;
    margin: 20px;
    margin-left: auto;
    margin-right: auto;
    padding-top: 15px;
    padding-left: 15px;
    padding-right: 15px;
  }

  td.width{
    width: 60px;
    color: #AA0000;
  }

  tr.author{
    visibility: collapse;
  }

</style>


<script type="text/javascript">
  function display(pub_id){
    if (document.getElementById(pub_id).style.visibility == "visible"){
       document.getElementById(pub_id).style.visibility="collapse";
    }
    else{
      document.getElementById(pub_id).style.visibility="visible";
    }
  }

  function message(link_id, pub_id){
      if (document.getElementById(pub_id).style.visibility == "visible"){
        document.getElementById(link_id).innerHTML = "more authors";
      }
      else{
        document.getElementById(link_id).innerHTML = "show less";
      }
  }
</script>

<& /page/page_title.mas, title => "Tomato Genome Publications" &>

<%args>
  $schema
</%args>

<%init>
use CXGN::Page::FormattingHelpers;
use List::MoreUtils qw/uniq/;

my $pubmed = $schema->resultset('General::Db')
                    ->find({ name => 'PMID' });

### get all publications from pubprop database, then index them by pub year
my @pubs =
    $schema->resultset('Cv::Cvterm')
           ->search({name => 'tomato genome publication'})
           ->search_related('pubprops', {})
           ->search_related('pub', {}, 
                            { prefetch => { pub_dbxrefs => 'dbxref' },
                            }
                           );

# index the publications in a hash by year
my %pubs_by_year;
for my $pub (@pubs) {
  push @{ $pubs_by_year{ $pub->pyear } }, $pub;
}
</%init>

<&| /page/info_section.mas, title=>'Publications', collapsible => 0 &>

%  # for each year, print out the pubs associated with it
%   for my $year (sort {$b <=> $a} keys %pubs_by_year ) {
%     my $pubs = $pubs_by_year{$year};
      <&| /page/info_section.mas, title         => $year,
                                  subtitle      => @$pubs.' publication'.(@$pubs > 1 ? 's' : ''),
                                  collapsible   => 1,
                                  is_subsection => 1,
         &>

%        # render each of the publications for this year
%        for my $pub ( @$pubs ) {
            <& .publication, pub => $pub, pubmed => $pubmed &>
%        }
      </&>
%   }
</&>


% ############ SUBCOMPONENTS #################
% # subcomponent that displays a publication
<%def .publication >
<%args>
  $pub
  $pubmed
</%args>

<%perl>

    #---getting authors - if the list is too long, only show the first 10,
    #---the rest of the authors are shown once a link is clicked
    my @authors = $pub->search_related('pubauthors', {}, { order_by => 'rank' });
    my @names =
          join ', ',
          map $_->givennames." ".$_->surname,
          grep $_,
          @authors[ 0..9 ];

    my @extra_names =
          join ', ',
          map $_->givennames." ".$_->surname,
          grep $_,
          @authors[ 10..$#authors ];

</%perl>

<table class="year">
<tr><td><b><% $pub->title %></b></td></tr>
<tr>
  <td>
    <br />
    <table class="more">
      <tr>
	<td class="width">Author(s):</td>
	<td><% @names %>
% if( @extra_names ){
	  <a id=<% $pub->pub_id %>
	      href="javascript:display(<% $pub->pub_id %>);"
	      onclick="message(<% $pub->pub_id %>, <% $pub->pub_id %>);"
          >
	      more authors
	  </a>
	  <tr id=<% $pub->pub_id %> class="author">
	    <td> </td>
	    <td><% @extra_names %></td>
	  </tr>
%  }
	</td>
      </tr>
      <tr>
	<td class="width">Journal:</td>
	<td><% $pub->series_name %></td>
      </tr>
      <tr>
	<td class="width">Volume:</td>
	<td><% $pub->volume %></td>
      </tr>
% if( $pub->issue ) {
      <tr>
	<td class="width">Issue:</td>
	<td><% $pub->issue %></td>
      </tr>
% }
      <tr>
	<td class="width">Pages:</td>
	<td><% $pub->pages %></td>
      </tr>
% if( $pubmed
%      and  my $pm_dbx = $pub->search_related('pub_dbxrefs', {})
%                            ->search_related('dbxref', { db_id => $pubmed->db_id } )
%                            ->first
%    ) {
      <tr>
	<td class="width">Pubmed:</td>
	<td><a target="_blank"
	href="http://www.ncbi.nlm.nih.gov/sites/pubmed/<% $pm_dbx->accession %>">
	Pubmed ID <% $pm_dbx->accession %>
	</a>
	</td>
      </tr>
% }
    </table>
    <br />
    <br />
  </td>
</tr>
</table>

</%def>
