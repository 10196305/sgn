
<%doc>


</%doc>

<%args> 
$datasets
</%args>

<& '/page/page_title.mas', title => "Create Boxplots" &>

<& '/util/import_javascript.mas', classes => ['jquery','d3.d3v4Min','brapi.BrAPI','brapi.BoxPlotter'] &>

<style media="screen">
  .groupBy-div:only-child .groupBy-remove{
    display: none;
  }
  .boxplot .infotext{
    opacity: 0;
  }
  .boxplot:hover .infotext{
    opacity: 1;
  }
</style>

<div class="row">
  <div class="groupBy-div form-inline col-sm-12 form-group">
    <label for="sort" class="control-label">Dataset</label>
    <select id="datasetSelect" class="form-control">
      <option value="" disabled selected>Select a Dataset</option>
% foreach my $dataset (@{$datasets}) {
    <option value="<% @{$dataset}[0] %>"><% @{$dataset}[1] %><% (defined @{$dataset}[2])&&@{$dataset}[2]!="undefined"?" - ".@{$dataset}[2]:"" %></option>
% }
    </select>
    <select id="obsunitSelect" class="form-control">
      <option selected value="plot">Plots</option>
      <option value="plant">Plants</option>
    </select>
    <div class="well well-sm"> Note: Constraints other than accessions, traits, trials, locations, and program will be ignored </div>
  </div>
</div>

<div class="row">
  <div class="form-inline col-sm-12 form-group">
    <label for="sort" class="control-label">Variable</label>
    <select id="variableSelect" class="form-control"></select>
  </div>
</div>

<div class="row">
  <div class="groupBy-div hidden form-inline col-sm-12 form-group">
    <label for="sort" class="control-label"> Display By </label>
    <select class="form-control groupBy">
      <option value="" selected></option>
    </select>
    <a class="btn btn-default groupBy-add">+</a>
    <a class="btn btn-default groupBy-remove">-</a>
  </div>
</div>

<div class="row">
  <div id="bxplt_result" style="max-width: 100%; overflow-x:auto;"></div>
</div>

<script>
(function(){
  var boxplot = BrAPIBoxPlotter("#bxplt_result");
  function loadDatasetObsUnits(ds,ou){
    var d = {
      'dataset':ds    
    };
    console.log(d);
    $.ajax({
      url : '/ajax/tools/boxplotter/get_constraints',
      type : 'GET',
      data : d,
      dataType:'json',
      success : function(data) {    
        console.log(data);
        var obsUnits = BrAPI("/brapi/v1").phenotypes_search({
          "germplasmDbIds" : data["categories"]["accessions"],
          "observationVariableDbIds" : data["categories"]["traits"],
          "studyDbIds" : data["categories"]["trials"],
          "locationDbIds" : data["categories"]["locations"],
          "programDbIds" : data["categories"]["breeding_programs"],
          "observationLevel" : ou, 
          "pageSize" : 1000
        })
        boxplot.setData(obsUnits);
        obsUnits.all(function(d){
          console.log(d);
        });
      }
    });
  }
  function drawVariableSelect(){
    boxplot.getVariables().then(vs=>{
      var vars = d3.select("#variableSelect").selectAll("option").data(vs);
      vars.exit().remove();
      var allVars = vars.enter().append("option")
        .merge(vars)
        .attr("value",d=>d.key)
        .attr("selected",d=>d.key==boxplot.variable?"":null)
        .text(d=>d.value);
    });
    d3.select("#variableSelect").on("change",function(){
      boxplot.setVariable(this.value);
    })
  }
  $("#datasetSelect, #obsunitSelect").change(function(){
    var ds = $("#datasetSelect option:selected").val();
    var ou = $("#obsunitSelect option:selected").val();
    if(ds=="") return;
    loadDatasetObsUnits(ds,ou);
  });
  
})();
</script>
