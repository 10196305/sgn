<!-- for drag and resize -->
<script src="http://code.jquery.com/jquery-1.8.2.js"></script>
<script src="http://code.jquery.com/ui/1.9.1/jquery-ui.js"></script>


<!-- AJAX -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

<!-- info tabs and hide view -->
<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>

<%args>

@databases
$sequence => undef

</%args>

<& /util/import_javascript.mas, classes => [ 'jquery', 'jqueryui', 'jquery.iframe-post-form','CXGN.List',] &>

<div id="input_view">
<& /page/page_title.mas, title=>"VIGS Tool" &>

<center>

Sequence:

<script>
	var seq = ">Solyc10g047140.1.1 Receptor like kinase, RLK\nATGGATCAGTCGGTGTTGGCGATCTGGGTATTTCTCTGCTTAATTGGTCTGCTTTTCAATTTGTCACCCGTCGCCGGTAACGCTGAAGGTGATGCCTTGAATGCTCTGAAGACAAATTTGGCTGATCCTAATAGTGTTCTACAGAGTTGGGATGCAACCCTTGTTAATCCTTGTACTTGGTTCCATGTGACATGCAACAATGAAAATAGTGTGACTAGAGTTGATCTAGGAAATGCAAATCTATCAGGTCAACTGGTACCACAGCTTGGCCAACTCCAGAAATTGCAGTACTTGGAACTTTATAGTAATAACATAAGCGGAAGAATTCCAAATGAACTGGGAAACTTGACAGAGTTGGTTAGTTTGGATCTTTACCTGAACAACTTAAATGGTCCTATTCCTCCCTCATTGGGCAGGCTTCAGAAGCTACGCTTCCTGAGGCTCAATAATAACAGTTTGAATGAAGGTATTCCCATGTCTCTAACCACCATTGTTGCACTTCAAGTACTTGATCTCTCAAACAACCATTTGACAGGACTAGTTCCAGTCAACGGTTCCTTTTCACTTTTTACTCCTATAAGTTTTGCTAATAATCAGTTGGAAGTTCCTCCAGTTTCTCCACCTCCTCCTCTTCCTCCTACACCCTCATCGTCATCTTCAGTGGGCAACAGCGCAACTGGAGCTATCGCTGGAGGAGTTGCTGCAGGCGCTGCTCTTCTATTTGCAGCTCCTGCAATTTTTCTTGCTTGGTGGCGTCGGAGGAAACCACAAGACCACTTCTTTGATGTTCCTGCTGAGGAGGATCCAGAAGTTCATCTGGGACAACTCAAAAGGTTTTCCTTGCGTGAACTACAAGTTGCGTCGGATAATTTTAGCAACAGAAATATACTCGGTAGAGGTGGATTTGGTAAGGTTTATAAGGGCCGGTTAGCTGATGGCTCTTTAGTTGCAGTGAAAAGACTAAAAGAGGAACGTACTCAAGGTGGAGAGTTACAGTTCCAGACAGAAGTAGAAATGATCAGCATGGCTGTACACCGAAACCTACTTCGTTTACGGGGCTTTTGCATGACACCCACTGAGCGCGTGCTTGTTTATCCTTACATGGAGAATGGAAGTGTTGCATCACGTTTAAGAGAGAGGCCTGAATCAGAGCCCCCACTTGACTGGCCAAAAAGGAAGCGTATTGCACTTGGATCTGCAAGAGGCCTTGCTTACTTGCATGATCATTGTGATCCTAAAATTATTCATCGTGACGTCAAAGCCGCAAATATCTTGTTGGATGAGGAGTTTGAAGCAGTTGTTGGGGATTTTGGGTTAGCTAAACTCATGGACTACAAGGATACTCATGTTACCACTGCTGTACGTGGTACAATTGGGCATATTGCCCCTGAATATTTATCTACTGGTAAATCTTCTGAGAAAACTGATGTCTTTGGCTATGGGGTTATGCTTCTAGAGCTCATAACTGGGCAAAGGGCTTTTGATCTTGCTCGACTTGCGAATGATGATGATGTCATGCTGCTAGATTGGGTGAAGGGACTCCTGAAGGACAAGAAATATGAAACATTAGTTGATGCAGATCTTCAAGGTAATTACAATGAAGAAGAGGTGGAACAACTTATTCAGGTAGCTCTACTTTGCACGCAGAGTACGCCTACGGAACGTCCAAAGATGTCAGAAGTTGTAAGAATGCTTGAAGGTGATGGCCTTGCTGAGAGGTGGGAGGAATGGCAAAAGGAGGAGATGTTCCGGCAAGATTACAACCATGTACACCACCCCCATACTGATTGGATAATAGCTGACTCCACGTCAAATATCCGACCGGATGAGTTGTCAGGGCCAAGATGA\n";

	document.write("(<a href=\"javascript:example()\" >example sequence</a>)");

	function example() { 
	    document.getElementById("sequence").value=seq;
	}	    
</script>
<span id="status_wheel"></span>
<br />


<textarea id="sequence" name="sequence" cols=62" rows="8"></textarea>
<br />
<br />

<span title="siRNA selected size">n-mer size</span> 
<input id="si_rna" type="input" value="21" name="fragment_size" size="2" />&nbsp; &nbsp; &nbsp;

<span title="desired VIGS fragment length">Fragment length</span> 
<input id="f_length" type="input" value="300" name="seq_fragment" size="3" />&nbsp; &nbsp; &nbsp;

<span title="Number of miss-matches allowed in BowTie 2 alignment">miss-matches</span> 
<input id="mm" type="input" value="0" name="missmatch" size="1" />
<br />
<br />
Database <select name="database"> 
<br />

<%perl>
foreach my $d (@databases) { 
    print "<option id='bt2_db' value=\"".$d->id()."\">".$d->title()."</option><br />";
}     
</%perl>
</select>
<br />
<br />


<form method="post" enctype="multipart/form-data" encoding="multipart/form-data" id="upload_expression_form" name="upload_expression_form" action="/ajax/upload_expression_file">
    Upload Expression file: <input type="file" name="expression_file" id="expression_file" encoding="multipart/form-data" />
</form>


<br />
<br />
<button type="buttom" value="clear" onClick="clearForm()">Clear</button>&nbsp; &nbsp; &nbsp;
<button type="buttom" id="upload_expression_file" value="Run VIGS Analysis">Run VIGS Analysis</button>


<br />
<br />


</center>
</div>


<div id="usage_view">
    <hr />
    <p>
        <b>Usage:</b><br />
        1. Paste a <b>sequence</b> like in one of the examples:<br />
        &nbsp;&nbsp;>seq1<br />&nbsp;&nbsp;accgatcgatcgatcgta<br />

        &nbsp;&nbsp;Or:<br />
        &nbsp;&nbsp;acgtagctagctgatcat<br />
         
        2. Choose <b>n-mer size</b>, nucleotide stretch size in bp, used to identify targeted regions (18-30, Default=21)<br />
        3. Choose <b>Fragment length</b>, desired VIGS fragment length in bp (100-Sequence length, Default=300)<br />
        4. Choose <b>miss-matches</b>, number of miss-matches allowed in the alignment (0-3, Default=0)<br />
        5. Choose <b>database</b><br />
        6. Upload a <b>expression values file</b> (optional), gene identifiers must be in first column and a header in the first row
     </p>
     <hr />
</div>


<!-- ##################################################################################### -->
<!-- OUTPUT VIEW -->
<!-- ##################################################################################### -->


<& /util/import_javascript.mas, classes => [ 'Text.Markup', 'sprintf', 'jqueryui'] &>

<div id="hide1" style="display:none;">
<& /page/page_title.mas, title=>"VIGS Tool Results", id=>"title" &>
</div>


<span id="no_results" style="color:red;"></span>


<div id="img_height" style="display:none;" value="601"></div>

<table id="hide2" style="display:none;">
  <tr>
    <td id="score_p" style="text-align:'right';">
    </td>
  </tr>
</table>
<br />
<table id="hide3" style="display:none;">
  <tr>
    <td>
        Region Start: 
    </td>
    <td>
        <input type="text" id="cbr_start" size="3"> 
    </td>
    <td>
        Region End: 
    </td>
    <td>
        <input type="text" id="cbr_end" size="3""> &nbsp;
    </td>
    <td>
        <button type="button" value="set custom best region" onClick="getCustomRegion()">Set Custom Region</button><br />
    </td>
  </tr>
  <tr>
    <td>
      Target genes: 
    </td>
    <td>
      <input id="t_num" size="1" name="targets" min="1" />
    </td>
    <td>
      Fragment size:
    </td>
    <td>
      <input id="f_size" size="3" name="seq_fragment" />
    </td>
    <td>
      n-mer: <input id="n_mer" size="2" name="si_rna" />
      Missmatches: <input id="align_mm" size="1" name="align_mm" />
    </td>
    <td>
      <button type="button" value="recalculate" onClick="changeTargets()">Change</button>
    </td>
  </tr>
</table>

<p style="color:red" id="cbr_p"></p>


<div id="hide4" style="display:none;">

<&| /page/info_section.mas, title=>"Distribution of f_size -mers", collapsible => 1, collapsed => 0  &>
    <div class="seq_map" id="seq_map">
         <div class="region_square" id="region_square" onmouseup="getSquareCoords()"></div>
     	 <canvas id="myCanvas" width="700" height="600">
     	     Your browser does not support the HTML5 canvas
     	 </canvas>
    </div>
    <br />
    <button id="collapse" type="button" value="1" onClick="activateCollapse()">Expand Graph</button>
    <button id="zoom" type="button" value="0" onClick="activateZoom()">Zoom In</button>
    <button onClick="openWin()">Parameters and Help</button>
</&>

</div>

<div id="tabs" style="display:none;">
    <ul>
	<li><a href="#tabs-1">Parameter used</a></li>
	<li><a href="#tabs-2">Help</a></li>
    </ul>
    <div id="tabs-1">
 	<p>
	    &bull;<b>Fragment size: </b><span id="help_fsize"></span><br />
	    &nbsp;&bull;<b>n-mer: </b><span id="help_nmer"></span><br />
	    &bull;<b>Miss-matches: </b><span id="help_mm"></span><br />
	    &bull;<b>Database: </b><span id="help_db"></span>&nbsp;
	</p>
    </div>
    <div id="tabs-2">
        <p>
	    Targets are shown in blue, off-targets in red, the yellow area highlights the seq_fragment bp region of highest score.
	</p>
	<p>
    	    In the bottom is shown the score graph. Score value = 0 is represented by the green line, under this line are represented the region with more off-targets than targets, and the opposite when the score is over the green line.
        </p>
	<p>
	    Dragging or resizing the transparent grey rectangle will select a custom region.
	</p>
    </div>
</div>


<div id="hide5" style="display:none;">

<&| /page/info_section.mas, title=>"Best region", collapsible => 1, collapsed => 0 &>
    <div id="br_seq">
    	 <p id="best_seq" style="font-family:courier;font-size:16px;"></p>
    </div>
</&>


<&| /page/info_section.mas, title=>"Sequence overview", collapsible => 1, collapsed => 0 &>
    <span id="query" style="display:none"></span>
    <div id="markup" style="align:left;"></div>
</&>


<&| /page/info_section.mas, title=>"Sequences with matches of f_size -mers", collapsible => 1, collapsed => 0 &>
    <p id="target_info"></p>
</&>

</div>






<!-- STYLE -->

<style>
.seq_map {
    color: #777777;
    width: 700px;
    position:relative;
    overflow: auto;
    align: left;
}

.ui-dialog {
    position:relative;
}

#region_square {
    position:absolute;
    vertical-align:middle;
}

</style>


<!-- javascript-->

<script src="/js/tools/vigs.js" type="text/javascript"></script>
<script src="/js/jquery/iframe-post-form.js" type="text/javascript"></script>



<script defer="defer">

    var bt2_res;
    var db;
    var db_name;
    var mm;
    var f_length;
    var si_rna;
    var ids;
    var m_aoa;
    var score_array;
    var expr_msg;
    var expr_file;
    var query_seq="";
    var seq_length=1;
    var best_start=1;
    var best_end=2;
    var best_seq;
    var best_score;
    var coverage=0;


    jQuery(document).ready(function () {

        jQuery('#upload_expression_file').click(function () {
	    var expr_f = jQuery('#expression_file').val();
	    if (expr_f === '') {
		si_rna = jQuery("#si_rna").val();
		runBt2(si_rna);	        
	    } else {
                jQuery("#upload_expression_form").submit();
	    }
        });

    	jQuery('#upload_expression_form').iframePostForm({
	    json: true,
	    post: function () {
    	    },
            complete: function (response) {
                if (response.error) {
	            alert(response.error);
		    return;
            	}
            	if (response.success) {
	            //alert("File uploaded successfully");
        	    expr_file = response.expr_file;
		    si_rna = jQuery("#si_rna").val();
		    runBt2(si_rna);
                }
    	    }
        });

    });

</script>


