
<%args>
</%args>

<& /util/import_javascript.mas, classes => [ 'jquery', 'jquery.dataTables', 'jquery.dataTables-buttons-min', 'jszip-min', 'buttons.bootstrap-min', 'buttons.html5-min' ],  &>

<&| /page/info_section.mas, title=>'Query Sequence Metadata', is_subsection=>1, collapsible=>1, collapsed=>0, subtitle=>'View and download sequence metadata' &>

    <p>Filter the sequence metadata by feature, start, and end position and optionally by the sequence metadata type and/or protocol.</p>

    <br />

    <form class="form-horizontal" id="sequence_metadata_filter_form" name="sequence_metadata_filter_form">

        <h4>Query Range</h4>
        
        <!-- Feature -->
        <div class="form-group">
            <label class="col-sm-2 control-label">Feature: </label>
            <div class="col-sm-10">
                <select class="form-control" id="sequence_metadata_filter_feature" disabled>
                    <option value="">Loading...</option>
                </select>
            </div>
        </div>

        <!-- Start / End -->
        <div class="form-group">
            <label class="col-sm-2 control-label">Start: </label>
            <div class="col-sm-4">
                <input class="form-control" id="sequence_metadata_filter_start" type="text" value="">
            </div>
            <label class="col-sm-2 control-label">End: </label>
            <div class="col-sm-4">
                <input class="form-control" id="sequence_metadata_filter_end" type="text" value="">
            </div>
        </div>

        <h4>Optional Filters</h4>

        <!-- Data Type -->
        <div class="form-group">
            <label class="col-sm-2 control-label">Type: </label>
            <div class="col-sm-10">
                <select class="form-control" id="sequence_metadata_filter_type" multiple disabled>
                    <option value="">Loading...</option>
                </select>
            </div>
        </div>
        <div class="col-sm-2"></div>
        <div class="col-sm-10">
            <p><a id="sequence_metadata_filter_type_info_btn" href="#"><span class="glyphicon glyphicon-question-sign"></span>&nbsp;Data Type Info</a></p>
            <div id="sequence_metadata_filter_type_info" class="" style="display:none">
                <p>Loading...</p>
            </div>
        </div>
        <br /><br />

        <!-- Protocol -->
        <div class="form-group">
            <label class="col-sm-2 control-label">Protocol: </label>
            <div class="col-sm-10">
                <select class="form-control" id="sequence_metadata_filter_protocol" multiple disabled>
                    <option value="">Loading...</option>
                </select>
            </div>
        </div>
        <div class="col-sm-2"></div>
        <div class="col-sm-10">
            <p><a id="sequence_metadata_filter_protocol_info_btn" href="#"><span class="glyphicon glyphicon-question-sign"></span>&nbsp;Protocol Info</a></p>
            <div id="sequence_metadata_filter_protocol_info" class="" style="display:none">
                <p>Loading...</p>
            </div>
        </div>
        <br /><br />

        <!-- Score Min / Max -->
        <div class="form-group">
            <label class="col-sm-2 control-label">Score Min: </label>
            <div class="col-sm-4">
                <input class="form-control" id="sequence_metadata_filter_score_min" type="text" value="">
            </div>
            <label class="col-sm-2 control-label">Score Max: </label>
            <div class="col-sm-4">
                <input class="form-control" id="sequence_metadata_filter_score_max" type="text" value="">
            </div>
        </div>
        <br /><br />
        

        <!-- QUERY -->
        <div class="center">
            <button id="sequence_metadata_filter_query" class="btn btn-primary">Query</button>
        </div>
        <br /><br /><br />


    </form>

    <br />

    <!-- Error Message -->
    <div id="sequence_metadata_filter_error" class="alert alert-danger" role="alert" style="display:none"></div>

    <br />

    <!-- Query Results -->
    <table id="sequence_metadata_filter_results" class="display"></table>

</&>


<script type="text/javascript">

var data_types = [];
var protocols = [];

jQuery(document).ready(function() {

    // Get the filter features, types, and protocols
    get_features();
    get_types();
    get_protocols();

    // Toggle info boxes
    jQuery('#sequence_metadata_filter_type_info_btn').click(function() {
        jQuery('#sequence_metadata_filter_type_info').toggle();
        return false;
    });
    jQuery('#sequence_metadata_filter_protocol_info_btn').click(function() {
        jQuery('#sequence_metadata_filter_protocol_info').toggle();
        return false;
    });

    // Type and Protocol Change Listeners
    jQuery('#sequence_metadata_filter_type').change(set_protocols);
    jQuery('#sequence_metadata_filter_protocol').change(set_types);

    // Query Data
    jQuery('#sequence_metadata_filter_query').click(query);

    // Init DataTable
    jQuery('#sequence_metadata_filter_results').DataTable({
        dom: 'Bfrtip',
        autoWidth: false,
        data: [],
        columns: [
            { title: "Type", data: "type_name" },
            { title: "Protocol", data: "nd_protocol_name" },
            { title: "Feature", data: "feature_name" },
            { title: "Start", data: "start" },
            { title: "End", data: "end" },
            { title: "Score", data: "score" },
            { 
                title: "Attributes", 
                data: "attributes", 
                render: function(data, type, row) {
                    let rtn = [];
                    let sep = type === 'export' ? ';' : '<br />';
                    if ( data ) {
                        var keys = Object.keys(data);
                        keys.sort();
                        for ( var i=0; i<keys.length; ++i ) {
                            let key = keys[i];
                            let value = data[keys[i]];
                            if ( type === 'export' ) {
                                rtn.push(key + '=' + value);
                            }
                            else {
                                rtn.push("<strong>" + key + ":</strong>&nbsp;" + value);
                            }
                        }
                    }
                    return rtn.join(sep);
                } 
            }
        ],
        buttons: [
            {
                extend: 'excelHtml5',
                title: 'sequence_metadata_results',
                exportOptions: {
                    orthogonal: 'export'
                }
            },
            {
                extend: 'csvHtml5',
                title: 'sequence_metadata_results',
                exportOptions: {
                    orthogonal: 'export'
                }
            },
            {
                text: 'JSON',
                action: function() {
                    download(getQueryURL(), "sequence_metadata.json");
                }
            },
            {
                text: 'GFF',
                action: function ( e, dt, button, config ) {
                    download(getQueryURL("gff"), "sequence_metadata.gff");
                }
            },
            {
                text: "<span class='glyphicon glyphicon-new-window'></span>&nbsp;JBrowse",
                action: function() {
                    let url = getQueryURL("gff");
                    window.open(url, "_blank");
                }
            }
        ],
    });

});


/**
 * Get the features associated with stored sequence metadata
 * - populate the options for the feature select box
 */
function get_features() {
    jQuery.ajax({
        type: 'GET',
        dataType: 'json',
        url: '/ajax/sequence_metadata/features',
        success: function(data) {
            if ( data && data.features ) {
                let options = "";
                for ( let i = 0; i < data.features.length; i++ ) {
                    let f_id = data.features[i].feature_id;
                    let f_name = data.features[i].feature_name;
                    let o_name = data.features[i].organism_name;
                    let f_label = f_name + " (" + o_name + ")";
                    options += "<option value='" + f_id + "'>" + f_label + "</option>";
                }
                jQuery('#sequence_metadata_filter_feature').html(options);
                jQuery('#sequence_metadata_filter_feature').prop('disabled', false);
            }
            else {
                alert("ERROR: Could not load features!");
            }
        },
        error: function() {
         alert("ERROR: Could not load features");
        }
    });
}

/**
 * Get the types associated with stored sequence metadata
 * - populate the options for the type select box
 */
function get_types() {
    jQuery.ajax({
        type: 'GET',
        dataType: 'json',
        url: '/ajax/sequence_metadata/types',
        success: function(data) {
            if ( data && data.types ) {
                data_types = data.types;
                
                // Set Select Options
                set_types();

                // Build Info Table
                let info = "<table class='table table-striped'><thead><tr><th>Data Type</th><th>Definition</th></tr></thead>";
                info += "<tbody>";
                for ( let i = 0; i < data.types.length; i++ ) {
                    info += "<tr><td>" + data.types[i].type_name + "</td><td>" + data.types[i].type_definition + "</td></tr>";
                }
                info += "</tbody>";
                info += "</table>";
                jQuery('#sequence_metadata_filter_type_info').html(info);

            }
            else {
                alert("ERROR: Could not load types!");
            }
        },
        error: function() {
         alert("ERROR: Could not load types");
        }
    });
}

/**
 * Set the options for the Data Types select box
 */
function set_types() {
    let sel_types = jQuery('#sequence_metadata_filter_type').val();
    let sel_protocols = jQuery('#sequence_metadata_filter_protocol').val();

    let options = "";
    for ( let i = 0; i < data_types.length; i++ ) {
        let t_id = data_types[i].type_id;
        let t_name = data_types[i].type_name;

        // Reselect previosuly selected items
        let selected = false;
        if ( sel_types ) {
            for ( let j = 0; j < sel_types.length; j++ ) {
                if ( parseInt(sel_types[j]) === parseInt(t_id) ) {
                    selected = true;
                }
            }
        }

        // Disable data types based on selected protocols
        let disabled = false;
        if ( sel_protocols && sel_protocols.length > 0 ) {
            disabled = true;
            for ( let j = 0; j < protocols.length; j++ ) {
                for ( let k = 0; k < sel_protocols.length; k++ ) {
                    if ( parseInt(protocols[j].nd_protocol_id) === parseInt(sel_protocols[k]) ) {
                        if ( parseInt(protocols[j].nd_protocol_properties.sequence_metadata_type_id) === parseInt(t_id) ) {
                            disabled = false;
                        }
                    }
                }
            }
        }
        let d = disabled ? 'disabled' : '';
        let s = disabled ? '' : selected ? 'selected' : '';
        options += "<option value='" + t_id + "' " + d + " " + s + ">" + t_name + "</option>";
    }

    jQuery('#sequence_metadata_filter_type').html(options);
    jQuery('#sequence_metadata_filter_type').prop('disabled', false);
}

/**
 * Get the protocols associated with stored sequence metadata
 * - populate the options for the protocol select box
 */
function get_protocols() {
    jQuery.ajax({
        type: 'GET',
        dataType: 'json',
        url: '/ajax/sequence_metadata/protocols',
        success: function(data) {
            if ( data && data.protocols ) {
                protocols = data.protocols;

                // Set Select Options
                set_protocols();

                // Build Info Table
                let info = "<table class='table table-striped'><thead><tr><th>Protocol</th><th>Description</th><th>Properties</th></tr></thead>";
                info += "<tbody>";
                for ( let i = 0; i < data.protocols.length; i++ ) {
                    let props = "<strong>Data Type:</strong>&nbsp;" + data.protocols[i].nd_protocol_properties.sequence_metadata_type + "<br />";
                    props += "<strong>Reference Genome:</strong>&nbsp;" + data.protocols[i].nd_protocol_properties.reference_genome + "<br />";
                    props += "<strong>Score:</strong>&nbsp;" + data.protocols[i].nd_protocol_properties.score_description + "<br />";
                    props += "<strong>Attributes:</strong><br />";
                    let attributes = [];
                    var keys = Object.keys(data.protocols[i].nd_protocol_properties.attribute_descriptions);
                    keys.sort();
                    for ( let j = 0; j < keys.length; j++ ) {
                        let key = keys[j];
                        let description = data.protocols[i].nd_protocol_properties.attribute_descriptions[key];
                        attributes.push("&nbsp;&nbsp;<strong>" + key + ":</strong>&nbsp;" + description);
                    }
                    props += attributes.join('<br />');

                    info += "<tr>";
                    info += "<td>" + data.protocols[i].nd_protocol_name + "</td>";
                    info += "<td>" + data.protocols[i].nd_protocol_description + "</td>";
                    info += "<td>" + props + "</td>";
                    info += "</tr>";
                }
                info += "</tbody>";
                info += "</table>";
                jQuery('#sequence_metadata_filter_protocol_info').html(info);

            }
            else {
                alert("ERROR: Could not load protocols!");
            }
        },
        error: function() {
         alert("ERROR: Could not load protocols");
        }
    });
}


/**
 * Set the options for the Protocol select box
 */
function set_protocols() {
    let sel_protocols = jQuery('#sequence_metadata_filter_protocol').val();
    let sel_types = jQuery('#sequence_metadata_filter_type').val();

    let options = "";
    for ( let i = 0; i < protocols.length; i++ ) {
        let p_id = protocols[i].nd_protocol_id;
        let p_name = protocols[i].nd_protocol_name;
        let p_type_id = protocols[i].nd_protocol_properties.sequence_metadata_type_id;
        
        // Reselect previosuly selected items
        let selected = false;
        if ( sel_protocols ) {
            for ( let j = 0; j < sel_protocols.length; j++ ) {
                if ( parseInt(sel_protocols[j]) === parseInt(p_id) ) {
                    selected = true;
                }
            }
        }

        // Disable protocols based on selected data types
        let disabled = false;
        if ( sel_types && sel_types.length > 0 ) {
            disabled = true;
            for ( let j = 0; j < data_types.length; j++ ) {
                for ( let k = 0; k < sel_types.length; k++ ) {
                    if ( parseInt(data_types[j].type_id) === parseInt(sel_types[k]) ) {
                        if ( parseInt(data_types[j].type_id) === parseInt(p_type_id) ) {
                            disabled = false;
                        }
                    }
                }
            }
        }
        let d = disabled ? 'disabled' : '';
        let s = disabled ? '' : selected ? 'selected' : '';
        options += "<option value='" + p_id + "' " + d + " " + s + ">" + p_name + "</option>";
    }

    jQuery('#sequence_metadata_filter_protocol').html(options);
    jQuery('#sequence_metadata_filter_protocol').prop('disabled', false);
}


/**
 * Build the Query URL using the current filter properties
 * @param {string} [format] Output format (default: JSON)
 * @returns {string} relative URL to query endpoint
 */
function getQueryURL(format="JSON") {
    let feature_id = jQuery('#sequence_metadata_filter_feature option:selected').val();
    let start = jQuery('#sequence_metadata_filter_start').val();
    let end = jQuery('#sequence_metadata_filter_end').val();
    let type_id = jQuery('#sequence_metadata_filter_type').val();
    let nd_protocol_id = jQuery('#sequence_metadata_filter_protocol').val();
    let score_min = jQuery('#sequence_metadata_filter_score_min').val();
    let score_max = jQuery('#sequence_metadata_filter_score_max').val();

    let params = {
        feature_id: feature_id,
        format: format
    }
    if ( start && start !== '' ) params.start = start;
    if ( end && end !== '' ) params.end = end;
    if ( type_id && type_id !== '' ) params.type_id = type_id;
    if ( nd_protocol_id && nd_protocol_id !== '' ) params.nd_protocol_id = nd_protocol_id;
    if ( score_min && score_min !== '' ) params.score_min = score_min;
    if ( score_max && score_max !== '' ) params.score_max = score_max;

    let q = new URLSearchParams(params).toString();
    let url = '/ajax/sequence_metadata/query?' + q;

    return url;
}


/**
 * Perform a sequence metadata query
 * - Required filter params: feature_id, start, end
 * - Optional filter params: type_id, nd_protocol_id
 * - Get the query results and send to handle_query_results to parse
 */
function query() {
    hide_error();
    jQuery('#sequence_metadata_filter_query').html('Querying...');
    jQuery('#sequence_metadata_filter_query').attr('disabled', true);

    jQuery.ajax({
        type: 'GET',
        url: getQueryURL(),
        dataType: 'json',
        success: handle_query_results,
        error: function() {
            alert("ERROR: Could query database!");
            jQuery('#sequence_metadata_filter_query').html('Query');
            jQuery('#sequence_metadata_filter_query').attr('disabled', false);
        }
    });

    return false;
}


/**
 * Parse the query results
 * - Update the rows in the DataTable
 * @param {Object} response         JSON response from the query endpoint
 *                 response.error   message of error encountered by server
 *                 response.results array of sequence metadata objects
 */
function handle_query_results(response) {
    jQuery('#sequence_metadata_filter_query').html('Query');
    jQuery('#sequence_metadata_filter_query').attr('disabled', false);

    let dt = jQuery('#sequence_metadata_filter_results').DataTable();
    dt.clear();
    if ( response && response.error ) {
        display_error(response.error);
    }
    else if ( response && response.results && response.results.length > 0) {
        dt.rows.add(response.results);
    }
    else {
        display_error("No results found - try modifying your filter criteria");
    }
    dt.draw();
}





/**
 * Display an error message
 * @param {string} message The message to display (undefined to clear the message)
 */
function display_error(message) {
    jQuery('#sequence_metadata_filter_error').html(message ? message : "");
    jQuery('#sequence_metadata_filter_error').css('display', message ? 'block' : 'none');
}

/**
 * Clear and hide the error message alert box
 */
function hide_error() {
    display_error();
}

/**
 * Prompt a download of the specified url with the given file name
 * @param {String} url URL to download
 * @param {String} name Name to give the downloaded file
 */
function download(url, name) {
    var a = document.createElement('a');
    a.href = url;
    a.download = name;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

</script>


<style>
    select[multiple] option:disabled {
        font-weight: 200;
        font-style: italic;
        color: #DCDCDC;
    }
</style>
