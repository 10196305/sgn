<div id="pagetitle"><h3>An Example Workflow</h3></div>

<&| /util/workflow.mas &>
  <&| /util/workflow.mas:step, title=>"Step A" &>
    Step 0 <br/>
    <button type="button" class="btn btn-default" onclick="Workflow.complete(this);">Complete</button>
  </&>
  <&| /util/workflow.mas:step, title=>"Step B" &>
    Step 1 <br/>
    <button type="button" class="btn btn-default" onclick="Workflow.complete(this);">Complete</button>
    <button type="button" class="btn btn-default" onclick="Workflow.skip(this);">Skip</button>
    <button type="button" class="btn btn-default" onclick="Workflow.pending(this);">Pending</button>
  </&>
  <&| /util/workflow.mas:step, title=>"Step C" &>
    Step 2 <br/>
    <button type="button" class="btn btn-default" onclick="Workflow.complete(this);">Complete</button>
  </&>
  <&| /util/workflow.mas:step, title=>"Step D" &>
    Step 3 <br/>
    <button type="button" class="btn btn-default" onclick="Workflow.complete(this);">Complete</button>
  </&>
  <&| /util/workflow.mas:step, title=>"Step E" &>
    Step 4 <br/>
    <button type="button" class="btn btn-default" onclick="Workflow.complete(this);">Complete</button>
  </&>
</&>

<script type="text/javascript">
  
  var Workflow = {
    
    "init": function(){
      //add onclick to workflow progress markers
      var prog_steps = document.querySelectorAll('.workflow-prog>li');
      prog_steps.forEach(function(ele,i){
        ele.onclick = Workflow.prog_click(i);
      });
      document.querySelectorAll('.workflow').forEach(function(wf){
        Workflow.focus(wf,0);
      });
    },
    
    "prog_click": function(step_index){
      //on progress marker click, change the focus to show that page
      function click(){
        var wf = this;
        while (!wf.classList.contains('workflow')){
          wf = wf.parentNode;
        }
        
        //if the previous workflows have not been complete, do not do anything!
        if (!this.classList.contains('workflow-complete') 
            && this!==wf.querySelector('.workflow-prog>li:not(.workflow-complete)')){
          return;
        }
        
        Workflow.focus(wf,step_index);
      }
      return click
    },
    
    "focus":function(wf,step_index){
      function change_focus(ele,i){
        if (i==step_index){
          ele.classList.add('workflow-focus');
        } else {
          ele.classList.remove('workflow-focus');
        }
        
      }
      wf.querySelectorAll('.workflow-prog>li').forEach(change_focus);
      wf.querySelectorAll('.workflow-content>li').forEach(change_focus);
    },
    
    "complete":function(wf_child,status){
      var wf = wf_child;
      var content_li = wf_child;
      while (!wf.classList.contains('workflow')){
        if(wf.parentNode.classList.contains('workflow-content')){
          content_li = wf;
        }
        wf = wf.parentNode;
      }
      var step_index = Array.prototype.indexOf.call(wf.querySelectorAll('.workflow-content>li'),content_li);
      var prog = wf.querySelectorAll('.workflow-prog>li')[step_index];
      content_li.classList.add('workflow-complete');
      prog.classList.add('workflow-complete');
      content_li.classList.remove('workflow-skipped');
      prog.classList.remove('workflow-skipped');
      content_li.classList.remove('workflow-pending');
      prog.classList.remove('workflow-pending');
      if (status=="skipped"){
        content_li.classList.add('workflow-skipped');
        prog.classList.add('workflow-skipped');
        
      }
      if (status=="pending"){
        content_li.classList.add('workflow-pending');
        prog.classList.add('workflow-pending');
        
      }
      Workflow.focus(wf,step_index+1);
    },
    
    "skip":function(wf_child){
      Workflow.complete(wf_child,"skipped");
    },
    
    "pending":function(wf_child){
      Workflow.complete(wf_child,"pending");
    }
    
  }
  Workflow.init();
  
</script>
