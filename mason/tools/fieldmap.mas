<%args> 
</%args>

<& '/page/page_title.mas', title => "Fieldmap app" &>

<& /util/import_css.mas, paths => ['fieldmap/leaflet-search.min.css', 'fieldmap/leaflet.css'] &>

<& '/util/import_javascript.mas', 
 classes => ['jquery','d3.d3v4Min', 'brapi.fieldmap.leaflet', 'brapi.fieldmap.L-Path-Transform', 'brapi.fieldmap.leaflet-search', 'brapi.fieldmap.turf', 'brapi.BrAPI', 'brapi.BrAPIFieldmap']
&>


<style media="screen">
 .groupBy-div:only-of-type .groupBy-remove{
   display: none;
 }
 .boxplot .infotext{
   opacity: 0;
 }
 .boxplot:hover .infotext{
   opacity: 1;
 }
 #bxplt_result::-webkit-scrollbar {
   -webkit-appearance: none;
   width: 7px;
 }
 #bxplt_result::-webkit-scrollbar-thumb {
     border-radius: 4px;
     background-color: rgba(0,0,0,.5);
     -webkit-box-shadow: 0 0 1px rgba(255,255,255,.5);
 }
 #mainform>div>*, .groupBy-div:not(:first-of-type){
   margin-top: 1em;
   margin-bottom: 0;
 }
</style>

<div class="row">
  <center class = "col-md-offset-2 col-md-8">
      <div class="col-sm-12 col-md-12 col-lg-12">
          <label for="select_trial_for_selection_index">Select trial: </label>
          <select class="form-control" autofocus="autofocus" id="select_trial_for_selection_index"></select>
      </div><br>
  </center>
</div>

 <div>Select an area over the field to load the plots. Plot size will be determined based on this area and the plot layout</div>
 <div>(Optional) override plot size (meters):</div>
<form class="form-inline" style="padding:10px;" id="formwidth">
 <div class="form-group">
   <label for="width">width</label>
   <input type="text" class="form-control" id="width" value="">
 </div>
 <div class="form-group">
   <label for="length">length</label>
   <input type="text" class="form-control" id="length" value="">
 </div>
</form>
<form class="form-inline" style="padding:10px;">
  <a class="btn btn-default" onclick="load()">Load plots</a>
 <a class="btn btn-default" onclick="update()">Save Geo coordinates</a>
</form>
<div id="map" style="width: 980px; height: 600px"></div>

<script>

    jQuery(document).ready(function() {
        jQuery('#ranking_formula').html("<center><i>Select a trial, then pick traits and weights (or load a saved formula).</i></center>");
        get_select_box('trials', 'select_trial_for_selection_index', { 'name' : 'html_select_trial_for_selection_index', 'id' : 'html_select_trial_for_selection_index' , 'empty' : 1 });
        jQuery('#select_trial_for_selection_index').change(load);
    });

    document.getElementById("formwidth").style.display="none";

    var brapi_endpoint = "http://192.168.33.11:3010/brapi/v2";
    var auth_token;
    var require_login = "<%  $c->get_conf('brapi_require_login') %>";
    if (require_login === '1'){
        auth_token = "<%  CXGN::Login->new($c->dbc->dbh)->get_login_cookie() %>";
        if (!auth_token){
            alert("Login required to display pedigree");
        }
    }

    console.log(auth_token);
    function setupBrAPI() {
        fieldMap.brapi_endpoint = brapi_endpoint;
        fieldMap.opts.plotLength = d3.select('#length').node().value;
        fieldMap.opts.plotWidth = d3.select('#width').node().value;
        fieldMap.opts.brapi_pageSize = 100;
        fieldMap.opts.brapi_auth = auth_token;
    }

    function load() {
        var studyDbId = $('#select_trial_for_selection_index').val();
        setupBrAPI();
        fieldMap.load(studyDbId).then((value)=>{if (!value) return setLocation(studyDbId); });
    }

    function setLocation() {
        var studyDbId = $('#select_trial_for_selection_index').val();
        fieldMap.setLocation(studyDbId).then(()=>alert("Please select the area and click Load plots"), ()=>console.log("No location!"));
    }
    
    function update() {
        setupBrAPI();
        fieldMap.update().then((resp)=>alert(resp), (resp)=>alert(resp));
    }

    var fieldMap = new BrAPIFieldmap("#map",brapi_endpoint);
</script>