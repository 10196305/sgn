<%doc>
  NAME: basic_info.mas
  VERSION: 1.0
  DESCRIPTION: This is a mason code get the unigene data from the database and show it as table web_page; 
  AUTHOR: Aureliano Bombarely (ab782@cornell.edu)
</%doc>


<%perl>
use strict;
use warnings;

use SGN::Schema;
use CXGN::DB::DBICFactory;
use CXGN::Transcript::Unigene;
use CXGN::Chado::Dbxref;
use Bio::Chado::Schema;
use CXGN::Page::FormattingHelpers  qw/ info_section_html info_table_html columnar_table_html page_title_html html_break_string /;

my $basic_info_content;
my $accession;

## If there aren't any unigene that comes from unigene_detail.mas, it will return a message.

if (defined $ARGS{'unigene'}) {

   my $unigene = $ARGS{'unigene'};
   my $schema = $ARGS{'schema'};

   my $bio_chado_schema = CXGN::DB::DBICFactory->open_schema( 'Bio::Chado::Schema', search_path => ['public'] );

   ## Get the object
   my $id =  $unigene->get_unigene_id();
   $accession = $unigene->get_sgn_id();
  
   my $unigene_build = $unigene->get_unigene_build();
   my $build_name = $unigene_build->get_organism_group_name();
   my $build_id = $unigene_build->get_unigene_build_id();
   my $build_nr = $unigene_build->get_build_nr();
   my $unigene_build_name = $build_name." #".$build_nr;
   my $unigene_build_name_html = "<a href=/search/unigene_build.pl?id=$build_id>$unigene_build_name</a>";
   my $build_date = $unigene_build->get_build_date();

   my $member_nr = $unigene->get_nr_members();

   my @organism_html_list;
   my $organism_group_id = $unigene_build->get_organism_group_id();
   my $group_linkage_rs = $schema->resultset('GroupLinkage')->search({ group_id => $organism_group_id });
   my @organism_ids = $group_linkage_rs->get_column('member_id')->all();
   foreach my $organism_id (@organism_ids) {
       if ($organism_id =~ m/^\d+$/) {
	   my $organism_rs = $bio_chado_schema->resultset('Organism::Organism')->search({ sgn_organism_id => $organism_id });
	   if (defined $organism_rs) {
	       my @organism_name = $organism_rs->get_column('abbreviation')->all();   
	       if (defined $organism_name[0]) {
		   my $organism_link = '/chado/organism.pl?organism_id='.$organism_id;
		   my $organism_html = "<a href=$organism_link>$organism_name[0]</a>";
		   push @organism_html_list, $organism_html;
	       }
	   } else {
	       push @organism_html_list, '<font color="gray"><i>none</i></font>';
	   }
       }
   }
   my $organism_html_list = join('<br>', @organism_html_list);


  my $unigene_alternate_id = $unigene->get_alternate_identifier() || '<font color=gray><i>none</i></font>';
  my $seq = $unigene->get_sequence();
  my $seq_length = length($seq);
  my $seq_html = uc(html_break_string($seq, 90));

   ## Create the HTML table

   $basic_info_content = <<HTML;

    <table width="100%">
    	   <tr> <td width="25%"> <b>Unigene ID: </b>      </td> <td> $accession </td></tr>
	   <tr> <td width="25%"> <b>Unigene Build: </b>   </td> <td> $unigene_build_name_html </td></tr>
	   <tr> <td width="25%"> <b>Date: </b>            </td> <td> $build_date </td></tr>
           <tr> <td width="25%"> <b>Organism: </b>        </td> <td> $organism_html_list </td><td>
	   <tr> <td width="25%"> <b>Alternative ID:</b>   </td> <td> $unigene_alternate_id </td><td>
	   <tr> <td width="25%"> <b>mRNA sequence:</b>         </td> <td> Length: $seq_length bp </td><td>
   </table>
   
   <br>
   >$accession $unigene_build_name ($member_nr members)<br>
   <font style="font-family: monospace"> $seq_html</font>

HTML

} else {
   $basic_info_content = "<big>There aren't any unigene data for the specified parameters.</big>";
}   

my $basic_info_html;
if (defined $accession) {
   $basic_info_html = "<center><big><b>Unigene $accession</b></big></center><br>";
}
$basic_info_html .= info_section_html( title => "Unigene Basic Information", contents => $basic_info_content );

</%perl>

<% $basic_info_html %>
