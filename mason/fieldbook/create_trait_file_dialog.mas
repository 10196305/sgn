<%args>
</%args>

<div class="modal fade" id="create_trait_file_dialog" name="create_trait_file_dialog" tabindex="-1" role="dialog" aria-labelledby="createTraitFileDialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <center><h4 class="modal-title" id="createTraitFileDialog">Create a Trait File for the Android Fieldbook App</h4></center>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
            <form class="form-horizontal" role="form" method="post" >
            <div class="form-group">
              <label class="col-sm-3 control-label" for="select_list_list_select">Select a list of traits: </label>
              <div class="col-sm-9">
                <span id="select_list_div"></span>
              </div>
            </div>
            <div class="form-group">
              <label class="col-sm-3 control-label" for="select_traits_for_trait_file">Or select traits directly: </label>
              <div class="col-sm-9">
                <div id="select_traits_for_trait_file">
                  [Loading...]
                </div>
                <hr style="margin-top:4px;margin-bottom:4px" />
                <div class="well well-sm"><div id="trait_select_count">No Selection</div></div>
              </div>
            </div>
            <div class="form-group">
              <label class="col-sm-3 control-label" for="trait_file_name">File name:</label>
              <div class="col-sm-9">
                <input id="trait_file_name" type="text" class="form-control" placeholder="Type name here">
              </div>
            </div>
          </form><br/>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" name="create_trait_file_cancel_button" id="create_trait_file_cancel_button" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" name="create_trait_file_ok_button" id="create_trait_file_ok_button" title="Submit">Submit</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="trait_file_saved_dialog_message" name="trait_file_saved_dialog_message" tabindex="-1" role="dialog" aria-labelledby="createTraitFileSavedDialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="createTraitFileSavedDialog">Trait File Created</h4>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
            <p>
              <span class="ui-icon ui-icon-circle-check" style="float: left; margin: 0 7px 50px 0;"></span>
              The trait file was created successfully.
            </p>
            <p>
              <a id="trait_file_download_link">Download File</a>
            </p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" name="trait_file_close_button" id="trait_file_close_button" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<script>

jQuery(document).ready(function() {
  var list = new CXGN.List();
  var trait_lists = list.listSelect('select_list', [ 'traits' ], 'Select a list');
  jQuery('#select_list_div').html(trait_lists);

  get_select_box('traits', 'select_traits_for_trait_file', { 'name' : 'html_select_traits_for_trait_file', 'id' : 'html_select_traits_for_trait_file' , 'empty' : 1 });

    jQuery('#create_new_trait_file_link').click( function () {
        console.log("create trait file link was clicked!");
        jQuery('#html_select_traits_for_trait_file').attr('size', 10);
        show_list_counts('trait_select_count', document.getElementById("html_select_traits_for_trait_file").length );
        jQuery('#html_select_traits_for_trait_file').change(
        function() {
          jQuery('#select_list_list_select').val('');
          var traits = document.getElementById("html_select_traits_for_trait_file").length; //jQuery('#html_select_traits_for_trait_file').text().split("\n").length-1;
          var selected = jQuery('#html_select_traits_for_trait_file').val();
    	    show_list_counts('trait_select_count', traits, selected.length );
    	  });
        jQuery('#create_trait_file_dialog').modal('show');
    });

    jQuery('#create_trait_file_ok_button').on('click', function() {
        generate_trait_file();
    });

});

function show_list_counts(count_div, total_count, selected) {
    var html = 'Traits: '+total_count+'<br />';
    if (selected) {
	html += 'Selected: '+selected;
    }
    jQuery('#'+count_div).html(html);
}

function generate_trait_file() {
  var trait_list_id = jQuery('#select_list_list_select').val();
  var trait_ids = [];
  var trait_list = [];

  if (trait_list_id) {
    trait_list = JSON.stringify(list.getList(trait_list_id));
    trait_ids = JSON.stringify(list.transform(trait_list_id, 'traits_2_trait_ids'));
  }
  else {
    trait_ids = JSON.stringify(jQuery('#html_select_traits_for_trait_file').val());
    var trait_names = [];
    jQuery("#html_select_traits_for_trait_file option:selected").each(
     function() {
      trait_names.push(jQuery(this).text());
     });
     trait_list = JSON.stringify(trait_names);
  }

  console.log("trait_ids ="+JSON.stringify(trait_ids));
  console.log("trait_list ="+JSON.stringify(trait_list));

  if (trait_ids == '')  {
    alert("Traits, from a list or selected individually, are required.");
    return;
  }

  var trait_file_name = jQuery('#trait_file_name').val();

  if (trait_file_name == '')  {
    alert("A trait file name is required.");
    return;
  }

jQuery.ajax({
  type: 'POST',
  url: '/ajax/fieldbook/traitfile/create',
  dataType: "json",
  data: {
            'trait_list': trait_list,
            'trait_ids': trait_ids,
            'trait_file_name': trait_file_name,
  },
  beforeSend: function() {
      jQuery("#working_modal").modal("show");
  },
  success: function (response) {
      jQuery("#working_modal").modal("hide");
      if (response.error) {
          alert(response.error);
      } else {
          jQuery('#trait_file_download_link').attr('href',"/fieldbook/trait_file_download/"+response.file_id);
          jQuery("#trait_file_saved_dialog_message").modal("show");
          jQuery('#create_trait_file_dialog').modal("hide");
      }
  },
  error: function () {
      jQuery("#working_modal").modal("hide");
      alert('An error occurred creating the trait file.');
      jQuery('#create_trait_file_dialog').modal("hide");
  },
    });
}

</script>
