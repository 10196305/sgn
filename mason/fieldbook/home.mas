
<%args>
@projects => undef
$user_id => undef
@layout_files => undef
@trait_files => undef
@roles => ()
</%args>

<& /util/import_javascript.mas, classes => [ 'jquery', 'jqueryui', 'jquery.iframe-post-form','CXGN.List',] &>

<& /page/page_title.mas, title=>'Field Book Tools' &>

<&| /page/info_section.mas, title=>'Field Layout Files', collapsible=>1, collapsed=>0, &>
<%perl>
foreach my $project_ref (@projects) {
   my @trial_array = @{$project_ref};
   my $file_name = $trial_array[4];
   my $trial_layout_download = '[<a href="\\fieldbook\\trial_download\\'.$trial_array[5].'">Download</a>]';
   print $trial_array[4]."$trial_layout_download</br>";
   #print $trial_array[4]."</br>";
}
</%perl>
</&>

<&| /page/info_section.mas, title=>'Trait Files', collapsible=>1, collapsed=>0, subtitle=>'[<a id="create_new_trait_file_link">New</a>]' &>
<%perl>
foreach my $trait_ref (@trait_files) {
   my @trait_array = @{$trait_ref};
   my $trait_file_name = $trait_array[0];
   my $trait_file_download = '[<a href="\\fieldbook\\trait_file_download\\'.$trait_array[1].'">Download</a>]';
   print $trait_array[0]."$trait_file_download</br>";
   #print $trial_array[4]."</br>";
}
</%perl>
</&>

<&| /page/info_section.mas, title=>'Uploaded Phenotype Files', collapsible=>1, collapsed=>0, subtitle=>'[<a id="upload_tablet_phenotype_file_link">Upload</a>]' &>
</&>

<div id="create_trait_file_dialog" class="ui-widget" title="Create Trait File">
  <form method="post" enctype="multipart/form-data" encoding="multipart/form-data" id="create_trait_file_form" name="create_trait_file_form">
    <div id="select_list" name="select_list" id="select_list">
      <label id="select_list_label" for="select_list_list_select" style="display: inline-block; width: 200px;">List of traits to include:
      </label>
    </div>
  </form>
</div>



<script defer="defer">

jQuery(document).ready(function () {

    var list = new CXGN.List();


    jQuery("#select_list").append(list.listSelect("select_list"));

    jQuery('#create_new_trait_file_link').click(function () {
        jQuery('#create_trait_file_dialog').dialog("open");
        //alert("something");
    });
    //function create_trait_file_dialog() {
    //  alert("something");
    //}
    jQuery( "#create_trait_file_dialog" ).dialog({
	autoOpen: false,
	modal: true,
	buttons: {
            Ok: function() {
                 generate_trait_file();
		jQuery( this ).dialog( "close" );
		location.reload();
            }
	}
    });

   function generate_trait_file() {
      var trait_list_id = jQuery('#select_list_list_select').val();
      var trait_list = JSON.stringify(list.getList(trait_list_id));

      new jQuery.ajax({
            type: 'POST',
            url: '/ajax/fieldbook/traitfile/create',
	    dataType: "json",
            data: {
                'trait_list': trait_list,
            },
            success: function (response) {
                if (response.error) {
                    alert(response.error);
                } else {
                    alert('The trait file was saved.');
                }
            },
            error: function () {
                alert('An error occurred. sorry');
            }
        });


   }

});

</script>






