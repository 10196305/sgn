
<%args>
@projects => undef
$programs => undef
@file_metadata => ()
$user_id => undef
@layout_files => undef
@trait_files => undef
@phenotype_files => undef
@removed_phenotype_files => undef
@roles => ()
</%args>

<& /util/import_javascript.mas, classes => [ 'jquery', 'jqueryui', 'jquery.iframe-post-form','CXGN.List','CXGN.BreedersToolbox.FieldBook', 'SGN.PhenotypeUpload'] &>

<& /page/page_title.mas, title=>'Field Book Tools' &>

<div class="container-fluid">

<&| /page/explanation.mas, title=>'Field Layout Files', collapsible=>1, collapsed=>0, &>
  <p>
    <em>Field Book</em> is an app for collecting phenotypic data on field research plots using an android tablet computer.</br>
    <a href="http://www.wheatgenetics.org/bioinformatics/22-android-field-book"> Field Book Software</a>
  </p>
</&>

<&| /page/info_section.mas, title=>'Field Layout Files', collapsible=>1, collapsed=>0, &>
<%perl>
my @breeding_programs = @{$programs};
foreach my $prog (@breeding_programs) {
  print @$prog[0].@$prog[1]."</br>";
}
foreach my $file (@file_metadata) {
   my @trial_array = @{$file};
   my $file_name = $trial_array[1];
   my $trial_layout_download = '[<a href="/fieldbook/trial_download/'.$trial_array[2].'">Download</a>]';
   print $trial_array[1]."$trial_layout_download<br>";
   #print $trial_array[2]."</br>";
}
</%perl>
</&>

<&| /page/info_section.mas, title=>'Trait Files', collapsible=>1, collapsed=>0, subtitle=>'[<a id="create_new_trait_file_link">New</a>]' &>
  <%perl>
  foreach my $trait_ref (@trait_files) {
    my @trait_array = @{$trait_ref};
    my $trait_file_name = $trait_array[0];
    my $trait_file_download = '[<a href="/fieldbook/trait_file_download/'.$trait_array[1].'">Download</a>]';
    print $trait_array[0]."$trait_file_download<br>";
    #print $trial_array[4]."</br>";
  }
  </%perl>
</&>

<&| /page/info_section.mas, title=>'Uploaded Phenotype Files', collapsible=>1, collapsed=>0, subtitle=>'[<a id="upload_tablet_phenotype_file_link">Upload</a>]' &>
  <%perl>
  foreach my $phenotype_ref (@phenotype_files) {
    my @phenotype_array = @{$phenotype_ref};
    my $phenotype_file_name = $phenotype_array[0];
    #my $phenotype_file_download = '[<a href="/fieldbook/trait_file_download/'.$trait_array[1].'">Download</a>]';
    #print $phenotype_array[0]."$trait_file_download<br>";
    print qq { $phenotype_array[0]  <a href="javascript:remove_phenotype_data($phenotype_array[1])"><b>X</b></a></br> };
  }
  </%perl>
</&>


<&| /page/info_section.mas, title=>'Removed Phenotype Files', collapsible=>1, collapsed=>1 &>
  <%perl>
  foreach my $phenotype_ref (@removed_phenotype_files) {
    my @phenotype_array = @{$phenotype_ref};
    my $phenotype_file_name = $phenotype_array[0];
    #my $phenotype_file_download = '[<a href="/fieldbook/trait_file_download/'.$trait_array[1].'">Download</a>]';
    #print $phenotype_array[0]."$trait_file_download<br>";
    print qq { $phenotype_array[0]  <button disabled="1" id="re-upload" >re-upload</button><br /> };
  }
  </%perl>
</&>

</div>

<div id="create_trait_file_dialog" class="ui-widget" title="Create Trait File">
  <form method="post" enctype="multipart/form-data" encoding="multipart/form-data" id="create_trait_file_form" name="create_trait_file_form">
    <label for="trait_file_name" style="display: inline-block; width: 200px;">Trait file name:</label>
    <input id="trait_file_name" name="trait_file_name" />
    <div id="select_list_container" name="select_list">
      <label id="select_list_label" for="select_list_list_select" style="display: inline-block; width: 200px;">List of traits to include:
      </label>
      <span id="select_list_div"></span>
    </div>
  </form>
</div>

<div class="modal fade" id="upload_fieldbook_phenotypes_dialog" name="upload_fieldbook_phenotypes_dialog" tabindex="-1" role="dialog" aria-labelledby="addFieldbookPhenotypeDialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="addFieldbookPhenotypeDialog">Upload Fieldbook File</h4>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
	  <form method="post" enctype="multipart/form-data" encoding="multipart/form-data" id="upload_phenotype_file_form" name="upload_phenotype_file_form">
	    <div class="form-group">
      	      <label class="col-sm-3 control-label">Fieldbook File: </label>
      	      <div class="col-sm-9" >
	        <input type="hidden" name="upload_phenotype_file_type" id="upload_phenotype_file_type" value="fieldbook" />
	        <input type="file" name="upload_phenotype_file_input" id="upload_phenotype_file_input" encoding="multipart/form-data" />
              </div>
	    </div>
	  </form><br/>
	  <div id="upload_phenotype_spreadsheet_verify_status"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-info" name="upload_phenotype_submit_verify" id="upload_phenotype_submit_verify">Verify</button>
	<button disabled type="button" class="btn btn-primary" name="upload_phenotype_submit_store" id="upload_phenotype_submit_store" title="First Verify Your File">Store</button>
      </div>
    </div>
  </div>
</div>


<script>

  function remove_phenotype_data(file_id) { 
    var yes = confirm("Do you really want to remove all data associated with this file (id="+file_id+")");
    jQuery.ajax( { 
      beforeSend: function() { jQuery('#working_modal').modal("show"); },
      url: '/breeders/trial/delete/file/'+file_id,
      success: function(response) { 
         jQuery('#working_modal').modal("hide");
         if (response.error) { 
           alert(response.error);
         }
         else { 
            alert("SUCCESS!");
            location.reload();
         }
      },
      error: function(response) { 
         jQuery('#working_modal').modal("hide");
         alert("An error occurred!");
      }
    });
  }
</script>
