
<%args>
$trial_id => undef
$trial_name => undef
</%args>


<div class="modal fade" id="create_fieldbook_dialog" name="create_fieldbook_dialog" tabindex="-1" role="dialog" aria-labelledby="createFieldbookDialog">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="createFieldbookDialog">Download Fieldbook for <% $trial_name %></h4>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
            <form class="form-horizontal" role="form" method="post" >
                <div class="form-group">
                    <label class="col-sm-3 control-label">Trial: </label>
                    <div class="col-sm-9" >
                        <div id="select_trial_for_create_fieldbook">
% if ($trial_id) {
                            <input type="text" class="form-control" value="<% $trial_name %>" disabled/>
                            <input type="hidden" id="html_select_trial_for_create_fieldbook" name="html_select_trial_for_create_fieldbook" value="<% $trial_id %>" />
% } else {
                    [Loading...]
% }
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label">Treatment: </label>
                    <div class="col-sm-9" >
                        <div id="create_fieldbook_treatment">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label">Data Level: </label>
                    <div class="col-sm-9" >
                        <select class="form-control" id="create_fieldbook_data_level">
                            <option value="plots">Plots</option>
                            <option value="plants">Plants</option>
                            <option value="subplots">Subplots</option>
                            <option value="plants_subplots">Plants and Subplots</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label">Included Columns: </label>
                    <div class="col-sm-9" >
                        <div id="create_fieldbook_included_columns">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label">Not Included Columns: </label>
                    <div class="col-sm-9" >
                        <div id="create_fieldbook_not_included_columns">
                        
                        </div>
                    </div>
                </div>

            </form><br/>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" name="create_fieldbook_cancel_button" id="create_fieldbook_cancel_button" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" name="create_fieldbook_ok_button" id="create_fieldbook_ok_button" title="Submit">Submit</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="tablet_field_layout_saved_dialog_message" name="tablet_field_layout_saved_dialog_message" tabindex="-1" role="dialog" aria-labelledby="createFieldbookSavedDialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="createFieldbookSavedDialog">Fieldbook for <% $trial_name %> Created</h4>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
            <p>
              <span class="ui-icon ui-icon-circle-check" style="float: left; margin: 0 7px 50px 0;"></span>
              The field book layout file was saved successfully
            </p>
            <p>
              <a id="tablet_layout_download_link">Go To Download File</a>
            </p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" name="create_fieldbook_cancel_button" id="create_fieldbook_cancel_button" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<script>

var selected_columns = {};
var not_selected_columns = {};

jQuery(document).ready(function() {

    if(jQuery("#html_select_trial_for_create_fieldbook").length == 0) {
        get_select_box('trials', 'select_trial_for_create_fieldbook', { 'name' : 'html_select_trial_for_create_fieldbook', 'id' : 'html_select_trial_for_create_fieldbook' });
    }

    jQuery(document).on('change', '#html_select_trial_for_create_fieldbook', function() {
        show_fieldbook_treatments();
    });

    jQuery("[name='create_fieldbook_link']").click( function () {
        show_available_columns('plots');
        jQuery('#create_fieldbook_dialog').modal('show');
        show_fieldbook_treatments();
    });
    
    jQuery('#create_fieldbook_ok_button').on('click', function() {
        open_create_fieldbook_dialog();
    });

    jQuery('#create_fieldbook_data_level').on('change', function(){
        var selected_trial_id = parseInt(jQuery('#html_select_trial_for_create_fieldbook').val());
        var level = jQuery('#create_fieldbook_data_level').val();
        var url = '';
        if (level == 'plants'){
            url = 'has_plants';
        }
        if (level == 'subplots' || level == 'plants_subplots'){
            url = 'has_subplots';
        }
        if (level == 'plants' || level == 'subplots' || level == 'plants_subplots'){
            new jQuery.ajax({
                type: 'POST',
                url: '/ajax/breeders/trial/'+selected_trial_id+'/'+url,
                dataType: "json",
                beforeSend: function() {
                    jQuery("#working_modal").modal("show");
                },
                success: function (response) {
                    //console.log(response);
                    jQuery("#working_modal").modal("hide");
                    if(response.has_plants == 0 || response.has_subplots == 0){
                        alert('This trial does not have '+level);
                        jQuery('#create_fieldbook_data_level').val('plots');
                    } else {
                        show_available_columns(level);
                    }
                },
                error: function () {
                    jQuery("#working_modal").modal("hide");
                    alert('An error occurred checking trial for plants or subplots.');
                }
            });
        } else {
            show_available_columns('plots');
        }
    });

});

function show_available_columns(level){
    selected_columns = {};
    not_selected_columns = {};
    var included_html = '';
    var not_inc_html = '';
    if(level == 'plots'){
        included_html = '<h2 id="fieldbook_columns_plot_name"><span class="label label-primary">plot_name <span title="Unique name identifier for each plot. This is a globally unique plot name in the database. If you have barcoded your plots for phenotyping, this is what is encoded in the barcode." class="glyphicon glyphicon-info-sign"></span></span></h2><h2 id="fieldbook_columns_block_number"><span class="label label-primary">block_number <span title="Field design parameter used to distinguish blocks in your field." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'block_number\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_plot_number"><span class="label label-primary">plot_number <span title="Number for the plot in your field design. Typically 1001, 1002, 2001, 2002, etc" class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'plot_number\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_rep_number"><span class="label label-primary">rep_number <span title="Field design parameter used to determine replicate number." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'rep_number\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_row_number"><span class="label label-primary">row_number <span title="The row number that this plot is in. If you partition the field into a grid, this would be the vertical position (y coordinate)." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'row_number\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_col_number"><span class="label label-primary">col_number <span title="The column number that this plot is in. If you partition the field into a grid, this would be the horizontal position (x coordinate)." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'col_number\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_accession_name"><span class="label label-primary">accession_name <span title="The accession name which was planted in the plot." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'accession_name\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_is_a_control"><span class="label label-primary">is_a_control <span title="This is either 1 or 0, meaning that the plot is a control in the experiment or not." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'is_a_control\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2>';
        selected_columns = {'plot_name':1,'block_number':1,'plot_number':1,'rep_number':1,'row_number':1,'col_number':1,'accession_name':1,'is_a_control':1};
    }
    if(level == 'plants'){
        included_html = '<h2 id="fieldbook_columns_plant_name"><span class="label label-primary">plant_name <span title="Unique name identifier for each plant in a plot. This is a globally unique plant name in the database. If you have barcoded your plants for phenotyping, this is what is encoded in the barcode." class="glyphicon glyphicon-info-sign"></span></span></h2><h2 id="fieldbook_columns_plot_name"><span class="label label-primary">plot_name <span title="Unique name identifier for each plot. This is a globally unique plot name in the database." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'plot_name\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_block_number"><span class="label label-primary">block_number <span title="Field design parameter used to distinguish blocks in your field." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'block_number\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_plant_number"><span class="label label-primary">plant_number <span title="Number for the plant in your plot in the field design. Typically 1, 2, 3, etc" class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'plant_number\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_plot_number"><span class="label label-primary">plot_number <span title="Number for the plot in your field design. Typically 1001, 1002, 2001, 2002, etc" class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'plot_number\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_rep_number"><span class="label label-primary">rep_number <span title="Field design parameter used to determine replicate number." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'rep_number\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_row_number"><span class="label label-primary">row_number <span title="The row number that this plot is in. If you partition the field into a grid, this would be the vertical position (y coordinate)." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'row_number\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_col_number"><span class="label label-primary">col_number <span title="The column number that this plot is in. If you partition the field into a grid, this would be the horizontal position (x coordinate)." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'col_number\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_accession_name"><span class="label label-primary">accession_name <span title="The accession name which was planted in the plot." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'accession_name\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_is_a_control"><span class="label label-primary">is_a_control <span title="This is either 1 or 0, meaning that the plot is a control in the experiment or not." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'is_a_control\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2>';
        selected_columns = {'plant_name':1,'plot_name':1,'block_number':1,'plant_number':1,'plot_number':1,'rep_number':1,'row_number':1,'col_number':1,'accession_name':1,'is_a_control':1};
    }
    if(level == 'subplots'){
        included_html = '<h2 id="fieldbook_columns_subplot_name"><span class="label label-primary">subplot_name <span title="Unique name identifier for each subplot in a plot. This is a globally unique subplot name in the database. If you have barcoded your subplots for phenotyping, this is what is encoded in the barcode." class="glyphicon glyphicon-info-sign"></span></span></h2><h2 id="fieldbook_columns_plot_name"><span class="label label-primary">plot_name <span title="Unique name identifier for each plot. This is a globally unique plot name in the database." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'plot_name\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_block_number"><span class="label label-primary">block_number <span title="Field design parameter used to distinguish blocks in your field." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'block_number\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_subplot_number"><span class="label label-primary">subplot_number <span title="Number for the subplot in your plot in the field design. Typically 1, 2, 3, etc" class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'subplot_number\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_plot_number"><span class="label label-primary">plot_number <span title="Number for the plot in your field design. Typically 1001, 1002, 2001, 2002, etc" class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'plot_number\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_rep_number"><span class="label label-primary">rep_number <span title="Field design parameter used to determine replicate number." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'rep_number\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_row_number"><span class="label label-primary">row_number <span title="The row number that this plot is in. If you partition the field into a grid, this would be the vertical position (y coordinate)." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'row_number\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_col_number"><span class="label label-primary">col_number <span title="The column number that this plot is in. If you partition the field into a grid, this would be the horizontal position (x coordinate)." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'col_number\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_accession_name"><span class="label label-primary">accession_name <span title="The accession name which was planted in the plot." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'accession_name\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_is_a_control"><span class="label label-primary">is_a_control <span title="This is either 1 or 0, meaning that the plot is a control in the experiment or not." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'is_a_control\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2>';
        selected_columns = {'subplot_name':1,'plot_name':1,'block_number':1,'subplot_number':1,'plot_number':1,'rep_number':1,'row_number':1,'col_number':1,'accession_name':1,'is_a_control':1};
    }
    if(level == 'plants_subplots'){
        included_html = '<h2 id="fieldbook_columns_plant_name"><span class="label label-primary">plant_name <span title="Unique name identifier for each plant in a subplot in a plot. This is a globally unique plant name in the database. If you have barcoded your plants for phenotyping, this is what is encoded in the barcode." class="glyphicon glyphicon-info-sign"></span></span></h2><h2 id="fieldbook_columns_subplot_name"><span class="label label-primary">subplot_name <span title="Unique name identifier for each subplot in a plot. This is a globally unique subplot name in the database." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'subplot_name\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_plot_name"><span class="label label-primary">plot_name <span title="Unique name identifier for each plot. This is a globally unique plot name in the database." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'plot_name\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_block_number"><span class="label label-primary">block_number <span title="Field design parameter used to distinguish blocks in your field." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'block_number\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_plant_number"><span class="label label-primary">plant_number <span title="Number for the plant in your plot in the field design. Typically 1, 2, 3, etc" class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'plant_number\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_subplot_number"><span class="label label-primary">subplot_number <span title="Number for the subplot in your plot in the field design. Typically 1, 2, 3, etc" class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'subplot_number\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_plot_number"><span class="label label-primary">plot_number <span title="Number for the plot in your field design. Typically 1001, 1002, 2001, 2002, etc" class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'plot_number\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_rep_number"><span class="label label-primary">rep_number <span title="Field design parameter used to determine replicate number." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'rep_number\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_row_number"><span class="label label-primary">row_number <span title="The row number that this plot is in. If you partition the field into a grid, this would be the vertical position (y coordinate)." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'row_number\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_col_number"><span class="label label-primary">col_number <span title="The column number that this plot is in. If you partition the field into a grid, this would be the horizontal position (x coordinate)." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'col_number\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_accession_name"><span class="label label-primary">accession_name <span title="The accession name which was planted in the plot." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'accession_name\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2><h2 id="fieldbook_columns_is_a_control"><span class="label label-primary">is_a_control <span title="This is either 1 or 0, meaning that the plot is a control in the experiment or not." class="glyphicon glyphicon-info-sign"></span>&nbsp;<a onClick="do_not_include_column(\'is_a_control\')"><span title="Do not include" class="glyphicon glyphicon-remove-sign"></span></a></span></h2>';
        selected_columns = {'plant_name':1,'subplot_name':1,'plot_name':1,'block_number':1,'plant_number':1,'subplot_number':1,'plot_number':1,'rep_number':1,'row_number':1,'col_number':1,'accession_name':1,'is_a_control':1};
    }
    jQuery('#create_fieldbook_included_columns').html(included_html);
    jQuery('#create_fieldbook_not_included_columns').html(not_inc_html);
}

function do_not_include_column(name){
    delete selected_columns[name];
    not_selected_columns[name] = 1;
    var identifier = '#fieldbook_columns_'+name;
    jQuery(identifier).hide();
    display_not_selected_columns();
    console.log(selected_columns);
}

function display_not_selected_columns(){
    var html = '';
    for (var name in not_selected_columns) {
        if (not_selected_columns.hasOwnProperty(name)) {
            html += '<h2 id="fieldbook_columns_accession_name"><span class="label label-primary">'+name+'&nbsp;<a onClick="include_column(\''+name+'\')"><span title="Include" class="glyphicon glyphicon-ok-sign"></span></a></span></h2>';
        }
    }
    jQuery('#create_fieldbook_not_included_columns').html(html);
}

function include_column(name){
    var identifier = '#fieldbook_columns_'+name;
    jQuery(identifier).show();
    delete not_selected_columns[name];
    selected_columns[name] = 1;
    display_not_selected_columns();
    console.log(selected_columns);
}

function show_fieldbook_treatments(){
    var selected_trial_id = parseInt(jQuery("#html_select_trial_for_create_fieldbook").val());
    get_select_box('treatments', 'create_fieldbook_treatment', { 'name':'html_select_treatment_create_fieldbook', 'id':'html_select_treatment_create_fieldbook', 'trial_id':selected_trial_id, 'empty':1 });
}

function open_create_fieldbook_dialog() {
    new jQuery.ajax({
        type: 'POST',
        url: '/ajax/fieldbook/create',
        dataType: "json",
        data: {
            'trial_id': parseInt(jQuery('#html_select_trial_for_create_fieldbook').val()),
            'data_level': jQuery('#create_fieldbook_data_level').val(),
            'treatment_project_id': jQuery("#html_select_treatment_create_fieldbook").val(),
        },
        beforeSend: function() {
            jQuery("#working_modal").modal("show");
        },
        success: function (response) {
            jQuery("#working_modal").modal("hide");
            if (response.error) {
                alert(response.error);
            } else {
                jQuery('#tablet_layout_download_link').attr('href',"/fieldbook");
                jQuery("#tablet_field_layout_saved_dialog_message").modal("show");
                //alert(response.file);
                jQuery('#create_fieldbook_dialog').modal("hide");
            }
        },
        error: function () {
            jQuery("#working_modal").modal("hide");
            alert('An error occurred creating the field book.');
            jQuery('#create_fieldbook_dialog').modal("hide");
        }
    });
}

</script>
