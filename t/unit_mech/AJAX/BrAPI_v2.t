
use strict;
use warnings;

#use lib 't/lib';
#use SGN::Test::Fixture;
use Test::More;
use Test::WWW::Mechanize;

#Needed to update IO::Socket::SSL
use Data::Dumper;
use JSON;
local $Data::Dumper::Indent = 0;

my $mech = Test::WWW::Mechanize->new;
my $response; my $searchId;

$mech->get_ok('http://localhost:3010/brapi/v2/serverinfo');
$response = decode_json $mech->content;
print STERR Dumper $response;
is_deeply($response, {'metadata' => {'status' => [{'message' => 'BrAPI base call found with page=0, pageSize=10','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::ServerInfo'},{'messageType' => 'INFO','message' => 'Calls result constructed'}],'datafiles' => [],'pagination' => {'totalPages' => 1,'currentPage' => 0,'totalCount' => 116,'pageSize' => 1000}},'result' => {'calls' => [{'service' => 'serverinfo','datatypes' => ['application/json'],'methods' => ['GET'],'versions' => ['2.0']},{'versions' => ['2.0'],'methods' => ['GET'],'datatypes' => ['application/json'],'service' => 'commoncropnames'},{'datatypes' => ['application/json'],'service' => 'lists','versions' => ['2.0'],'methods' => ['GET','POST']},{'versions' => ['2.0'],'methods' => ['GET','PUT'],'datatypes' => ['application/json'],'service' => 'lists/{listDbId}'},{'methods' => ['POST'],'versions' => ['2.0'],'datatypes' => ['application/json'],'service' => 'lists/{listDbId}/items'},{'service' => 'search/lists','datatypes' => ['application/json'],'versions' => ['2.0'],'methods' => ['POST']},{'service' => 'search/lists/{searchResultsDbId}','datatypes' => ['application/json'],'versions' => ['2.0'],'methods' => ['GET']},{'service' => 'locations','datatypes' => ['application/json'],'methods' => ['GET','POST'],'versions' => ['2.0']},{'service' => 'locations/{locationDbId}','datatypes' => ['application/json'],'methods' => ['GET','PUT'],'versions' => ['2.0']},{'versions' => ['2.0'],'methods' => ['POST'],'datatypes' => ['application/json'],'service' => 'search/locations'},{'methods' => ['GET'],'versions' => ['2.0'],'service' => 'search/locations/{searchResultsDbId}','datatypes' => ['application/json']},{'datatypes' => ['application/json'],'service' => 'people','versions' => ['2.0'],'methods' => ['GET']},{'datatypes' => ['application/json'],'service' => 'people/{peopleDbId}','versions' => ['2.0'],'methods' => ['GET']},{'versions' => ['2.0'],'methods' => ['POST'],'datatypes' => ['application/json'],'service' => 'search/people'},{'datatypes' => ['application/json'],'service' => 'search/people/{searchResultsDbId}','methods' => ['GET'],'versions' => ['2.0']},{'methods' => ['GET','POST'],'versions' => ['2.0'],'service' => 'programs','datatypes' => ['application/json']},{'datatypes' => ['application/json'],'service' => 'programs/{programDbId}','versions' => ['2.0'],'methods' => ['GET','PUT']},{'versions' => ['2.0'],'methods' => ['POST'],'service' => 'search/programs','datatypes' => ['application/json']},{'datatypes' => ['application/json'],'service' => 'search/programs/{searchResultsDbId}','methods' => ['GET'],'versions' => ['2.0']},{'datatypes' => ['application/json'],'service' => 'seasons','versions' => ['2.0'],'methods' => ['GET']},{'methods' => ['GET'],'versions' => ['2.0'],'datatypes' => ['application/json'],'service' => 'seasons/{seasonDbId}'},{'service' => 'search/seasons','datatypes' => ['application/json'],'methods' => ['POST'],'versions' => ['2.0']},{'datatypes' => ['application/json'],'service' => 'search/seasons/{searchResultsDbId}','versions' => ['2.0'],'methods' => ['GET']},{'datatypes' => ['application/json'],'service' => 'studies','methods' => ['GET','POST'],'versions' => ['2.0']},{'versions' => ['2.0'],'methods' => ['GET','PUT'],'datatypes' => ['application/json'],'service' => 'studies/{studyDbId}'},{'methods' => ['POST'],'versions' => ['2.0'],'service' => 'search/studies','datatypes' => ['application/json']},{'versions' => ['2.0'],'methods' => ['GET'],'datatypes' => ['application/json'],'service' => 'search/studies/{searchResultsDbId}'},{'service' => 'studytypes','datatypes' => ['application/json'],'methods' => ['GET'],'versions' => ['2.0']},{'datatypes' => ['application/json'],'service' => 'trials','versions' => ['2.0'],'methods' => ['GET','POST']},{'datatypes' => ['application/json'],'service' => 'trials/{trialDbId}','versions' => ['2.0'],'methods' => ['GET','PUT']},{'datatypes' => ['application/json'],'service' => 'search/trials','methods' => ['POST'],'versions' => ['2.0']},{'service' => 'search/trials/{searchResultsDbId}','datatypes' => ['application/json'],'versions' => ['2.0'],'methods' => ['GET']},{'datatypes' => ['application/json'],'service' => 'images','versions' => ['2.0'],'methods' => ['GET','POST']},{'methods' => ['GET','PUT'],'versions' => ['2.0'],'datatypes' => ['application/json'],'service' => 'images/{imageDbId}'},{'service' => 'images/{imageDbId}/imagecontent','datatypes' => ['application/json'],'methods' => ['PUT'],'versions' => ['2.0']},{'datatypes' => ['application/json'],'service' => 'search/images','versions' => ['2.0'],'methods' => ['POST']},{'datatypes' => ['application/json'],'service' => 'search/images/{searchResultsDbId}','versions' => ['2.0'],'methods' => ['GET']},{'datatypes' => ['application/json'],'service' => 'observations','versions' => ['2.0'],'methods' => ['GET','POST','PUT']},{'methods' => ['GET','PUT'],'versions' => ['2.0'],'datatypes' => ['application/json'],'service' => 'observations/{observationDbId}'},{'service' => 'observations/table','datatypes' => ['application/json'],'versions' => ['2.0'],'methods' => ['GET']},{'datatypes' => ['application/json'],'service' => 'search/observations','methods' => ['POST'],'versions' => ['2.0']},{'datatypes' => ['application/json'],'service' => 'search/observations/{searchResultsDbId}','methods' => ['GET'],'versions' => ['2.0']},{'service' => 'observationlevels','datatypes' => ['application/json'],'methods' => ['GET'],'versions' => ['2.0']},{'methods' => ['GET','POST','PUT'],'versions' => ['2.0'],'datatypes' => ['application/json'],'service' => 'observationunits'},{'methods' => ['GET','PUT'],'versions' => ['2.0'],'service' => 'observationunits/{observationUnitDbId}','datatypes' => ['application/json']},{'datatypes' => ['application/json'],'service' => 'search/observationunits','versions' => ['2.0'],'methods' => ['POST']},{'service' => 'search/observationunits/{searchResultsDbId}','datatypes' => ['application/json'],'methods' => ['GET'],'versions' => ['2.0']},{'service' => 'ontologies','datatypes' => ['application/json'],'versions' => ['2.0'],'methods' => ['GET']},{'service' => 'traits','datatypes' => ['application/json'],'methods' => ['GET'],'versions' => ['2.0']},{'datatypes' => ['application/json'],'service' => 'traits/{traitDbId}','versions' => ['2.0'],'methods' => ['GET']},{'datatypes' => ['application/json'],'service' => 'variables','versions' => ['2.0'],'methods' => ['GET']},{'methods' => ['GET'],'versions' => ['2.0'],'service' => 'variables/{observationVariableDbId}','datatypes' => ['application/json']},{'datatypes' => ['application/json'],'service' => 'search/variables','methods' => ['POST'],'versions' => ['2.0']},{'service' => 'search/variables/{searchResultsDbId}','datatypes' => ['application/json'],'versions' => ['2.0'],'methods' => ['GET']},{'methods' => ['GET'],'versions' => ['2.0'],'datatypes' => ['application/json'],'service' => 'calls'},{'versions' => ['2.0'],'methods' => ['POST'],'service' => 'search/calls','datatypes' => ['application/json']},{'versions' => ['2.0'],'methods' => ['GET'],'service' => 'search/calls/{searchResultsDbId}','datatypes' => ['application/json']},{'service' => 'callsets','datatypes' => ['application/json'],'methods' => ['GET'],'versions' => ['2.0']},{'methods' => ['GET'],'versions' => ['2.0'],'datatypes' => ['application/json'],'service' => 'callsets/{callSetDbId}'},{'datatypes' => ['application/json'],'service' => 'callsets/{callSetDbId}/calls','versions' => ['2.0'],'methods' => ['GET']},{'datatypes' => ['application/json'],'service' => 'search/callsets','versions' => ['2.0'],'methods' => ['POST']},{'datatypes' => ['application/json'],'service' => 'search/callsets/{searchResultsDbId}','versions' => ['2.0'],'methods' => ['GET']},{'service' => 'maps','datatypes' => ['application/json'],'versions' => ['2.0'],'methods' => ['GET']},{'versions' => ['2.0'],'methods' => ['GET'],'service' => 'maps/{mapDbId}','datatypes' => ['application/json']},{'datatypes' => ['application/json'],'service' => 'maps/{mapDbId}/linkagegroups','versions' => ['2.0'],'methods' => ['GET']},{'datatypes' => ['application/json'],'service' => 'markerpositions','versions' => ['2.0'],'methods' => ['GET']},{'versions' => ['2.0'],'methods' => ['POST'],'datatypes' => ['application/json'],'service' => 'search/markerpositions'},{'service' => 'search/markerpositions/{searchResultsDbId}','datatypes' => ['application/json'],'versions' => ['2.0'],'methods' => ['GET']},{'versions' => ['2.0'],'methods' => ['GET'],'service' => 'references','datatypes' => ['application/json']},{'methods' => ['GET'],'versions' => ['2.0'],'datatypes' => ['application/json'],'service' => 'references/{referenceDbId}'},{'versions' => ['2.0'],'methods' => ['POST'],'service' => 'search/references','datatypes' => ['application/json']},{'versions' => ['2.0'],'methods' => ['GET'],'datatypes' => ['application/json'],'service' => 'search/references/{searchResultsDbId}'},{'service' => 'referencesets','datatypes' => ['application/json'],'versions' => ['2.0'],'methods' => ['GET']},{'methods' => ['GET'],'versions' => ['2.0'],'service' => 'referencesets/{referenceSetDbId}','datatypes' => ['application/json']},{'service' => 'search/referencesets','datatypes' => ['application/json'],'methods' => ['POST'],'versions' => ['2.0']},{'datatypes' => ['application/json'],'service' => 'search/referencesets/{searchResultsDbId}','methods' => ['GET'],'versions' => ['2.0']},{'service' => 'samples','datatypes' => ['application/json'],'methods' => ['GET'],'versions' => ['2.0']},{'service' => 'samples/{sampleDbId}','datatypes' => ['application/json'],'versions' => ['2.0'],'methods' => ['GET']},{'versions' => ['2.0'],'methods' => ['POST'],'datatypes' => ['application/json'],'service' => 'search/samples'},{'datatypes' => ['application/json'],'service' => 'search/samples/{searchResultsDbId}','methods' => ['GET'],'versions' => ['2.0']},{'datatypes' => ['application/json'],'service' => 'variants','versions' => ['2.0'],'methods' => ['GET']},{'datatypes' => ['application/json'],'service' => 'variants/{variantDbId}','methods' => ['GET'],'versions' => ['2.0']},{'service' => 'variants/{variantDbId}/calls','datatypes' => ['application/json'],'methods' => ['GET'],'versions' => ['2.0']},{'versions' => ['2.0'],'methods' => ['POST'],'service' => 'search/variants','datatypes' => ['application/json']},{'service' => 'search/variants/{searchResultsDbId}','datatypes' => ['application/json'],'versions' => ['2.0'],'methods' => ['GET']},{'datatypes' => ['application/json'],'service' => 'variantsets','versions' => ['2.0'],'methods' => ['GET']},{'datatypes' => ['application/json'],'service' => 'variantsets/extract','methods' => ['GET'],'versions' => ['2.0']},{'versions' => ['2.0'],'methods' => ['GET'],'service' => 'variantsets/{variantSetDbId}','datatypes' => ['application/json']},{'versions' => ['2.0'],'methods' => ['GET'],'service' => 'variantsets/{variantSetDbId}/calls','datatypes' => ['application/json']},{'methods' => ['GET'],'versions' => ['2.0'],'service' => 'variantsets/{variantSetDbId}/callsets','datatypes' => ['application/json']},{'methods' => ['GET'],'versions' => ['2.0'],'datatypes' => ['application/json'],'service' => 'variantsets/{variantSetDbId}/variants'},{'methods' => ['POST'],'versions' => ['2.0'],'datatypes' => ['application/json'],'service' => 'search/variantsets'},{'service' => 'search/variantsets/{searchResultsDbId}','datatypes' => ['application/json'],'methods' => ['GET'],'versions' => ['2.0']},{'versions' => ['2.0'],'methods' => ['GET','POST'],'datatypes' => ['application/json'],'service' => 'germplasm'},{'versions' => ['2.0'],'methods' => ['GET','PUT'],'datatypes' => ['application/json'],'service' => 'germplasm/{germplasmDbId}'},{'versions' => ['2.0'],'methods' => ['GET'],'service' => 'germplasm/{germplasmDbId}/pedigree','datatypes' => ['application/json']},{'methods' => ['GET'],'versions' => ['2.0'],'datatypes' => ['application/json'],'service' => 'germplasm/{germplasmDbId}/progeny'},{'service' => 'germplasm/{germplasmDbId}/mcpd','datatypes' => ['application/json'],'versions' => ['2.0'],'methods' => ['GET']},{'versions' => ['2.0'],'methods' => ['POST'],'datatypes' => ['application/json'],'service' => 'search/germplasm'},{'versions' => ['2.0'],'methods' => ['GET'],'service' => 'search/germplasm/{searchResultsDbId}','datatypes' => ['application/json']},{'service' => 'attributes','datatypes' => ['application/json'],'methods' => ['GET'],'versions' => ['2.0']},{'methods' => ['GET'],'versions' => ['2.0'],'datatypes' => ['application/json'],'service' => 'attributes/categories'},{'methods' => ['GET'],'versions' => ['2.0'],'datatypes' => ['application/json'],'service' => 'attributes/{attributeDbId}'},{'datatypes' => ['application/json'],'service' => 'search/attributes','versions' => ['2.0'],'methods' => ['POST']},{'versions' => ['2.0'],'methods' => ['GET'],'datatypes' => ['application/json'],'service' => 'search/attributes/{searchResultsDbId}'},{'methods' => ['GET'],'versions' => ['2.0'],'datatypes' => ['application/json'],'service' => 'attributevalues'},{'service' => 'attributevalues/{attributeValueDbId}','datatypes' => ['application/json'],'methods' => ['GET'],'versions' => ['2.0']},{'methods' => ['POST'],'versions' => ['2.0'],'datatypes' => ['application/json'],'service' => 'search/attributevalues'},{'service' => 'search/attributevalues/{searchResultsDbId}','datatypes' => ['application/json'],'methods' => ['GET'],'versions' => ['2.0']},{'service' => 'crossingprojects','datatypes' => ['application/json'],'methods' => ['GET','POST'],'versions' => ['2.0']},{'methods' => ['GET','PUT'],'versions' => ['2.0'],'service' => 'crossingprojects/{crossingProjectDbId}','datatypes' => ['application/json']},{'versions' => ['2.0'],'methods' => ['GET','POST'],'service' => 'crosses','datatypes' => ['application/json']},{'versions' => ['2.0'],'methods' => ['GET','POST'],'service' => 'seedlots','datatypes' => ['application/json']},{'versions' => ['2.0'],'methods' => ['GET','POST'],'datatypes' => ['application/json'],'service' => 'seedlots/transactions'},{'versions' => ['2.0'],'methods' => ['GET','PUT'],'service' => 'seedlots/{seedLotDbId}','datatypes' => ['application/json']},{'service' => 'seedlots/{seedLotDbId}/transactions','datatypes' => ['application/json'],'versions' => ['2.0'],'methods' => ['GET']}],'serverName' => 'localhost','organizationURL' => 'http://localhost:3010/','permissions' => {'PUT' => 'curator','POST' => 'curator','GET' => 'any'},'location' => 'USA','organizationName' => 'Boyce Thompson Institute','contactEmail' => 'lam87@cornell.edu','documentationURL' => 'https://solgenomics.github.io/sgn/','serverDescription' => 'BrAPI v2.0 compliant server'}});
$mech->post_ok('http://localhost:3010/brapi/v2/token', [ "username"=> "janedoe", "password"=> "secretpw", "grant_type"=> "password" ]);
$response = decode_json $mech->content;
print STDERR Dumper $response;
is($response->{'metadata'}->{'status'}->[2]->{'message'}, 'Login Successfull');
is($response->{'userDisplayName'}, 'Jane Doe');
is($response->{'expires_in'}, '7200');

$mech->delete_ok('http://localhost:3010/brapi/v2/token');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is($response->{'metadata'}->{'status'}->[2]->{'message'}, 'User Logged Out');

$mech->post_ok('http://localhost:3010/brapi/v2/token', [ "username"=> "janedoe", "password"=> "secretpw", "grant_type"=> "password" ]);
$response = decode_json $mech->content;
print STDERR Dumper $response;
is($response->{'metadata'}->{'status'}->[2]->{'message'}, 'Login Successfull');
is($response->{'userDisplayName'}, 'Jane Doe');
is($response->{'expires_in'}, '7200');
my $access_token = $response->{access_token};

# Phenotyping

$mech->get_ok('http://localhost:3010/brapi/v2/observationlevels');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'result' => {'data' => [{'levelName' => 'replicate','levelOrder' => 0},{'levelName' => 'block','levelOrder' => 1},{'levelName' => 'plot','levelOrder' => 2},{'levelName' => 'subplot','levelOrder' => 3},{'levelName' => 'plant','levelOrder' => 4},{'levelName' => 'tissue_sample','levelOrder' => 5}]},'metadata' => {'pagination' => {'totalPages' => 1,'pageSize' => 6,'totalCount' => 6,'currentPage' => 0},'datafiles' => [],'status' => [{'message' => 'BrAPI base call found with page=0, pageSize=10','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::ObservationVariables'},{'messageType' => 'INFO','message' => 'Observation Levels result constructed'}]}});

$mech->get_ok('http://localhost:3010/brapi/v2/observationunits');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'metadata' => {'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'message' => 'Loading CXGN::BrAPI::v2::ObservationUnits','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'Observation Units search result constructed'}],'datafiles' => [],'pagination' => {'totalPages' => 196,'pageSize' => 10,'totalCount' => 1954,'currentPage' => 0}},'result' => {'data' => [{'observationUnitDbId' => '41284','locationDbId' => '23','locationName' => 'test_location','studyName' => 'CASS_6Genotypes_Sampling_2015','observationUnitName' => 'CASS_6Genotypes_103','trialName' => undef,'observations' => [],'additionalInfo' => {},'programDbId' => '134','germplasmName' => 'IITA-TMS-IBA980581','programName' => 'test','externalReferences' => [],'treatments' => [{'modality' => '','factor' => 'No ManagementFactor'}],'observationUnitPosition' => {'positionCoordinateYType' => 'GRID_ROW','positionCoordinateX' => undef,'observationLevelRelationships' => [{'levelCode' => '1','levelName' => 'replicate','levelOrder' => 0},{'levelOrder' => 1,'levelName' => 'block','levelCode' => '1'},{'levelName' => 'plot','levelCode' => '103','levelOrder' => 2},{'levelCode' => undef,'levelName' => 'plant','levelOrder' => 4}],'observationLevel' => {'levelCode' => '103','levelName' => 'plot','levelOrder' => 2},'positionCoordinateY' => undef,'entryType' => 'test','positionCoordinateXType' => 'GRID_COL','geoCoordinates' => ''},'germplasmDbId' => '41283','trialDbId' => '','studyDbId' => '165','observationUnitPUI' => '103'},{'programName' => 'test','externalReferences' => [],'observationUnitPosition' => {'positionCoordinateYType' => 'GRID_ROW','positionCoordinateX' => undef,'observationLevelRelationships' => [{'levelCode' => '1','levelName' => 'replicate','levelOrder' => 0},{'levelOrder' => 1,'levelCode' => '1','levelName' => 'block'},{'levelCode' => '104','levelName' => 'plot','levelOrder' => 2},{'levelOrder' => 4,'levelName' => 'plant','levelCode' => undef}],'geoCoordinates' => '','observationLevel' => {'levelName' => 'plot','levelCode' => '104','levelOrder' => 2},'positionCoordinateY' => undef,'entryType' => 'test','positionCoordinateXType' => 'GRID_COL'},'treatments' => [{'modality' => '','factor' => 'No ManagementFactor'}],'trialDbId' => '','germplasmDbId' => '41282','studyDbId' => '165','observationUnitPUI' => '104','observationUnitDbId' => '41295','locationName' => 'test_location','locationDbId' => '23','observationUnitName' => 'CASS_6Genotypes_104','studyName' => 'CASS_6Genotypes_Sampling_2015','programDbId' => '134','germplasmName' => 'IITA-TMS-IBA980002','observations' => [],'trialName' => undef,'additionalInfo' => {}},{'programName' => 'test','externalReferences' => [],'observationUnitPosition' => {'observationLevel' => {'levelName' => 'plot','levelCode' => '105','levelOrder' => 2},'positionCoordinateXType' => 'GRID_COL','positionCoordinateY' => undef,'entryType' => 'test','geoCoordinates' => '','positionCoordinateX' => undef,'positionCoordinateYType' => 'GRID_ROW','observationLevelRelationships' => [{'levelOrder' => 0,'levelCode' => '1','levelName' => 'replicate'},{'levelName' => 'block','levelCode' => '1','levelOrder' => 1},{'levelName' => 'plot','levelCode' => '105','levelOrder' => 2},{'levelOrder' => 4,'levelCode' => undef,'levelName' => 'plant'}]},'treatments' => [{'modality' => '','factor' => 'No ManagementFactor'}],'germplasmDbId' => '41279','trialDbId' => '','studyDbId' => '165','observationUnitPUI' => '105','observationUnitDbId' => '41296','locationName' => 'test_location','locationDbId' => '23','observationUnitName' => 'CASS_6Genotypes_105','studyName' => 'CASS_6Genotypes_Sampling_2015','observations' => [],'trialName' => undef,'additionalInfo' => {},'programDbId' => '134','germplasmName' => 'IITA-TMS-IBA30572'},{'observationUnitDbId' => '41297','locationDbId' => '23','locationName' => 'test_location','studyName' => 'CASS_6Genotypes_Sampling_2015','observationUnitName' => 'CASS_6Genotypes_106','additionalInfo' => {},'observations' => [],'trialName' => undef,'germplasmName' => 'IITA-TMS-IBA011412','programDbId' => '134','programName' => 'test','observationUnitPosition' => {'observationLevelRelationships' => [{'levelName' => 'replicate','levelCode' => '1','levelOrder' => 0},{'levelName' => 'block','levelCode' => '1','levelOrder' => 1},{'levelName' => 'plot','levelCode' => '106','levelOrder' => 2},{'levelOrder' => 4,'levelCode' => undef,'levelName' => 'plant'}],'positionCoordinateX' => undef,'positionCoordinateYType' => 'GRID_ROW','geoCoordinates' => '','positionCoordinateXType' => 'GRID_COL','positionCoordinateY' => undef,'entryType' => 'test','observationLevel' => {'levelCode' => '106','levelName' => 'plot','levelOrder' => 2}},'treatments' => [{'factor' => 'No ManagementFactor','modality' => ''}],'externalReferences' => [],'germplasmDbId' => '41281','trialDbId' => '','observationUnitPUI' => '106','studyDbId' => '165'},{'studyDbId' => '165','observationUnitPUI' => '107','germplasmDbId' => '41280','trialDbId' => '','externalReferences' => [],'treatments' => [{'factor' => 'No ManagementFactor','modality' => ''}],'observationUnitPosition' => {'geoCoordinates' => '','observationLevel' => {'levelName' => 'plot','levelCode' => '107','levelOrder' => 2},'entryType' => 'test','positionCoordinateY' => undef,'positionCoordinateXType' => 'GRID_COL','positionCoordinateYType' => 'GRID_ROW','positionCoordinateX' => undef,'observationLevelRelationships' => [{'levelName' => 'replicate','levelCode' => '1','levelOrder' => 0},{'levelName' => 'block','levelCode' => '1','levelOrder' => 1},{'levelCode' => '107','levelName' => 'plot','levelOrder' => 2},{'levelOrder' => 4,'levelCode' => undef,'levelName' => 'plant'}]},'programName' => 'test','trialName' => undef,'observations' => [],'additionalInfo' => {},'germplasmName' => 'TMEB693','programDbId' => '134','observationUnitName' => 'CASS_6Genotypes_107','studyName' => 'CASS_6Genotypes_Sampling_2015','locationName' => 'test_location','locationDbId' => '23','observationUnitDbId' => '41298'},{'trialName' => undef,'observations' => [],'additionalInfo' => {},'programDbId' => '134','germplasmName' => 'BLANK','studyName' => 'CASS_6Genotypes_Sampling_2015','observationUnitName' => 'CASS_6Genotypes_201','locationDbId' => '23','locationName' => 'test_location','observationUnitDbId' => '41299','studyDbId' => '165','observationUnitPUI' => '201','germplasmDbId' => '40326','trialDbId' => '','externalReferences' => [],'observationUnitPosition' => {'positionCoordinateX' => undef,'positionCoordinateYType' => 'GRID_ROW','observationLevelRelationships' => [{'levelOrder' => 0,'levelName' => 'replicate','levelCode' => '1'},{'levelName' => 'block','levelCode' => '2','levelOrder' => 1},{'levelOrder' => 2,'levelName' => 'plot','levelCode' => '201'},{'levelName' => 'plant','levelCode' => undef,'levelOrder' => 4}],'geoCoordinates' => '','observationLevel' => {'levelName' => 'plot','levelCode' => '201','levelOrder' => 2},'positionCoordinateXType' => 'GRID_COL','entryType' => 'test','positionCoordinateY' => undef},'treatments' => [{'modality' => '','factor' => 'No ManagementFactor'}],'programName' => 'test'},{'observationUnitPosition' => {'observationLevelRelationships' => [{'levelName' => 'replicate','levelCode' => '1','levelOrder' => 0},{'levelOrder' => 1,'levelName' => 'block','levelCode' => '2'},{'levelCode' => '202','levelName' => 'plot','levelOrder' => 2},{'levelName' => 'plant','levelCode' => undef,'levelOrder' => 4}],'positionCoordinateX' => undef,'positionCoordinateYType' => 'GRID_ROW','positionCoordinateXType' => 'GRID_COL','entryType' => 'test','positionCoordinateY' => undef,'observationLevel' => {'levelCode' => '202','levelName' => 'plot','levelOrder' => 2},'geoCoordinates' => ''},'treatments' => [{'modality' => '','factor' => 'No ManagementFactor'}],'externalReferences' => [],'programName' => 'test','observationUnitPUI' => '202','studyDbId' => '165','germplasmDbId' => '41280','trialDbId' => '','locationDbId' => '23','locationName' => 'test_location','observationUnitDbId' => '41300','additionalInfo' => {},'observations' => [],'trialName' => undef,'programDbId' => '134','germplasmName' => 'TMEB693','studyName' => 'CASS_6Genotypes_Sampling_2015','observationUnitName' => 'CASS_6Genotypes_202'},{'locationDbId' => '23','locationName' => 'test_location','observationUnitDbId' => '41301','germplasmName' => 'IITA-TMS-IBA980002','programDbId' => '134','additionalInfo' => {},'trialName' => undef,'observations' => [],'observationUnitName' => 'CASS_6Genotypes_203','studyName' => 'CASS_6Genotypes_Sampling_2015','treatments' => [{'modality' => '','factor' => 'No ManagementFactor'}],'observationUnitPosition' => {'geoCoordinates' => '','observationLevel' => {'levelOrder' => 2,'levelCode' => '203','levelName' => 'plot'},'positionCoordinateXType' => 'GRID_COL','positionCoordinateY' => undef,'entryType' => 'test','positionCoordinateX' => undef,'positionCoordinateYType' => 'GRID_ROW','observationLevelRelationships' => [{'levelOrder' => 0,'levelName' => 'replicate','levelCode' => '1'},{'levelCode' => '2','levelName' => 'block','levelOrder' => 1},{'levelOrder' => 2,'levelCode' => '203','levelName' => 'plot'},{'levelOrder' => 4,'levelName' => 'plant','levelCode' => undef}]},'externalReferences' => [],'programName' => 'test','observationUnitPUI' => '203','studyDbId' => '165','trialDbId' => '','germplasmDbId' => '41282'},{'observationUnitPUI' => '204','studyDbId' => '165','trialDbId' => '','germplasmDbId' => '41283','treatments' => [{'modality' => '','factor' => 'No ManagementFactor'}],'observationUnitPosition' => {'positionCoordinateYType' => 'GRID_ROW','positionCoordinateX' => undef,'observationLevelRelationships' => [{'levelOrder' => 0,'levelName' => 'replicate','levelCode' => '1'},{'levelOrder' => 1,'levelName' => 'block','levelCode' => '2'},{'levelCode' => '204','levelName' => 'plot','levelOrder' => 2},{'levelOrder' => 4,'levelName' => 'plant','levelCode' => undef}],'observationLevel' => {'levelName' => 'plot','levelCode' => '204','levelOrder' => 2},'positionCoordinateY' => undef,'entryType' => 'test','positionCoordinateXType' => 'GRID_COL','geoCoordinates' => ''},'externalReferences' => [],'programName' => 'test','germplasmName' => 'IITA-TMS-IBA980581','programDbId' => '134','additionalInfo' => {},'trialName' => undef,'observations' => [],'studyName' => 'CASS_6Genotypes_Sampling_2015','observationUnitName' => 'CASS_6Genotypes_204','locationDbId' => '23','locationName' => 'test_location','observationUnitDbId' => '41302'},{'observationUnitDbId' => '41285','locationName' => 'test_location','locationDbId' => '23','observationUnitName' => 'CASS_6Genotypes_205','studyName' => 'CASS_6Genotypes_Sampling_2015','germplasmName' => 'IITA-TMS-IBA011412','programDbId' => '134','additionalInfo' => {},'observations' => [],'trialName' => undef,'programName' => 'test','treatments' => [{'modality' => '','factor' => 'No ManagementFactor'}],'observationUnitPosition' => {'observationLevelRelationships' => [{'levelCode' => '1','levelName' => 'replicate','levelOrder' => 0},{'levelCode' => '2','levelName' => 'block','levelOrder' => 1},{'levelOrder' => 2,'levelName' => 'plot','levelCode' => '205'},{'levelName' => 'plant','levelCode' => undef,'levelOrder' => 4}],'positionCoordinateYType' => 'GRID_ROW','positionCoordinateX' => undef,'geoCoordinates' => '','positionCoordinateY' => undef,'entryType' => 'test','positionCoordinateXType' => 'GRID_COL','observationLevel' => {'levelOrder' => 2,'levelName' => 'plot','levelCode' => '205'}},'externalReferences' => [],'trialDbId' => '','germplasmDbId' => '41281','observationUnitPUI' => '205','studyDbId' => '165'}]}});


my $data = '[{
  "additionalInfo": {
      "control": 1 },
  "germplasmDbId": "41281",
  "germplasmName": "IITA-TMS-IBA011412",
  "locationDbId": "23",
  "locationName": "test_location",
  "observationUnitName": "Testing Plot",
  "observationUnitPUI": "10",
  "programDbId": "134",
  "programName": "test",
  "seedLotDbId": "",
  "studyDbId": "165",
  "studyName": "CASS_6Genotypes_Sampling_2015",
  "treatments": [],
  "trialDbId": "165",
  "trialName": "",
  "observationUnitPosition": {"entryType": "TEST",
      "geoCoordinates": {
        "geometry": {
          "coordinates": [
            -76.506042,
            42.417373,
            155
          ],
          "type": "Point"
        },
        "type": "Feature"
      },
      "observationLevel": {
        "levelName": "plot",
        "levelOrder": 2,
        "levelCode": "10"
      },
      "observationLevelRelationships": [
        {
          "levelCode": "Field_1",
          "levelName": "field",
          "levelOrder": 0
        },
        {
          "levelCode": "Block_12",
          "levelName": "block",
          "levelOrder": 1
        },
        {
          "levelCode": "Plot_123",
          "levelName": "plot",
          "levelOrder": 2
        }
      ],
      "positionCoordinateX": "74",
      "positionCoordinateXType": "GRID_COL",
      "positionCoordinateY": "03",
      "positionCoordinateYType": "GRID_ROW"
      }
   }]';


$mech->default_header("Content-Type" => "application/json");
$mech->default_header('Authorization'=> 'Bearer ' . $access_token);
$mech->post('http://localhost:3010/brapi/v2/observationunits/', Content => $data);
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'result' => '','metadata' => {'datafiles' => undef,'pagination' => {'totalPages' => 1,'pageSize' => 10,'totalCount' => 1,'currentPage' => 0},'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::ObservationUnits'},{'message' => 'Observation Units have been added','messageType' => 'INFO'}]}} );

print "\n#/observationunits/41299 test\n";
$mech->get_ok('http://localhost:3010/brapi/v2/observationunits/41299?pageSize=1&page=0');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'metadata' => {'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=1'},{'message' => 'Loading CXGN::BrAPI::v2::ObservationUnits','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'Observation Units search result constructed'}],'datafiles' => [],'pagination' => {'totalCount' => 1,'totalPages' => 1,'currentPage' => 0,'pageSize' => 1}},'result' => {'data' => [{'observations' => [],'trialDbId' => '','observationUnitPosition' => {'geoCoordinates' => '','positionCoordinateYType' => '','positionCoordinateX' => undef,'observationLevel' => {'levelOrder' => 2,'levelCode' => '','levelName' => 'plot'},'observationLevelRelationships' => [{'levelOrder' => 0,'levelCode' => '1','levelName' => 'replicate'},{'levelCode' => '2','levelName' => 'block','levelOrder' => 1},{'levelCode' => '201','levelOrder' => 2,'levelName' => 'plot'},{'levelOrder' => 4,'levelCode' => undef,'levelName' => 'plant'}],'entryType' => 'test','positionCoordinateY' => undef,'positionCoordinateXType' => ''},'observationUnitPUI' => '201','germplasmName' => 'BLANK','externalReferences' => [],'locationName' => 'test_location','observationUnitDbId' => '41299','additionalInfo' => {},'trialName' => undef,'germplasmDbId' => '40326','studyDbId' => '165','programDbId' => '134','treatments' => [{'factor' => 'No ManagementFactor','modality' => ''}],'observationUnitName' => 'CASS_6Genotypes_201','programName' => 'test','locationDbId' => '23','studyName' => 'CASS_6Genotypes_Sampling_2015'}]}});

my $data = '{
  "additionalInfo": {
      "control": 1 },
  "germplasmDbId": "41281",
  "germplasmName": "IITA-TMS-IBA011412",
  "locationDbId": "23",
  "locationName": "test_location",
  "observationUnitName": "Testing Plot",
  "observationUnitPUI": "10",
  "programDbId": "134",
  "programName": "test",
  "seedLotDbId": "",
  "studyDbId": "165",
  "studyName": "CASS_6Genotypes_Sampling_2015",
  "treatments": [],
  "trialDbId": "165",
  "trialName": "",
  "observationUnitPosition": {"entryType": "TEST",
      "geoCoordinates": {
        "geometry": {
          "coordinates": [
            -76.506042,
            42.417373,
            155
          ],
          "type": "Point"
        },
        "type": "Feature"
      },
      "observationLevel": {
        "levelName": "plot",
        "levelOrder": 2,
        "levelCode": "10"
      },
      "observationLevelRelationships": [
        {
          "levelCode": "Field_1",
          "levelName": "field",
          "levelOrder": 0
        },
        {
          "levelCode": "Block_12",
          "levelName": "block",
          "levelOrder": 1
        },
        {
          "levelCode": "Plot_123",
          "levelName": "plot",
          "levelOrder": 2
        }
      ],
      "positionCoordinateX": "74",
      "positionCoordinateXType": "GRID_COL",
      "positionCoordinateY": "03",
      "positionCoordinateYType": "GRID_ROW"
      }
   }';


# $mech->default_header("Content-Type" => "application/json");
# $mech->default_header('Authorization'=> 'Bearer ' . $access_token);
# $mech->put('http://localhost:3010/brapi/v2/observationunits/41299', Content => $data);
# $response = decode_json $mech->content;
# print STDERR Dumper $response;
# is_deeply($response, {'result' => '','metadata' => {'datafiles' => undef,'pagination' => {'totalPages' => 1,'pageSize' => 10,'totalCount' => 1,'currentPage' => 0},'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::ObservationUnits'},{'message' => 'Observation Units updated','messageType' => 'INFO'}]}} );

# $mech->get_ok('http://localhost:3010/brapi/v2/observationunits/41299?pageSize=1&page=0');
# $response = decode_json $mech->content;
# print STDERR Dumper $response;
# is_deeply($response, {'metadata' => {'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=1'},{'message' => 'Loading CXGN::BrAPI::v2::ObservationUnits','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'Observation Units search result constructed'}],'datafiles' => [],'pagination' => {'totalCount' => 1,'totalPages' => 1,'currentPage' => 0,'pageSize' => 1}},'result' => {'data' => [{'observations' => [],'trialDbId' => '','observationUnitPosition' => {'geoCoordinates' => '','positionCoordinateYType' => '','positionCoordinateX' => undef,'observationLevel' => {'levelOrder' => 2,'levelCode' => '','levelName' => 'plot'},'observationLevelRelationships' => [{'levelOrder' => 0,'levelCode' => '1','levelName' => 'replicate'},{'levelCode' => '2','levelName' => 'block','levelOrder' => 1},{'levelCode' => '201','levelOrder' => 2,'levelName' => 'plot'},{'levelOrder' => 4,'levelCode' => undef,'levelName' => 'plant'}],'entryType' => 'test','positionCoordinateY' => undef,'positionCoordinateXType' => ''},'observationUnitPUI' => '201','germplasmName' => 'BLANK','externalReferences' => [],'locationName' => 'test_location','observationUnitDbId' => '41299','additionalInfo' => {},'trialName' => undef,'germplasmDbId' => '40326','studyDbId' => '165','programDbId' => '134','treatments' => [{'factor' => 'No ManagementFactor','modality' => ''}],'observationUnitName' => 'CASS_6Genotypes_201','programName' => 'test','locationDbId' => '23','studyName' => 'CASS_6Genotypes_Sampling_2015'}]}});


$mech->post_ok('http://localhost:3010/brapi/v2/search/observationunits', ['pageSize'=>'2']);
$response = decode_json $mech->content;
$searchId = $response->{result} ->{searchResultDbId};
print STDERR Dumper $response;
$mech->get_ok('http://localhost:3010/brapi/v2/search/observationunits/'. $searchId);
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'result' => {'data' => [{'observationUnitName' => 'CASS_6Genotypes_103','germplasmName' => 'IITA-TMS-IBA980581','observationUnitDbId' => '41284','programDbId' => '134','observationUnitPosition' => {'observationLevel' => {'levelName' => 'plot','levelCode' => '103','levelOrder' => 2},'positionCoordinateY' => undef,'positionCoordinateYType' => 'GRID_ROW','observationLevelRelationships' => [{'levelOrder' => 0,'levelCode' => '1','levelName' => 'replicate'},{'levelName' => 'block','levelOrder' => 1,'levelCode' => '1'},{'levelOrder' => 2,'levelCode' => '103','levelName' => 'plot'},{'levelCode' => undef,'levelOrder' => 4,'levelName' => 'plant'}],'geoCoordinates' => '','positionCoordinateXType' => 'GRID_COL','positionCoordinateX' => undef,'entryType' => 'test'},'studyName' => 'CASS_6Genotypes_Sampling_2015','locationName' => 'test_location','studyDbId' => '165','externalReferences' => [],'programName' => 'test','trialDbId' => '','treatments' => [{'modality' => '','factor' => 'No ManagementFactor'}],'observationUnitPUI' => '103','trialName' => undef,'additionalInfo' => {},'locationDbId' => '23','observations' => [],'germplasmDbId' => '41283'},{'germplasmDbId' => '41282','observations' => [],'locationDbId' => '23','additionalInfo' => {},'programName' => 'test','trialDbId' => '','observationUnitPUI' => '104','treatments' => [{'factor' => 'No ManagementFactor','modality' => ''}],'trialName' => undef,'locationName' => 'test_location','studyName' => 'CASS_6Genotypes_Sampling_2015','studyDbId' => '165','externalReferences' => [],'programDbId' => '134','observationUnitPosition' => {'positionCoordinateXType' => 'GRID_COL','positionCoordinateX' => undef,'entryType' => 'test','positionCoordinateY' => undef,'observationLevel' => {'levelCode' => '104','levelOrder' => 2,'levelName' => 'plot'},'observationLevelRelationships' => [{'levelOrder' => 0,'levelCode' => '1','levelName' => 'replicate'},{'levelOrder' => 1,'levelCode' => '1','levelName' => 'block'},{'levelName' => 'plot','levelCode' => '104','levelOrder' => 2},{'levelName' => 'plant','levelOrder' => 4,'levelCode' => undef}],'positionCoordinateYType' => 'GRID_ROW','geoCoordinates' => ''},'observationUnitName' => 'CASS_6Genotypes_104','germplasmName' => 'IITA-TMS-IBA980002','observationUnitDbId' => '41295'}]},'metadata' => {'pagination' => {'totalCount' => 2,'currentPage' => 0,'pageSize' => 10,'totalPages' => 1},'status' => [{'message' => 'BrAPI base call found with page=0, pageSize=10','messageType' => 'INFO'},{'message' => 'Loading CXGN::BrAPI::v2::Results','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'search result constructed'}],'datafiles' => []}});

$mech->get_ok('http://localhost:3010/brapi/v2/observationunits/table');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'result' => {'headerRow' => ['studyYear','programDbId','programName','programDescription','studyDbId','studyName','studyDescription','studyDesign','plotWidth','plotLength','fieldSize','fieldTrialIsPlannedToBeGenotyped','fieldTrialIsPlannedToCross','plantingDate','harvestDate','locationDbId','locationName','germplasmDbId','germplasmName','germplasmSynonyms','observationLevel','observationUnitDbId','observationUnitName','replicate','blockNumber','plotNumber','rowNumber','colNumber','entryType','plantNumber','plantedSeedlotStockDbId','plantedSeedlotStockUniquename','plantedSeedlotCurrentCount','plantedSeedlotCurrentWeightGram','plantedSeedlotBoxName','plantedSeedlotTransactionCount','plantedSeedlotTransactionWeight','plantedSeedlotTransactionDescription','availableGermplasmSeedlotUniquenames'],'observationVariables' => [{'observationVariableDbId' => '77559','observationVariableName' => 'cass sink leaf|3-phosphoglyceric acid|ug/g|week 16|COMP:0000013'},{'observationVariableName' => 'cass sink leaf|ADP alpha-D-glucoside|ug/g|week 16|COMP:0000011','observationVariableDbId' => '77557'},{'observationVariableDbId' => '77556','observationVariableName' => 'cass sink leaf|ADP|ug/g|week 16|COMP:0000010'},{'observationVariableDbId' => '77548','observationVariableName' => 'cass source leaf|3-phosphoglyceric acid|ug/g|week 16|COMP:0000002'},{'observationVariableName' => 'cass source leaf|ADP alpha-D-glucoside|ug/g|week 16|COMP:0000007','observationVariableDbId' => '77553'},{'observationVariableDbId' => '77549','observationVariableName' => 'cass source leaf|ADP|ug/g|week 16|COMP:0000003'},{'observationVariableDbId' => '77552','observationVariableName' => 'cass storage root|3-phosphoglyceric acid|ug/g|week 16|COMP:0000006'},{'observationVariableDbId' => '77550','observationVariableName' => 'cass storage root|ADP alpha-D-glucoside|ug/g|week 16|COMP:0000004'},{'observationVariableName' => 'cass storage root|ADP|ug/g|week 16|COMP:0000005','observationVariableDbId' => '77551'},{'observationVariableName' => 'cass upper stem|3-phosphoglyceric acid|ug/g|week 16|COMP:0000012','observationVariableDbId' => '77558'},{'observationVariableDbId' => '77554','observationVariableName' => 'cass upper stem|ADP alpha-D-glucoside|ug/g|week 16|COMP:0000008'},{'observationVariableDbId' => '77555','observationVariableName' => 'cass upper stem|ADP|ug/g|week 16|COMP:0000009'},{'observationVariableName' => 'dry matter content percentage|CO_334:0000092','observationVariableDbId' => '70741'},{'observationVariableDbId' => '70666','observationVariableName' => 'fresh root weight|CO_334:0000012'},{'observationVariableName' => 'fresh shoot weight measurement in kg|CO_334:0000016','observationVariableDbId' => '70773'},{'observationVariableDbId' => '70668','observationVariableName' => 'harvest index variable|CO_334:0000015'}],'data' => [['2017',134,'test','test',165,'CASS_6Genotypes_Sampling_2015','Copy of trial with postcomposed phenotypes from cassbase.','RCBD',undef,undef,undef,undef,undef,undef,undef,'23','test_location',41283,'IITA-TMS-IBA980581','','plot',41284,'CASS_6Genotypes_103','1','1','103',undef,undef,'test',undef,undef,undef,undef,undef,undef,undef,undef,undef,'','601.518','39.84365','655.92','1259.08','17.38275','192.1495','67.9959','20.3038','102.0875','108.56995','28.83915','379.16',undef,undef,undef,undef,undef],['2017',134,'test','test',165,'CASS_6Genotypes_Sampling_2015','Copy of trial with postcomposed phenotypes from cassbase.','RCBD',undef,undef,undef,undef,undef,undef,undef,'23','test_location',41282,'IITA-TMS-IBA980002','','plot',41295,'CASS_6Genotypes_104','1','1','104',undef,undef,'test',undef,undef,undef,undef,undef,undef,undef,undef,undef,'','221.6135','36.12425','316.489','908.9045','29.6934','162.9475','23.09545','14.3795','85.9106','54.2099','13.8628','341.041',undef,undef,undef,undef,undef],['2017',134,'test','test',165,'CASS_6Genotypes_Sampling_2015','Copy of trial with postcomposed phenotypes from cassbase.','RCBD',undef,undef,undef,undef,undef,undef,undef,'23','test_location',41279,'IITA-TMS-IBA30572','','plot',41296,'CASS_6Genotypes_105','1','1','105',undef,undef,'test',undef,undef,undef,undef,undef,undef,undef,undef,undef,'','662.087','46.1458','559.441','1974.265','38.1064','484.765','33.1455','16.7238','98.71395','97.8179','35.4435','439.9695',undef,undef,undef,undef,undef],['2017',134,'test','test',165,'CASS_6Genotypes_Sampling_2015','Copy of trial with postcomposed phenotypes from cassbase.','RCBD',undef,undef,undef,undef,undef,undef,undef,'23','test_location',41281,'IITA-TMS-IBA011412','','plot',41297,'CASS_6Genotypes_106','1','1','106',undef,undef,'test',undef,undef,undef,undef,undef,undef,undef,undef,undef,'','612.37','23.788','604.5625','646.902','26.60415','192.46','39.6698','16.78125','107.74','78.72305','28.3805','469.818',undef,undef,undef,undef,undef],['2017',134,'test','test',165,'CASS_6Genotypes_Sampling_2015','Copy of trial with postcomposed phenotypes from cassbase.','RCBD',undef,undef,undef,undef,undef,undef,undef,'23','test_location',41280,'TMEB693','','plot',41298,'CASS_6Genotypes_107','1','1','107',undef,undef,'test',undef,undef,undef,undef,undef,undef,undef,undef,undef,'','198.089','47.64845','485.944','779.191','21.12875','147.0405','31.554','10.59626','46.41935','101.7506','30.86975','423.355',undef,undef,undef,undef,undef],['2017',134,'test','test',165,'CASS_6Genotypes_Sampling_2015','Copy of trial with postcomposed phenotypes from cassbase.','RCBD',undef,undef,undef,undef,undef,undef,undef,'23','test_location',40326,'BLANK','','plot',41299,'CASS_6Genotypes_201','1','2','201',undef,undef,'test',undef,undef,undef,undef,undef,undef,undef,undef,undef,'',undef,undef,undef,undef,undef,undef,undef,undef,undef,undef,undef,undef,undef,undef,undef,undef,undef],['2017',134,'test','test',165,'CASS_6Genotypes_Sampling_2015','Copy of trial with postcomposed phenotypes from cassbase.','RCBD',undef,undef,undef,undef,undef,undef,undef,'23','test_location',41280,'TMEB693','','plot',41300,'CASS_6Genotypes_202','1','2','202',undef,undef,'test',undef,undef,undef,undef,undef,undef,undef,undef,undef,'','250.228','39.2627','478.0445','1295.29','21.56485','169.757','26.2744','5.31292','39.4774','61.51325','36.2316','241.418',undef,undef,undef,undef,undef],['2017',134,'test','test',165,'CASS_6Genotypes_Sampling_2015','Copy of trial with postcomposed phenotypes from cassbase.','RCBD',undef,undef,undef,undef,undef,undef,undef,'23','test_location',41282,'IITA-TMS-IBA980002','','plot',41301,'CASS_6Genotypes_203','1','2','203',undef,undef,'test',undef,undef,undef,undef,undef,undef,undef,undef,undef,'','245.679','29.4029','299.096','1013.111','17.04795','202.893','40.306','7.442495','75.2132','57.47695','20.43645','303.3225',undef,undef,undef,undef,undef],['2017',134,'test','test',165,'CASS_6Genotypes_Sampling_2015','Copy of trial with postcomposed phenotypes from cassbase.','RCBD',undef,undef,undef,undef,undef,undef,undef,'23','test_location',41283,'IITA-TMS-IBA980581','','plot',41302,'CASS_6Genotypes_204','1','2','204',undef,undef,'test',undef,undef,undef,undef,undef,undef,undef,undef,undef,'','235.825','31.0018','491.9535','1302.695','22.82925','281.091','74.1941','15.9235','83.2802','154.109','31.2364','849.9465',undef,undef,undef,undef,undef],['2017',134,'test','test',165,'CASS_6Genotypes_Sampling_2015','Copy of trial with postcomposed phenotypes from cassbase.','RCBD',undef,undef,undef,undef,undef,undef,undef,'23','test_location',41281,'IITA-TMS-IBA011412','','plot',41285,'CASS_6Genotypes_205','1','2','205',undef,undef,'test',undef,undef,undef,undef,undef,undef,undef,undef,undef,'','415.062','61.2228','730.363','1757.615','23.07085','276.8625','49.3781','21.6087','86.7917','73.25295','17.81095','363.986',undef,undef,undef,undef,undef]]},'metadata' => {'datafiles' => [],'pagination' => {'totalPages' => 196,'pageSize' => 10,'totalCount' => 1955,'currentPage' => 0},'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::ObservationTables'},{'message' => 'Observation Units table result constructed','messageType' => 'INFO'}]}});

$mech->get_ok('http://localhost:3010/brapi/v2/observations?pageSize=2');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'result' => {'data' => [{'germplasmName' => 'IITA-TMS-IBA980581','value' => '601.518','germplasmDbId' => '41283','observationVariableName' => 'cass sink leaf|3-phosphoglyceric acid|ug/g|week 16|COMP:0000013','season' => [{'year' => '2017','seasonDbId' => '2017','season' => '2017'}],'observationUnitDbId' => '41284','observationTimeStamp' => undef,'uploadedBy' => undef,'externalReferences' => undef,'collector' => 'johndoe','studyDbId' => '165','additionalInfo' => undef,'observationVariableDbId' => '77559','observationDbId' => '740336','observationUnitName' => 'CASS_6Genotypes_103'},{'germplasmName' => 'IITA-TMS-IBA980581','observationVariableName' => 'cass sink leaf|ADP alpha-D-glucoside|ug/g|week 16|COMP:0000011','germplasmDbId' => '41283','value' => '39.84365','season' => [{'year' => '2017','seasonDbId' => '2017','season' => '2017'}],'observationUnitDbId' => '41284','observationTimeStamp' => undef,'uploadedBy' => undef,'externalReferences' => undef,'collector' => 'johndoe','studyDbId' => '165','additionalInfo' => undef,'observationVariableDbId' => '77557','observationDbId' => '740337','observationUnitName' => 'CASS_6Genotypes_103'}]},'metadata' => {'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=2'},{'message' => 'Loading CXGN::BrAPI::v2::Observations','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'Observations result constructed'}],'pagination' => {'currentPage' => 0,'totalPages' => 6,'pageSize' => 2,'totalCount' => 12},'datafiles' => []}});

$mech->get_ok('http://localhost:3010/brapi/v2/observations/740338');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response,  {'metadata' => {'datafiles' => [],'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::Observations'},{'messageType' => 'INFO','message' => 'Observations result constructed'}],'pagination' => {'totalCount' => 1,'totalPages' => 1,'currentPage' => 0,'pageSize' => 10}},'result' => {'data' => [{'externalReferences' => undef,'value' => '655.92','germplasmDbId' => '41283','season' => [{'seasonDbId' => 2017,'season' => 2017,'year' => '2017'}],'studyDbId' => '165','observationVariableName' => 'cass sink leaf|ADP|ug/g|week 16|COMP:0000010','observationVariableDbId' => '77556','observationUnitDbId' => '41284','germplasmName' => 'IITA-TMS-IBA980581','observationTimeStamp' => undef,'uploadedBy' => undef,'collector' => 'johndoe','observationUnitName' => 'CASS_6Genotypes_103','observationDbId' => '740338','additionalInfo' => undef}]}});

$mech->get_ok('http://localhost:3010/brapi/v2/observations/table?pageSize=2');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'result' => {'observationVariables' => [{'observationVariableDbId' => '77559','observationVariableName' => 'cass sink leaf|3-phosphoglyceric acid|ug/g|week 16|COMP:0000013'},{'observationVariableName' => 'cass sink leaf|ADP alpha-D-glucoside|ug/g|week 16|COMP:0000011','observationVariableDbId' => '77557'},{'observationVariableDbId' => '77556','observationVariableName' => 'cass sink leaf|ADP|ug/g|week 16|COMP:0000010'},{'observationVariableName' => 'cass source leaf|3-phosphoglyceric acid|ug/g|week 16|COMP:0000002','observationVariableDbId' => '77548'},{'observationVariableName' => 'cass source leaf|ADP alpha-D-glucoside|ug/g|week 16|COMP:0000007','observationVariableDbId' => '77553'},{'observationVariableDbId' => '77549','observationVariableName' => 'cass source leaf|ADP|ug/g|week 16|COMP:0000003'},{'observationVariableName' => 'cass storage root|3-phosphoglyceric acid|ug/g|week 16|COMP:0000006','observationVariableDbId' => '77552'},{'observationVariableDbId' => '77550','observationVariableName' => 'cass storage root|ADP alpha-D-glucoside|ug/g|week 16|COMP:0000004'},{'observationVariableDbId' => '77551','observationVariableName' => 'cass storage root|ADP|ug/g|week 16|COMP:0000005'},{'observationVariableDbId' => '77558','observationVariableName' => 'cass upper stem|3-phosphoglyceric acid|ug/g|week 16|COMP:0000012'},{'observationVariableDbId' => '77554','observationVariableName' => 'cass upper stem|ADP alpha-D-glucoside|ug/g|week 16|COMP:0000008'},{'observationVariableName' => 'cass upper stem|ADP|ug/g|week 16|COMP:0000009','observationVariableDbId' => '77555'},{'observationVariableName' => 'dry matter content percentage|CO_334:0000092','observationVariableDbId' => '70741'},{'observationVariableName' => 'fresh root weight|CO_334:0000012','observationVariableDbId' => '70666'},{'observationVariableDbId' => '70773','observationVariableName' => 'fresh shoot weight measurement in kg|CO_334:0000016'},{'observationVariableDbId' => '70668','observationVariableName' => 'harvest index variable|CO_334:0000015'}],'data' => [['2017',134,'test','test',165,'CASS_6Genotypes_Sampling_2015','Copy of trial with postcomposed phenotypes from cassbase.','RCBD',undef,undef,undef,undef,undef,undef,undef,'23','test_location',41283,'IITA-TMS-IBA980581','','plot',41284,'CASS_6Genotypes_103','1','1','103',undef,undef,'test',undef,undef,undef,undef,undef,undef,undef,undef,undef,'','601.518','39.84365','655.92','1259.08','17.38275','192.1495','67.9959','20.3038','102.0875','108.56995','28.83915','379.16',undef,undef,undef,undef,undef],['2017',134,'test','test',165,'CASS_6Genotypes_Sampling_2015','Copy of trial with postcomposed phenotypes from cassbase.','RCBD',undef,undef,undef,undef,undef,undef,undef,'23','test_location',41282,'IITA-TMS-IBA980002','','plot',41295,'CASS_6Genotypes_104','1','1','104',undef,undef,'test',undef,undef,undef,undef,undef,undef,undef,undef,undef,'','221.6135','36.12425','316.489','908.9045','29.6934','162.9475','23.09545','14.3795','85.9106','54.2099','13.8628','341.041',undef,undef,undef,undef,undef]],'headerRow' => ['studyYear','programDbId','programName','programDescription','studyDbId','studyName','studyDescription','studyDesign','plotWidth','plotLength','fieldSize','fieldTrialIsPlannedToBeGenotyped','fieldTrialIsPlannedToCross','plantingDate','harvestDate','locationDbId','locationName','germplasmDbId','germplasmName','germplasmSynonyms','observationLevel','observationUnitDbId','observationUnitName','replicate','blockNumber','plotNumber','rowNumber','colNumber','entryType','plantNumber','plantedSeedlotStockDbId','plantedSeedlotStockUniquename','plantedSeedlotCurrentCount','plantedSeedlotCurrentWeightGram','plantedSeedlotBoxName','plantedSeedlotTransactionCount','plantedSeedlotTransactionWeight','plantedSeedlotTransactionDescription','availableGermplasmSeedlotUniquenames']},'metadata' => {'pagination' => {'currentPage' => 0,'totalPages' => 978,'totalCount' => 1955,'pageSize' => 2},'status' => [{'message' => 'BrAPI base call found with page=0, pageSize=2','messageType' => 'INFO'},{'message' => 'Loading CXGN::BrAPI::v2::ObservationTables','messageType' => 'INFO'},{'message' => 'Observations table result constructed','messageType' => 'INFO'}],'datafiles' => []}});

$mech->post_ok('http://localhost:3010/brapi/v2/search/observations', ['pageSize'=>'2', 'observationDbIds' => ['740337']]);
$response = decode_json $mech->content;
$searchId = $response->{result} ->{searchResultDbId};
print STDERR Dumper $response;
$mech->get_ok('http://localhost:3010/brapi/v2/search/observations/'. $searchId);
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'metadata' => {'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::Results'},{'message' => 'search result constructed','messageType' => 'INFO'}],'pagination' => {'totalCount' => 1,'currentPage' => 0,'pageSize' => 10,'totalPages' => 1},'datafiles' => []},'result' => {'data' => [{'observationVariableName' => 'cass sink leaf|ADP alpha-D-glucoside|ug/g|week 16|COMP:0000011','germplasmDbId' => '41283','studyDbId' => '165','observationTimeStamp' => undef,'collector' => 'johndoe','value' => '39.84365','observationVariableDbId' => '77557','observationDbId' => '740337','observationUnitName' => 'CASS_6Genotypes_103','externalReferences' => undef,'observationUnitDbId' => '41284','season' => [{'seasonDbId' => '2017','season' => '2017','year' => '2017'}],'uploadedBy' => undef,'germplasmName' => 'IITA-TMS-IBA980581','additionalInfo' => undef}]}});

$mech->get_ok('http://localhost:3010/brapi/v2/variables?pageSize=2');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response,  {'metadata' => {'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=2'},{'message' => 'Loading CXGN::BrAPI::v2::ObservationVariables','messageType' => 'INFO'},{'message' => 'Observationvariable search result constructed','messageType' => 'INFO'}],'pagination' => {'totalCount' => 242,'pageSize' => 2,'totalPages' => 121,'currentPage' => 0},'datafiles' => []},'result' => {'data' => [{'synonyms' => ['abscon','AbsCt_Meas_ugg'],'observationVariableDbId' => '70692','additionalInfo' => {},'language' => 'eng','defaultValue' => '','scientist' => undef,'documentationURL' => '','institution' => undef,'observationVariableName' => 'abscisic acid content of leaf ug/g|CO_334:0000047','contextOfUse' => undef,'trait' => {'synonyms' => ['abscon','AbsCt_Meas_ugg'],'entity' => undef,'ontologyReference' => {'ontologyDbId' => 186,'ontologyName' => 'CO_334','documentationLinks' => undef,'version' => undef},'traitDbId' => '70692','externalReferences' => 'CO_334:0000047','status' => 'Active','additionalInfo' => {},'traitName' => 'abscisic acid content of leaf ug/g','traitDescription' => 'Abscisic acid content of leaf sample.','attribute' => 'abscisic acid content of leaf ug/g','traitClass' => undef,'alternativeAbbreviations' => undef,'mainAbbreviation' => undef},'status' => 'Active','externalReferences' => 'CO_334:0000047','ontologyReference' => {'documentationLinks' => undef,'ontologyDbId' => '186','ontologyName' => 'CO_334','version' => undef},'method' => {},'growthStage' => undef,'commonCropName' => 'Cassava','scale' => {'validValues' => {'categories' => [],'max' => undef,'min' => undef},'scaleDbId' => undef,'scaleName' => undef,'datatype' => '','decimalPlaces' => undef,'ontologyReference' => {},'additionalInfo' => {},'externalReferences' => ''},'submissionTimestamp' => undef},{'trait' => {'traitClass' => undef,'alternativeAbbreviations' => undef,'mainAbbreviation' => undef,'synonyms' => ['amylp','AmylPCt_Meas_pct'],'entity' => undef,'traitDbId' => '70761','additionalInfo' => {},'traitDescription' => 'Estimation of amylopectin content of cassava roots in percentage(%).','attribute' => 'amylopectin content ug/g in percentage','ontologyReference' => {'documentationLinks' => undef,'ontologyName' => 'CO_334','ontologyDbId' => 186,'version' => undef},'traitName' => 'amylopectin content ug/g in percentage','status' => 'Active','externalReferences' => 'CO_334:0000121'},'contextOfUse' => undef,'ontologyReference' => {'ontologyDbId' => '186','ontologyName' => 'CO_334','documentationLinks' => undef,'version' => undef},'externalReferences' => 'CO_334:0000121','status' => 'Active','growthStage' => undef,'method' => {},'scale' => {'externalReferences' => '','additionalInfo' => {},'ontologyReference' => {},'decimalPlaces' => undef,'scaleName' => undef,'scaleDbId' => undef,'validValues' => {'max' => undef,'min' => undef,'categories' => []},'datatype' => ''},'submissionTimestamp' => undef,'commonCropName' => 'Cassava','synonyms' => ['amylp','AmylPCt_Meas_pct'],'observationVariableDbId' => '70761','scientist' => undef,'defaultValue' => '','language' => 'eng','additionalInfo' => {},'institution' => undef,'documentationURL' => '','observationVariableName' => 'amylopectin content ug/g in percentage|CO_334:0000121'}]}});

$mech->get_ok('http://localhost:3010/brapi/v2/variables/70752');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'result' => {'status' => 'Active','method' => {},'scale' => {'scaleName' => undef,'datatype' => '','externalReferences' => '','scaleDbId' => undef,'ontologyReference' => {},'decimalPlaces' => undef,'validValues' => {'max' => undef,'min' => undef,'categories' => []}},'synonyms' => ['AmylR_Comp_r','amylrt'],'additionalInfo' => undef,'ontologyReference' => {'documentationLinks' => undef,'version' => undef,'ontologyName' => 'CO_334','ontologyDbId' => '186'},'growthStage' => undef,'trait' => {'entity' => undef,'traitClass' => undef,'externalReferences' => 'CO_334:0000124','traitDescription' => 'The amylose content of a cassava root sample divided by the amylopectin content of the same sample.','attribute' => 'amylose amylopectin root content ratio','traitDbId' => '70752','alternativeAbbreviations' => undef,'status' => 'Active','ontologyReference' => {'ontologyDbId' => 186,'ontologyName' => 'CO_334','version' => undef,'documentationLinks' => undef},'synonyms' => ['AmylR_Comp_r','amylrt'],'mainAbbreviation' => undef,'traitName' => 'amylose amylopectin root content ratio'},'observationVariableName' => 'amylose amylopectin root content ratio|CO_334:0000124','contextOfUse' => undef,'commonCropName' => 'Cassava','defaultValue' => '','submissionTimestamp' => undef,'documentationURL' => '','externalReferences' => 'CO_334:0000124','scientist' => undef,'observationVariableDbId' => '70752','institution' => undef,'language' => 'eng'},'metadata' => {'pagination' => {'currentPage' => 0,'pageSize' => 10,'totalCount' => 1,'totalPages' => 1},'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::ObservationVariables'},{'messageType' => 'INFO','message' => 'Observationvariable search result constructed'}],'datafiles' => []}});

$mech->post_ok('http://localhost:3010/brapi/v2/search/variables', ['pageSize'=>'1', 'observationVariableDbIds' => ['70761']]);
$response = decode_json $mech->content;
$searchId = $response->{result} ->{searchResultDbId};
print STDERR Dumper $response;
$mech->get_ok('http://localhost:3010/brapi/v2/search/variables/'. $searchId);
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'result' => {'data' => [{'institution' => undef,'language' => 'eng','observationVariableDbId' => '70761','documentationURL' => '','submissionTimestamp' => undef,'scientist' => undef,'externalReferences' => 'CO_334:0000121','observationVariableName' => 'amylopectin content ug/g in percentage|CO_334:0000121','trait' => {'attribute' => 'amylopectin content ug/g in percentage','traitDescription' => 'Estimation of amylopectin content of cassava roots in percentage(%).','traitDbId' => '70761','alternativeAbbreviations' => undef,'entity' => undef,'traitClass' => undef,'externalReferences' => 'CO_334:0000121','traitName' => 'amylopectin content ug/g in percentage','status' => 'Active','ontologyReference' => {'ontologyDbId' => 186,'version' => undef,'ontologyName' => 'CO_334','documentationLinks' => undef},'mainAbbreviation' => undef,'additionalInfo' => {},'synonyms' => ['amylp','AmylPCt_Meas_pct']},'growthStage' => undef,'commonCropName' => undef,'defaultValue' => '','contextOfUse' => undef,'synonyms' => ['amylp','AmylPCt_Meas_pct'],'additionalInfo' => {},'ontologyReference' => {'documentationLinks' => undef,'version' => undef,'ontologyName' => 'CO_334','ontologyDbId' => '186'},'method' => {},'status' => 'Active','scale' => {'externalReferences' => '','scaleDbId' => undef,'ontologyReference' => {},'datatype' => '','additionalInfo' => {},'scaleName' => undef,'validValues' => {'categories' => [],'max' => undef,'min' => undef},'decimalPlaces' => undef}}]},'metadata' => {'datafiles' => [],'pagination' => {'totalCount' => 1,'pageSize' => 10,'currentPage' => 0,'totalPages' => 1},'status' => [{'message' => 'BrAPI base call found with page=0, pageSize=10','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::Results'},{'message' => 'search result constructed','messageType' => 'INFO'}]}});

$mech->get_ok('http://localhost:3010/brapi/v2/traits?pageSize=2');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'result' => {'data' => [{'ontologyReference' => {'version' => undef,'ontologyName' => 'CHEBI','ontologyDbId' => 88,'documentationLinks' => undef},'traitName' => '1-pyrroline-2-carboxylic acid','traitDescription' => 'The product resulting from formal oxidation of DL-proline by loss of hydrogen from the nitrogen and from the carbon alpha to the carboxylic acid, with the formation of a C=N bond.','alternativeAbbreviations' => undef,'entity' => undef,'traitClass' => undef,'additionalInfo' => {},'status' => 'Active','mainAbbreviation' => undef,'attribute' => '1-pyrroline-2-carboxylic acid','externalReferences' => [],'synonyms' => ['1-Pyrroline-2-carboxylate','1-Pyrroline-2-carboxylic acid','delta1-Pyrroline 2-carboxylate','3,4-dihydro-2H-pyrrole-5-carboxylic acid','RHTAIKJZSXNELN-UHFFFAOYSA-N','InChI=1S/C5H7NO2/c7-5(8)4-2-1-3-6-4/h1-3H2,(H,7,8)','OC(=O)C1=NCCC1','C5H7NO2'],'traitDbId' => '77298'},{'traitClass' => undef,'entity' => undef,'traitName' => '2-oxoglutarate(1-)','traitDescription' => 'A dicarboxylic acid monoanion resulting from selective deprotonation of the 1-carboxy group of 2-oxoglutaric acid.','alternativeAbbreviations' => undef,'ontologyReference' => {'ontologyName' => 'CHEBI','ontologyDbId' => 88,'documentationLinks' => undef,'version' => undef},'externalReferences' => [],'synonyms' => ['2-ketoglutarate','4-carboxy-2-oxobutanoate','C5H5O5','OC(=O)CCC(=O)C([O-])=O','InChI=1S/C5H6O5/c6-3(5(9)10)1-2-4(7)8/h1-2H2,(H,7,8)(H,9,10)/p-1','KPGXRSRHYNQIFN-UHFFFAOYSA-M','2-ketoglutarate','4-carboxy-2-oxobutanoate','C5H5O5','OC(=O)CCC(=O)C([O-])=O','InChI=1S/C5H6O5/c6-3(5(9)10)1-2-4(7)8/h1-2H2,(H,7,8)(H,9,10)/p-1','KPGXRSRHYNQIFN-UHFFFAOYSA-M'],'traitDbId' => '77201','mainAbbreviation' => undef,'attribute' => '2-oxoglutarate(1-)','additionalInfo' => {},'status' => 'Active'}]},'metadata' => {'status' => [{'message' => 'BrAPI base call found with page=0, pageSize=2','messageType' => 'INFO'},{'message' => 'Loading CXGN::BrAPI::v2::Traits','messageType' => 'INFO'},{'message' => 'Traits list result constructed','messageType' => 'INFO'}],'pagination' => {'totalCount' => 696,'currentPage' => 0,'totalPages' => 348,'pageSize' => 2},'datafiles' => []}});
$mech->get_ok('http://localhost:3010/brapi/v2/traits/77216');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response,  {'result' => {'ontologyReference' => {'version' => undef,'ontologyName' => 'CHEBI','documentationLinks' => undef,'ontologyDbId' => 88},'alternativeAbbreviations' => undef,'traitDescription' => 'A monophosphoglyceric acid having the phospho group at the 3-position. It is an intermediate in metabolic pathways like glycolysis and calvin cycle.','traitName' => '3-phosphoglyceric acid','entity' => undef,'traitClass' => undef,'status' => 'Active','attribute' => '3-phosphoglyceric acid','mainAbbreviation' => undef,'traitDbId' => '77216','externalReferences' => [],'synonyms' => undef},'metadata' => {'datafiles' => [],'status' => [{'message' => 'BrAPI base call found with page=0, pageSize=10','messageType' => 'INFO'},{'message' => 'Loading CXGN::BrAPI::v2::Traits','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'Trait detail result constructed'}],'pagination' => {'totalPages' => 1,'currentPage' => 0,'totalCount' => 1,'pageSize' => 10}}});


# $mech->get_ok('http://localhost:3010/brapi/v2/ontologies?pageSize=10');
# $response = decode_json $mech->content;
# print STDERR Dumper $response;

##need add imageand retrieve items
# $mech->get_ok('http://localhost:3010/brapi/v2/images');
# $response = decode_json $mech->content;
# print STDERR Dumper $response;

$mech->get_ok('http://localhost:3010/brapi/v2/germplasm?pageSize=3');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'result' => {'data' => [{'subtaxa' => undef,'germplasmPUI' => '','species' => undef,'subtaxaAuthority' => undef,'biologicalStatusOfAccessionCode' => 0,'donors' => [{'germplasmPUI' => undef,'donorAccessionNumber' => undef,'donorInstituteCode' => undef}],'commonCropName' => undef,'speciesAuthority' => undef,'additionalInfo' => undef,'germplasmName' => 'BLANK','externalReferences' => [],'instituteCode' => '','taxonIds' => [],'storageTypes' => [],'defaultDisplayName' => 'BLANK','acquisitionDate' => '','biologicalStatusOfAccessionDescription' => undef,'documentationURL' => '','countryOfOriginCode' => '','seedSourceDescription' => '','pedigree' => 'NA/NA','synonyms' => [],'germplasmOrigin' => [],'collection' => undef,'instituteName' => '','accessionNumber' => '','germplasmPreprocessing' => undef,'seedSource' => '','genus' => undef,'germplasmDbId' => '40326','breedingMethodDbId' => undef},{'germplasmPUI' => '','subtaxa' => undef,'species' => 'Manihot esculenta','germplasmName' => 'IITA-TMS-IBA30572','additionalInfo' => undef,'externalReferences' => [],'biologicalStatusOfAccessionCode' => 0,'donors' => [{'germplasmPUI' => undef,'donorInstituteCode' => undef,'donorAccessionNumber' => undef}],'subtaxaAuthority' => undef,'speciesAuthority' => undef,'commonCropName' => undef,'countryOfOriginCode' => '','storageTypes' => [],'defaultDisplayName' => 'IITA-TMS-IBA30572','instituteCode' => '','taxonIds' => [],'documentationURL' => '','acquisitionDate' => '','biologicalStatusOfAccessionDescription' => undef,'seedSource' => '','genus' => 'Manihot','accessionNumber' => '','germplasmPreprocessing' => undef,'breedingMethodDbId' => undef,'germplasmDbId' => '41279','seedSourceDescription' => '','pedigree' => 'NA/NA','germplasmOrigin' => [],'synonyms' => [],'collection' => undef,'instituteName' => ''},{'species' => 'Manihot esculenta','germplasmPUI' => '','subtaxa' => undef,'externalReferences' => [],'germplasmName' => 'IITA-TMS-IBA011412','additionalInfo' => undef,'speciesAuthority' => undef,'commonCropName' => undef,'biologicalStatusOfAccessionCode' => 0,'donors' => [{'donorAccessionNumber' => undef,'donorInstituteCode' => undef,'germplasmPUI' => undef}],'subtaxaAuthority' => undef,'countryOfOriginCode' => '','documentationURL' => '','acquisitionDate' => '','biologicalStatusOfAccessionDescription' => undef,'defaultDisplayName' => 'IITA-TMS-IBA011412','storageTypes' => [],'instituteCode' => '','taxonIds' => [],'breedingMethodDbId' => undef,'germplasmDbId' => '41281','seedSource' => '','genus' => 'Manihot','accessionNumber' => '','germplasmPreprocessing' => undef,'synonyms' => [],'germplasmOrigin' => [],'collection' => undef,'instituteName' => '','seedSourceDescription' => '','pedigree' => 'NA/NA'}]},'metadata' => {'pagination' => {'totalPages' => 160,'totalCount' => 479,'pageSize' => 3,'currentPage' => 0},'status' => [{'message' => 'BrAPI base call found with page=0, pageSize=3','messageType' => 'INFO'},{'message' => 'Loading CXGN::BrAPI::v2::Germplasm','messageType' => 'INFO'},{'message' => 'Germplasm result constructed','messageType' => 'INFO'}],'datafiles' => []}});

$mech->get_ok('http://localhost:3010/brapi/v2/germplasm/41281');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'result' => {'biologicalStatusOfAccessionDescription' => undef,'acquisitionDate' => '','documentationURL' => '','instituteCode' => '','taxonIds' => [],'storageTypes' => [],'defaultDisplayName' => 'IITA-TMS-IBA011412','countryOfOriginCode' => '','instituteName' => '','collection' => undef,'germplasmOrigin' => [],'synonyms' => [],'pedigree' => 'NA/NA','seedSourceDescription' => '','germplasmDbId' => '41281','breedingMethodDbId' => undef,'germplasmPreprocessing' => undef,'accessionNumber' => '','genus' => 'Manihot','seedSource' => '','species' => 'Manihot esculenta','subtaxa' => undef,'germplasmPUI' => '','commonCropName' => undef,'speciesAuthority' => undef,'subtaxaAuthority' => undef,'donors' => [{'germplasmPUI' => undef,'donorInstituteCode' => undef,'donorAccessionNumber' => undef}],'biologicalStatusOfAccessionCode' => 0,'externalReferences' => [],'additionalInfo' => undef,'germplasmName' => 'IITA-TMS-IBA011412'},'metadata' => {'datafiles' => [],'status' => [{'message' => 'BrAPI base call found with page=0, pageSize=10','messageType' => 'INFO'},{'message' => 'Loading CXGN::BrAPI::v2::Germplasm','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'Germplasm detail result constructed'}],'pagination' => {'totalCount' => 1,'pageSize' => 10,'currentPage' => 0,'totalPages' => 1}}});

$mech->get_ok('http://localhost:3010/brapi/v2/germplasm/38843/progeny');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'metadata' => {'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::Germplasm'},{'message' => 'Germplasm progeny result constructed','messageType' => 'INFO'}],'pagination' => {'totalCount' => 15,'totalPages' => 2,'pageSize' => 10,'currentPage' => 0},'datafiles' => []},'result' => {'germplasmName' => 'test_accession4','progeny' => [{'parentType' => 'FEMALE','germplasmDbId' => '38846','germplasmName' => 'new_test_crossP001'},{'germplasmName' => 'new_test_crossP002','germplasmDbId' => '38847','parentType' => 'FEMALE'},{'parentType' => 'FEMALE','germplasmName' => 'new_test_crossP003','germplasmDbId' => '38848'},{'parentType' => 'FEMALE','germplasmName' => 'new_test_crossP004','germplasmDbId' => '38849'},{'parentType' => 'FEMALE','germplasmName' => 'new_test_crossP005','germplasmDbId' => '38850'},{'germplasmDbId' => '38851','germplasmName' => 'new_test_crossP006','parentType' => 'FEMALE'},{'germplasmName' => 'new_test_crossP007','germplasmDbId' => '38852','parentType' => 'FEMALE'},{'parentType' => 'FEMALE','germplasmName' => 'new_test_crossP008','germplasmDbId' => '38853'},{'parentType' => 'FEMALE','germplasmName' => 'new_test_crossP009','germplasmDbId' => '38854'},{'parentType' => 'FEMALE','germplasmName' => 'new_test_crossP010','germplasmDbId' => '38855'}],'germplasmDbId' => '38843'}});

$mech->get_ok('http://localhost:3010/brapi/v2/germplasm/41279/mcpd');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'metadata' => {'pagination' => {'totalCount' => 1,'totalPages' => 1,'currentPage' => 0,'pageSize' => 10},'datafiles' => [],'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'message' => 'Loading CXGN::BrAPI::v2::Germplasm','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'Germplasm detail result constructed'}]},'result' => {'storageTypeCodes' => [],'germplasmPUI' => '','collectingInfo' => {},'breedingInstitutes' => {'instituteCode' => '','instituteName' => ''},'safetyDuplicateInstitutes' => undef,'genus' => 'Manihot','species' => 'Manihot esculenta','subtaxonAuthority' => undef,'commonCropName' => undef,'remarks' => undef,'alternateIDs' => [41279],'donorInfo' => [],'speciesAuthority' => undef,'biologicalStatusOfAccessionCode' => 0,'instituteCode' => '','accessionNames' => ['IITA-TMS-IBA30572','IITA-TMS-IBA30572'],'mlsStatus' => undef,'accessionNumber' => '','acquisitionDate' => '','germplasmDbId' => '41279','subtaxon' => undef,'ancestralData' => 'NA/NA','countryOfOrigin' => ''}});

$mech->get_ok('http://localhost:3010/brapi/v2/germplasm/38876/pedigree');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'metadata' => {'pagination' => {'currentPage' => 0,'pageSize' => 1,'totalPages' => 1,'totalCount' => 1},'datafiles' => [],'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::Germplasm'},{'messageType' => 'INFO','message' => 'Germplasm pedigree result constructed'}]},'result' => {'germplasmName' => 'test5P004','germplasmDbId' => '38876','crossingProjectDbId' => undef,'familyCode' => '','pedigree' => 'test_accession4/test_accession5','parents' => [{'parentType' => 'FEMALE','germplasmName' => 'test_accession4','germplasmDbId' => '38843'},{'germplasmDbId' => '38844','germplasmName' => 'test_accession5','parentType' => 'MALE'}],'crossingYear' => '','siblings' => [{'germplasmName' => 'new_test_crossP001','germplasmDbId' => '38846'},{'germplasmDbId' => '38847','germplasmName' => 'new_test_crossP002'},{'germplasmDbId' => '38848','germplasmName' => 'new_test_crossP003'},{'germplasmName' => 'new_test_crossP004','germplasmDbId' => '38849'},{'germplasmDbId' => '38850','germplasmName' => 'new_test_crossP005'},{'germplasmName' => 'new_test_crossP006','germplasmDbId' => '38851'},{'germplasmDbId' => '38852','germplasmName' => 'new_test_crossP007'},{'germplasmName' => 'new_test_crossP008','germplasmDbId' => '38853'},{'germplasmDbId' => '38854','germplasmName' => 'new_test_crossP009'},{'germplasmName' => 'new_test_crossP010','germplasmDbId' => '38855'},{'germplasmDbId' => '38873','germplasmName' => 'test5P001'},{'germplasmDbId' => '38874','germplasmName' => 'test5P002'},{'germplasmDbId' => '38875','germplasmName' => 'test5P003'},{'germplasmName' => 'test5P005','germplasmDbId' => '38877'}]}});

$mech->post_ok('http://localhost:3010/brapi/v2/search/germplasm', ['germplasmDbIds' => ['40326']]);
$response = decode_json $mech->content;
$searchId = $response->{result} ->{searchResultDbId};
print STDERR Dumper $response;
$mech->get_ok('http://localhost:3010/brapi/v2/search/germplasm/'. $searchId);
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'metadata' => {'pagination' => {'totalPages' => 1,'currentPage' => 0,'totalCount' => 1,'pageSize' => 10},'status' => [{'message' => 'BrAPI base call found with page=0, pageSize=10','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::Results'},{'messageType' => 'INFO','message' => 'search result constructed'}],'datafiles' => []},'result' => {'data' => [{'germplasmName' => 'BLANK','externalReferences' => [],'storageTypes' => [],'genus' => undef,'acquisitionDate' => '','subtaxa' => undef,'subtaxaAuthority' => undef,'accessionNumber' => '','donors' => [{'donorAccessionNumber' => undef,'germplasmPUI' => undef,'donorInstituteCode' => undef}],'biologicalStatusOfAccessionDescription' => undef,'seedSource' => '','pedigree' => 'NA/NA','germplasmOrigin' => [],'countryOfOriginCode' => '','collection' => undef,'documentationURL' => '','breedingMethodDbId' => undef,'seedSourceDescription' => '','biologicalStatusOfAccessionCode' => 0,'instituteName' => '','germplasmPUI' => '','commonCropName' => undef,'germplasmDbId' => '40326','taxonIds' => [],'instituteCode' => '','additionalInfo' => undef,'speciesAuthority' => undef,'species' => undef,'germplasmPreprocessing' => undef,'defaultDisplayName' => 'BLANK','synonyms' => []}]}});

$mech->get_ok('http://localhost:3010/brapi/v2/crossingprojects/');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'metadata' => {'status' => [{'message' => 'BrAPI base call found with page=0, pageSize=10','messageType' => 'INFO'},{'message' => 'Loading CXGN::BrAPI::v2::Crossing','messageType' => 'INFO'},{'message' => 'Crossing projects result constructed','messageType' => 'INFO'}],'datafiles' => [],'pagination' => {'totalCount' => 6,'currentPage' => 0,'totalPages' => 1,'pageSize' => 10}},'result' => {'data' => [{'commonCropName' => undef,'externalReferences' => [],'additionalInfo' => {},'crossingProjectDescription' => 'CASS_6Genotypes_Sampling_2015','programDbId' => '134','programName' => 'test','crossingProjectDbId' => '165','crossingProjectName' => 'CASS_6Genotypes_Sampling_2015'},{'commonCropName' => undef,'externalReferences' => [],'crossingProjectDescription' => 'Kasese solgs trial','additionalInfo' => {},'programName' => 'test','programDbId' => '134','crossingProjectDbId' => '139','crossingProjectName' => 'Kasese solgs trial'},{'crossingProjectDbId' => '135','crossingProjectName' => 'new_test_cross','additionalInfo' => {},'crossingProjectDescription' => 'new_test_cross','externalReferences' => [],'programName' => 'test','programDbId' => '134','commonCropName' => undef},{'programName' => 'test','programDbId' => '134','externalReferences' => [],'additionalInfo' => {},'crossingProjectDescription' => 'test_t','commonCropName' => undef,'crossingProjectName' => 'test_t','crossingProjectDbId' => '144'},{'crossingProjectName' => 'test_trial','crossingProjectDbId' => '137','commonCropName' => undef,'programDbId' => '134','programName' => 'test','additionalInfo' => {},'crossingProjectDescription' => 'test_trial','externalReferences' => []},{'crossingProjectName' => 'trial2 NaCRRI','crossingProjectDbId' => '141','programDbId' => '134','programName' => 'test','externalReferences' => [],'additionalInfo' => {},'crossingProjectDescription' => 'trial2 NaCRRI','commonCropName' => undef}]}});

$mech->get_ok('http://localhost:3010/brapi/v2/crossingprojects/139');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'metadata' => {'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::Crossing'},{'message' => 'Crossing projects result constructed','messageType' => 'INFO'}],'pagination' => {'currentPage' => 0,'totalCount' => 1,'pageSize' => 10,'totalPages' => 1},'datafiles' => []},'result' => {'programName' => 'test','commonCropName' => undef,'crossingProjectName' => 'Kasese solgs trial','crossingProjectDescription' => 'Kasese solgs trial','programDbId' => '134','crossingProjectDbId' => '139','additionalInfo' => {},'externalReferences' => []}});

$mech->get_ok('http://localhost:3010/brapi/v2/seedlots');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'result' => {'data' => [{'additionalInfo' 
=> {},'lastUpdated' => undef,'programDbId' => '134','amount' => '1','germplasmDbId' => '38846','externalReferences' => [],'seedLotName' => 'new_test_crossP001_001','seedLotDbId' => '41305','sourceCollection' => undef,'createdDate' => undef,'storageLocation' => 'NA','units' => 'seeds','seedLotDescription' => '','crossDbId' => undef,'locationDbId' => '25'},{'seedLotDescription' => '','crossDbId' => undef,'locationDbId' => '25','externalReferences' => [],'sourceCollection' => undef,'seedLotDbId' => '41306','seedLotName' => 'new_test_crossP002_001','storageLocation' => 'NA','createdDate' => undef,'units' => 'seeds','programDbId' => '134','lastUpdated' => undef,'amount' => '1','germplasmDbId' => '38847','additionalInfo' => {}},{'programDbId' => '134','lastUpdated' => undef,'germplasmDbId' => '38848','amount' => '1','additionalInfo' => {},'seedLotDescription' => '','locationDbId' => '25','crossDbId' => undef,'seedLotDbId' => '41307','seedLotName' => 'new_test_crossP003_001','sourceCollection' => undef,'externalReferences' => [],'units' => 'seeds','storageLocation' => 'NA','createdDate' => undef},{'units' => 'seeds','createdDate' => undef,'storageLocation' => 'NA','sourceCollection' => undef,'seedLotDbId' => '41308','seedLotName' => 'new_test_crossP004_001','externalReferences' => [],'locationDbId' => '25','crossDbId' => undef,'seedLotDescription' => '','additionalInfo' => {},'germplasmDbId' => '38849','amount' => '1','lastUpdated' => undef,'programDbId' => '134'},{'sourceCollection' => undef,'seedLotName' => 'new_test_crossP005_001','seedLotDbId' => '41309','externalReferences' => [],'units' => 'seeds','storageLocation' => 'NA','createdDate' => undef,'seedLotDescription' => '','locationDbId' => '25','crossDbId' => undef,'additionalInfo' => {},'programDbId' => '134','lastUpdated' => undef,'germplasmDbId' => '38850','amount' => '1'},{'seedLotDescription' => '','crossDbId' => undef,'locationDbId' => '25','externalReferences' => [],'seedLotName' => 'new_test_crossP006_001','sourceCollection' => undef,'seedLotDbId' => '41310','storageLocation' => 'NA','createdDate' => undef,'units' => 'seeds','programDbId' => '134','lastUpdated' => undef,'amount' => '1','germplasmDbId' => '38851','additionalInfo' => {}},{'locationDbId' => '25','crossDbId' => undef,'seedLotDescription' => '','units' => 'seeds','createdDate' => undef,'storageLocation' => 'NA','seedLotName' => 'new_test_crossP007_001','seedLotDbId' => '41311','sourceCollection' => undef,'externalReferences' => [],'germplasmDbId' => '38852','amount' => '1','lastUpdated' => undef,'programDbId' => '134','additionalInfo' => {}},{'createdDate' => undef,'storageLocation' => 'NA','units' => 'seeds','externalReferences' => [],'sourceCollection' => undef,'seedLotName' => 'new_test_crossP008_001','seedLotDbId' => '41312','crossDbId' => undef,'locationDbId' => '25','seedLotDescription' => '','additionalInfo' => {},'amount' => '1','germplasmDbId' => '38853','lastUpdated' => undef,'programDbId' => '134'},{'additionalInfo' => {},'amount' => '1','germplasmDbId' => '38843','lastUpdated' => undef,'programDbId' => '134','createdDate' => undef,'storageLocation' => 'NA','units' => 'seeds','externalReferences' => [],'seedLotName' => 'test_accession4_001','sourceCollection' => undef,'seedLotDbId' => '41303','crossDbId' => undef,'locationDbId' => '25','seedLotDescription' => ''},{'seedLotDescription' => '','locationDbId' => '25','crossDbId' => undef,'seedLotName' => 'test_accession5_001','seedLotDbId' => '41304','sourceCollection' => undef,'externalReferences' => [],'units' => 'seeds','storageLocation' => 'NA','createdDate' => undef,'programDbId' => '134','lastUpdated' => undef,'germplasmDbId' => '38844','amount' => '1','additionalInfo' => {}}]},'metadata' => {'status' => [{'message' => 'BrAPI base call found with page=0, pageSize=10','messageType' => 'INFO'},{'message' => 'Loading CXGN::BrAPI::v2::SeedLots','messageType' => 'INFO'},{'message' => 'Seed lots result constructed','messageType' => 'INFO'}],'pagination' => {'totalCount' => 479,'pageSize' => 10,'currentPage' => 0,'totalPages' => 48},'datafiles' => []}});

$mech->get_ok('http://localhost:3010/brapi/v2/seedlots/transactions');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'metadata' => {'pagination' => {'totalPages' => 48,'totalCount' => 479,'pageSize' => 10,'currentPage' => 0},'datafiles' => [],'status' => [{'message' => 'BrAPI base call found with page=0, pageSize=10','messageType' => 'INFO'},{'message' => 'Loading CXGN::BrAPI::v2::SeedLots','messageType' => 'INFO'},{'message' => 'Transactions result constructed','messageType' => 'INFO'}]},'result' => {'data' => [{'toSeedLotDbId' => '41781','externalReferences' => [],'fromSeedLotDbId' => '41283','additionalInfo' => {},'transactionTimestamp' => '2017-09-18T11:44:50+0000','units' => 'seeds','transactionDescription' => 'Auto generated seedlot from accession. DbPatch 00085','amount' => '1','transactionDbId' => '41008'},{'amount' => '1','transactionDbId' => '41006','transactionDescription' => 'Auto generated seedlot from accession. DbPatch 00085','transactionTimestamp' => '2017-09-18T11:44:50+0000','additionalInfo' => {},'units' => 'seeds','fromSeedLotDbId' => '41282','toSeedLotDbId' => '41780','externalReferences' => []},{'amount' => '1','transactionDbId' => '41004','transactionDescription' => 'Auto generated seedlot from accession. DbPatch 00085','units' => 'seeds','additionalInfo' => {},'transactionTimestamp' => '2017-09-18T11:44:50+0000','fromSeedLotDbId' => '41281','externalReferences' => [],'toSeedLotDbId' => '41779'},{'transactionDescription' => 'Auto generated seedlot from accession. DbPatch 00085','transactionDbId' => '41002','amount' => '1','fromSeedLotDbId' => '41280','toSeedLotDbId' => '41778','externalReferences' => [],'transactionTimestamp' => '2017-09-18T11:44:50+0000','additionalInfo' => {},'units' => 'seeds'},{'transactionDescription' => 'Auto generated seedlot from accession. DbPatch 00085','transactionDbId' => '41000','amount' => '1','fromSeedLotDbId' => '41279','externalReferences' => [],'toSeedLotDbId' => '41777','units' => 'seeds','transactionTimestamp' => '2017-09-18T11:44:49+0000','additionalInfo' => {}},{'transactionDbId' => '40998','amount' => '1','transactionDescription' => 'Auto generated seedlot from accession. DbPatch 00085','additionalInfo' => {},'transactionTimestamp' => '2017-09-18T11:44:49+0000','units' => 'seeds','toSeedLotDbId' => '41776','externalReferences' => [],'fromSeedLotDbId' => '41278'},{'transactionDbId' => '40996','amount' => '1','transactionDescription' => 'Auto generated seedlot from accession. DbPatch 00085','units' => 'seeds','transactionTimestamp' => '2017-09-18T11:44:49+0000','additionalInfo' => {},'toSeedLotDbId' => '41775','externalReferences' => [],'fromSeedLotDbId' => '41258'},{'transactionTimestamp' => '2017-09-18T11:44:49+0000','additionalInfo' => {},'units' => 'seeds','fromSeedLotDbId' => '41257','toSeedLotDbId' => '41774','externalReferences' => [],'transactionDbId' => '40994','amount' => '1','transactionDescription' => 'Auto generated seedlot from accession. DbPatch 00085'},{'transactionDescription' => 'Auto generated seedlot from accession. DbPatch 00085','transactionDbId' => '40992','amount' => '1','toSeedLotDbId' => '41773','externalReferences' => [],'fromSeedLotDbId' => '41256','transactionTimestamp' => '2017-09-18T11:44:49+0000','additionalInfo' => {},'units' => 'seeds'},{'toSeedLotDbId' => '41772','externalReferences' => [],'fromSeedLotDbId' => '41255','units' => 'seeds','additionalInfo' => {},'transactionTimestamp' => '2017-09-18T11:44:49+0000','transactionDescription' => 'Auto generated seedlot from accession. DbPatch 00085','transactionDbId' => '40990','amount' => '1'}]}});

$mech->get_ok('http://localhost:3010/brapi/v2/seedlots/41310');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'metadata' => {'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::SeedLots'},{'message' => 'Seed lots result constructed','messageType' => 'INFO'}],'pagination' => {'pageSize' => 10,'totalCount' => 1,'currentPage' => 0,'totalPages' => 1},'datafiles' => []},'result' => {'sourceCollection' => undef,'externalReferences' => [],'additionalInfo' => {},'crossDbId' => '','amount' => 1,'createdDate' => undef,'storageLocation' => 'NA','units' => 'seeds','locationDbId' => '25','lastUpdated' => undef,'seedLotDbId' => '41310','seedLotDescription' => '','germplasmDbId' => '38851','programDbId' => '134','seedLotName' => 'new_test_crossP006_001'}});

$mech->get_ok('http://localhost:3010/brapi/v2/seedlots/41305/transactions');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'metadata' => {'datafiles' => [],'status' => [{'message' => 'BrAPI base call found with page=0, pageSize=10','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::SeedLots'},{'messageType' => 'INFO','message' => 'Transactions result constructed'}],'pagination' => {'currentPage' => 0,'totalPages' => 1,'totalCount' => 1,'pageSize' => 10}},'result' => {'data' => [{'externalReferences' => [],'additionalInfo' => {},'toSeedLotDbId' => '41305','fromSeedLotDbId' => '38846','units' => 'seeds','transactionDbId' => '40056','transactionDescription' => 'Auto generated seedlot from accession. DbPatch 00085','transactionTimestamp' => '2017-09-18T11:43:59+0000','amount' => '1'}]}});

$mech->get_ok('http://localhost:3010/brapi/v2/calls');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'metadata' => {'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'message' => 'Loading CXGN::BrAPI::v2::Calls','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'Calls result constructed'}],'datafiles' => [],'pagination' => {'totalPages' => 450,'totalCount' => 4500,'currentPage' => 0,'pageSize' => 10}},'result' => {'sepUnphased' => undef,'data' => [{'callSetDbId' => '38878','variantDbId' => 'S10114_185859','genotype' => {'values' => '0'},'additionalInfo' => undef,'variantName' => 'S10114_185859','callSetName' => 'UG120001','phaseSet' => undef,'genotype_likelihood' => undef},{'callSetName' => 'UG120001','variantDbId' => 'S10173_777651','genotype' => {'values' => '0'},'variantName' => 'S10173_777651','callSetDbId' => '38878','additionalInfo' => undef,'phaseSet' => undef,'genotype_likelihood' => undef},{'genotype' => {'values' => '2'},'variantDbId' => 'S10173_899514','callSetName' => 'UG120001','callSetDbId' => '38878','variantName' => 'S10173_899514','additionalInfo' => undef,'genotype_likelihood' => undef,'phaseSet' => undef},{'phaseSet' => undef,'genotype_likelihood' => undef,'additionalInfo' => undef,'variantName' => 'S10241_146006','callSetDbId' => '38878','callSetName' => 'UG120001','variantDbId' => 'S10241_146006','genotype' => {'values' => '0'}},{'variantName' => 'S1027_465354','callSetName' => 'UG120001','phaseSet' => undef,'genotype_likelihood' => undef,'callSetDbId' => '38878','genotype' => {'values' => '2'},'variantDbId' => 'S1027_465354','additionalInfo' => undef},{'additionalInfo' => undef,'phaseSet' => undef,'genotype_likelihood' => undef,'callSetName' => 'UG120001','genotype' => {'values' => '0'},'variantDbId' => 'S10367_21679','variantName' => 'S10367_21679','callSetDbId' => '38878'},{'additionalInfo' => undef,'variantDbId' => 'S1046_216535','genotype' => {'values' => '0'},'callSetDbId' => '38878','genotype_likelihood' => undef,'phaseSet' => undef,'callSetName' => 'UG120001','variantName' => 'S1046_216535'},{'variantName' => 'S10493_191533','callSetDbId' => '38878','callSetName' => 'UG120001','variantDbId' => 'S10493_191533','genotype' => {'values' => '1'},'phaseSet' => undef,'genotype_likelihood' => undef,'additionalInfo' => undef},{'additionalInfo' => undef,'genotype' => {'values' => '2'},'variantDbId' => 'S10493_282956','callSetDbId' => '38878','genotype_likelihood' => undef,'phaseSet' => undef,'callSetName' => 'UG120001','variantName' => 'S10493_282956'},{'genotype' => {'values' => '0'},'variantDbId' => 'S10493_529025','callSetDbId' => '38878','additionalInfo' => undef,'callSetName' => 'UG120001','variantName' => 'S10493_529025','phaseSet' => undef,'genotype_likelihood' => undef}],'sepPhased' => undef,'expandHomozygotes' => undef,'unknownString' => undef}});

$mech->post_ok('http://localhost:3010/brapi/v2/search/calls', ['callSetDbIds' => ['38878']]);
$response = decode_json $mech->content;
$searchId = $response->{result} ->{searchResultDbId};
print STDERR Dumper $response;
$mech->get_ok('http://localhost:3010/brapi/v2/search/calls/'. $searchId);
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'result' => {'data' => [{'genotype_likelihood' => undef,'variantDbId' => 'S10114_185859','additionalInfo' => undef,'callSetDbId' => '38878','phaseSet' => undef,'genotype' => {'values' => '0'},'callSetName' => 'UG120001','variantName' => 'S10114_185859'},{'variantDbId' => 'S10173_777651','genotype_likelihood' => undef,'variantName' => 'S10173_777651','callSetDbId' => '38878','phaseSet' => undef,'additionalInfo' => undef,'callSetName' => 'UG120001','genotype' => {'values' => '0'}},{'variantName' => 'S10173_899514','variantDbId' => 'S10173_899514','genotype_likelihood' => undef,'callSetName' => 'UG120001','genotype' => {'values' => '2'},'callSetDbId' => '38878','phaseSet' => undef,'additionalInfo' => undef},{'variantName' => 'S10241_146006','genotype_likelihood' => undef,'variantDbId' => 'S10241_146006','genotype' => {'values' => '0'},'callSetName' => 'UG120001','additionalInfo' => undef,'phaseSet' => undef,'callSetDbId' => '38878'},{'variantDbId' => 'S1027_465354','genotype_likelihood' => undef,'phaseSet' => undef,'callSetDbId' => '38878','additionalInfo' => undef,'callSetName' => 'UG120001','genotype' => {'values' => '2'},'variantName' => 'S1027_465354'},{'callSetDbId' => '38878','phaseSet' => undef,'additionalInfo' => undef,'callSetName' => 'UG120001','genotype' => {'values' => '0'},'variantDbId' => 'S10367_21679','genotype_likelihood' => undef,'variantName' => 'S10367_21679'},{'genotype' => {'values' => '0'},'callSetName' => 'UG120001','additionalInfo' => undef,'callSetDbId' => '38878','phaseSet' => undef,'variantName' => 'S1046_216535','genotype_likelihood' => undef,'variantDbId' => 'S1046_216535'},{'genotype' => {'values' => '1'},'callSetName' => 'UG120001','additionalInfo' => undef,'phaseSet' => undef,'callSetDbId' => '38878','variantName' => 'S10493_191533','genotype_likelihood' => undef,'variantDbId' => 'S10493_191533'},{'genotype_likelihood' => undef,'variantDbId' => 'S10493_282956','variantName' => 'S10493_282956','additionalInfo' => undef,'callSetDbId' => '38878','phaseSet' => undef,'genotype' => {'values' => '2'},'callSetName' => 'UG120001'},{'variantName' => 'S10493_529025','variantDbId' => 'S10493_529025','genotype_likelihood' => undef,'callSetName' => 'UG120001','genotype' => {'values' => '0'},'callSetDbId' => '38878','phaseSet' => undef,'additionalInfo' => undef}]},'metadata' => {'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'message' => 'Loading CXGN::BrAPI::v2::Results','messageType' => 'INFO'},{'message' => 'search result constructed','messageType' => 'INFO'}],'pagination' => {'currentPage' => 0,'totalPages' => 1,'pageSize' => 10,'totalCount' => 10},'datafiles' => []}});

$mech->get_ok('http://localhost:3010/brapi/v2/callsets/?callSetDbId=38879');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'result' => {'data' => [{'studyDbId' => ['140','142'],'variantSetDbIds' => ['140p1','142p1'],'sampleDbId' => '38879','additionalInfo' => {'germplasmDbId' => '38879'},'created' => undef,'updated' => undef,'callSetName' => 'UG120002','callSetDbId' => '38879'}]},'metadata' => {'pagination' => {'totalPages' => 1,'pageSize' => 10,'totalCount' => 1,'currentPage' => 0},'datafiles' => [],'status' => [{'message' => 'BrAPI base call found with page=0, pageSize=10','messageType' => 'INFO'},{'message' => 'Loading CXGN::BrAPI::v2::CallSets','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'CallSets result constructed'}]}});

$mech->get_ok('http://localhost:3010/brapi/v2/callsets/38880');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'metadata' => {'pagination' => {'totalPages' => 1,'pageSize' => 10,'totalCount' => 1,'currentPage' => 0},'datafiles' => [],'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'message' => 'Loading CXGN::BrAPI::v2::CallSets','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'CallSets detail result constructed'}]},'result' => {'created' => undef,'sampleDbId' => '38880','callSetName' => 'UG120003','studyDbId' => ['140','142'],'variantSetDbIds' => ['140p1','142p1'],'callSetDbId' => '38880','updated' => undef,'additionalInfo' => {'germplasmDbId' => '38880'}}});

$mech->get_ok('http://localhost:3010/brapi/v2/callsets/38882/calls');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'result' => {'unknownString' => undef,'sepUnphased' => undef,'expandHomozygotes' => undef,'data' => [{'variantDbId' => 'S10114_185859','phaseSet' => undef,'callSetName' => 'UG120005','variantName' => 'S10114_185859','callSetDbId' => '38882','genotype_likelihood' => undef,'genotype' => {'values' => '1'},'additionalInfo' => undef},{'callSetName' => 'UG120005','phaseSet' => undef,'variantDbId' => 'S10173_777651','callSetDbId' => '38882','variantName' => 'S10173_777651','genotype_likelihood' => undef,'additionalInfo' => undef,'genotype' => {'values' => '0'}},{'callSetName' => 'UG120005','variantDbId' => 'S10173_899514','phaseSet' => undef,'callSetDbId' => '38882','variantName' => 'S10173_899514','genotype_likelihood' => undef,'additionalInfo' => undef,'genotype' => {'values' => '0'}},{'genotype_likelihood' => undef,'additionalInfo' => undef,'genotype' => {'values' => '0'},'callSetName' => 'UG120005','phaseSet' => undef,'variantDbId' => 'S10241_146006','callSetDbId' => '38882','variantName' => 'S10241_146006'},{'genotype_likelihood' => undef,'additionalInfo' => undef,'genotype' => {'values' => '2'},'callSetName' => 'UG120005','phaseSet' => undef,'variantDbId' => 'S1027_465354','callSetDbId' => '38882','variantName' => 'S1027_465354'},{'callSetName' => 'UG120005','phaseSet' => undef,'variantDbId' => 'S10367_21679','callSetDbId' => '38882','variantName' => 'S10367_21679','genotype_likelihood' => undef,'additionalInfo' => undef,'genotype' => {'values' => '0'}},{'genotype_likelihood' => undef,'genotype' => {'values' => '0'},'additionalInfo' => undef,'phaseSet' => undef,'variantDbId' => 'S1046_216535','callSetName' => 'UG120005','variantName' => 'S1046_216535','callSetDbId' => '38882'},{'callSetDbId' => '38882','variantName' => 'S10493_191533','callSetName' => 'UG120005','phaseSet' => undef,'variantDbId' => 'S10493_191533','additionalInfo' => undef,'genotype' => {'values' => '2'},'genotype_likelihood' => undef},{'genotype_likelihood' => undef,'genotype' => {'values' => '2'},'additionalInfo' => undef,'variantDbId' => 'S10493_282956','phaseSet' => undef,'callSetName' => 'UG120005','variantName' => 'S10493_282956','callSetDbId' => '38882'},{'genotype_likelihood' => undef,'additionalInfo' => undef,'genotype' => {'values' => '1'},'callSetName' => 'UG120005','phaseSet' => undef,'variantDbId' => 'S10493_529025','callSetDbId' => '38882','variantName' => 'S10493_529025'}],'sepPhased' => undef},'metadata' => {'datafiles' => [],'pagination' => {'pageSize' => 10,'totalPages' => 100,'currentPage' => 0,'totalCount' => 1000},'status' => [{'message' => 'BrAPI base call found with page=0, pageSize=10','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::CallSets'},{'messageType' => 'INFO','message' => 'Markerprofiles allelematrix result constructed'}]}});

$mech->post_ok('http://localhost:3010/brapi/v2/search/callsets', ['callSetDbIds' => ['38881']]);
$response = decode_json $mech->content;
$searchId = $response->{result} ->{searchResultDbId};
print STDERR Dumper $response;
$mech->get_ok('http://localhost:3010/brapi/v2/search/callsets/'. $searchId);
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'result' => {'data' => [{'additionalInfo' => {'germplasmDbId' => '38881'},'variantSetDbIds' => ['140p1','142p1'],'sampleDbId' => '38881','studyDbId' => ['140','142'],'callSetDbId' => '38881','updated' => undef,'callSetName' => 'UG120004','created' => undef}]},'metadata' => {'pagination' => {'totalPages' => 1,'pageSize' => 10,'currentPage' => 0,'totalCount' => 1},'datafiles' => [],'status' => [{'message' => 'BrAPI base call found with page=0, pageSize=10','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::Results'},{'messageType' => 'INFO','message' => 'search result constructed'}]}});

$mech->get_ok('http://localhost:3010/brapi/v2/variantsets/?studyDbId=140');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response,  {'result' => {'data' => [{'variantSetName' => 'test_genotyping_project - GBS ApeKI genotyping v4','callSetCount' => 9,'additionalInfo' => {},'variantCount' => 500,'referenceSetDbId' => '1','variantSetDbId' => '140p1','availableFormats' => [{'fileFormat' => 'json','dataFormat' => 'json','fileURL' => undef}],'studyDbId' => '140','analysis' => [{'type' => undef,'updated' => undef,'description' => undef,'analysisDbId' => '1','created' => undef,'software' => undef,'analysisName' => 'GBS ApeKI genotyping v4'}]}]},'metadata' => {'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'message' => 'Loading CXGN::BrAPI::v2::VariantSets','messageType' => 'INFO'},{'message' => 'VariantSets result constructed','messageType' => 'INFO'}],'pagination' => {'totalCount' => 1,'totalPages' => 1,'currentPage' => 0,'pageSize' => 10},'datafiles' => []}});

$mech->get_ok('http://localhost:3010/brapi/v2/variantsets/142p1');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'metadata' => {'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'message' => 'Loading CXGN::BrAPI::v2::VariantSets','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'VariantSets result constructed'}],'pagination' => {'totalCount' => 1,'totalPages' => 1,'currentPage' => 0,'pageSize' => 10},'datafiles' => []},'result' => {'studyDbId' => '142','variantCount' => 500,'referenceSetDbId' => '1','variantSetDbId' => '142p1','variantSetName' => 'test_population2 - GBS ApeKI genotyping v4','availableFormats' => [{'dataFormat' => 'json','fileFormat' => 'json','fileURL' => undef}],'analysis' => [{'description' => undef,'type' => undef,'analysisDbId' => '1','analysisName' => 'GBS ApeKI genotyping v4','created' => undef,'updated' => undef,'software' => undef}],'callSetCount' => 280,'additionalInfo' => {}}});

$mech->get_ok('http://localhost:3010/brapi/v2/variantsets/142p1/calls');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'metadata' => {'status' => [{'message' => 'BrAPI base call found with page=0, pageSize=10','messageType' => 'INFO'},{'message' => 'Loading CXGN::BrAPI::v2::VariantSets','messageType' => 'INFO'},{'message' => 'VariantSets result constructed','messageType' => 'INFO'}],'pagination' => {'totalPages' => 14000,'totalCount' => 140000,'pageSize' => 10,'currentPage' => 0},'datafiles' => []},'result' => {'unknownString' => undef,'expandHomozygotes' => undef,'sepUnphased' => undef,'data' => [{'phaseSet' => undef,'variantName' => 'S10114_185859','additionalInfo' => {},'callSetDbId' => '38878','variantDbId' => 'S10114_185859','genotype' => {'values' => '0'},'callSetName' => 'UG120001','genotype_likelihood' => undef},{'genotype_likelihood' => undef,'callSetDbId' => '38878','additionalInfo' => {},'variantName' => 'S10173_777651','genotype' => {'values' => '0'},'callSetName' => 'UG120001','variantDbId' => 'S10173_777651','phaseSet' => undef},{'phaseSet' => undef,'callSetName' => 'UG120001','genotype' => {'values' => '2'},'variantDbId' => 'S10173_899514','callSetDbId' => '38878','additionalInfo' => {},'variantName' => 'S10173_899514','genotype_likelihood' => undef},{'genotype' => {'values' => '0'},'callSetName' => 'UG120001','variantDbId' => 'S10241_146006','additionalInfo' => {},'callSetDbId' => '38878','variantName' => 'S10241_146006','phaseSet' => undef,'genotype_likelihood' => undef},{'phaseSet' => undef,'genotype_likelihood' => undef,'callSetName' => 'UG120001','genotype' => {'values' => '2'},'variantDbId' => 'S1027_465354','callSetDbId' => '38878','additionalInfo' => {},'variantName' => 'S1027_465354'},{'genotype_likelihood' => undef,'variantName' => 'S10367_21679','additionalInfo' => {},'callSetDbId' => '38878','variantDbId' => 'S10367_21679','callSetName' => 'UG120001','genotype' => {'values' => '0'},'phaseSet' => undef},{'phaseSet' => undef,'callSetName' => 'UG120001','genotype' => {'values' => '0'},'variantDbId' => 'S1046_216535','additionalInfo' => {},'callSetDbId' => '38878','variantName' => 'S1046_216535','genotype_likelihood' => undef},{'genotype' => {'values' => '1'},'callSetName' => 'UG120001','variantDbId' => 'S10493_191533','additionalInfo' => {},'callSetDbId' => '38878','variantName' => 'S10493_191533','phaseSet' => undef,'genotype_likelihood' => undef},{'phaseSet' => undef,'genotype_likelihood' => undef,'variantName' => 'S10493_282956','additionalInfo' => {},'callSetDbId' => '38878','variantDbId' => 'S10493_282956','callSetName' => 'UG120001','genotype' => {'values' => '2'}},{'phaseSet' => undef,'variantDbId' => 'S10493_529025','callSetName' => 'UG120001','genotype' => {'values' => '0'},'variantName' => 'S10493_529025','callSetDbId' => '38878','additionalInfo' => {},'genotype_likelihood' => undef}],'sepPhased' => undef}});

$mech->get_ok('http://localhost:3010/brapi/v2/variantsets/140p1/callsets');
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'metadata' => {'datafiles' => [],'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::VariantSets'},{'message' => 'VariantSets result constructed','messageType' => 'INFO'}],'pagination' => {'currentPage' => 0,'pageSize' => 10,'totalPages' => 24,'totalCount' => 235}},'result' => {'data' => [{'additionalInfo' => {},'callSetDbId' => '38878','callSetName' => 'UG120001','created' => undef,'sampleDbId' => '38878','updated' => undef,'studyDbId' => '140','variantSetDbIds' => ['140p1']},{'callSetName' => 'UG120002','callSetDbId' => '38879','additionalInfo' => {},'sampleDbId' => '38879','created' => undef,'studyDbId' => '140','updated' => undef,'variantSetDbIds' => ['140p1']},{'updated' => undef,'studyDbId' => '140','variantSetDbIds' => ['140p1'],'callSetName' => 'UG120003','additionalInfo' => {},'callSetDbId' => '38880','sampleDbId' => '38880','created' => undef},{'updated' => undef,'studyDbId' => '140','variantSetDbIds' => ['140p1'],'callSetName' => 'UG120004','callSetDbId' => '38881','additionalInfo' => {},'sampleDbId' => '38881','created' => undef},{'studyDbId' => '140','updated' => undef,'variantSetDbIds' => ['140p1'],'additionalInfo' => {},'callSetDbId' => '38882','callSetName' => 'UG120005','created' => undef,'sampleDbId' => '38882'},{'studyDbId' => '140','updated' => undef,'variantSetDbIds' => ['140p1'],'additionalInfo' => {},'callSetDbId' => '38883','callSetName' => 'UG120006','sampleDbId' => '38883','created' => undef},{'callSetName' => 'UG120007','additionalInfo' => {},'callSetDbId' => '38884','created' => undef,'sampleDbId' => '38884','updated' => undef,'studyDbId' => '140','variantSetDbIds' => ['140p1']},{'created' => undef,'sampleDbId' => '38885','callSetDbId' => '38885','additionalInfo' => {},'callSetName' => 'UG120008','variantSetDbIds' => ['140p1'],'studyDbId' => '140','updated' => undef},{'studyDbId' => '140','updated' => undef,'variantSetDbIds' => ['140p1'],'callSetDbId' => '38886','additionalInfo' => {},'callSetName' => 'UG120009','sampleDbId' => '38886','created' => undef},{'variantSetDbIds' => ['140p1'],'updated' => undef,'studyDbId' => '140','sampleDbId' => '38887','created' => undef,'callSetDbId' => '38887','additionalInfo' => {},'callSetName' => 'UG120010'}]}} );

# $mech->get_ok('http://localhost:3010/brapi/v2/variantsets/140p1/variants');
# $response = decode_json $mech->content;
# print STDERR Dumper $response;
# is_deeply($response, 

$mech->post_ok('http://localhost:3010/brapi/v2/search/variantsets', ['variantSetDbIds' => ['143p1']]);
$response = decode_json $mech->content;
$searchId = $response->{result} ->{searchResultDbId};
$mech->get_ok('http://localhost:3010/brapi/v2/search/variantsets/'. $searchId);
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'result' => {'data' => [{'availableFormats' => [{'dataFormat' => 'json','fileFormat' => 'json','fileURL' => undef}],'variantSetName' => 'selection_population - GBS ApeKI genotyping v4','analysis' => [{'analysisDbId' => '1','updated' => undef,'description' => undef,'created' => undef,'software' => undef,'type' => undef,'analysisName' => 'GBS ApeKI genotyping v4'}],'additionalInfo' => {},'callSetCount' => 9,'studyDbId' => '143','referenceSetDbId' => '1','variantCount' => 500,'variantSetDbId' => '143p1'}]},'metadata' => {'status' => [{'message' => 'BrAPI base call found with page=0, pageSize=10','messageType' => 'INFO'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::Results'},{'messageType' => 'INFO','message' => 'search result constructed'}],'pagination' => {'totalPages' => 1,'totalCount' => 1,'pageSize' => 10,'currentPage' => 0},'datafiles' => []}});

$mech->post_ok('http://localhost:3010/brapi/v2/variantsets/extract', ['variantSetDbIds' => ['142p1']]);
$response = decode_json $mech->content;
print STDERR Dumper $response;
is_deeply($response, {'result' => {'data' => [{'callSetCount' => 280,'variantSetDbId' => '142p1','variantCount' => 500,'studyDbId' => '142','referenceSetDbId' => '1','variantSetName' => 'test_population2 - GBS ApeKI genotyping v4','availableFormats' => [{'fileURL' => undef,'fileFormat' => 'json','dataFormat' => 'json'}],'additionalInfo' => {},'analysis' => [{'software' => undef,'description' => undef,'created' => undef,'analysisName' => 'GBS ApeKI genotyping v4','type' => undef,'analysisDbId' => '1','updated' => undef}]}]},'metadata' => {'datafiles' => [],'pagination' => {'totalCount' => 1,'totalPages' => 1,'pageSize' => 10,'currentPage' => 0},'status' => [{'messageType' => 'INFO','message' => 'BrAPI base call found with page=0, pageSize=10'},{'messageType' => 'INFO','message' => 'Loading CXGN::BrAPI::v2::VariantSets'},{'messageType' => 'INFO','message' => 'VariantSets result constructed'}]}});


done_testing();
